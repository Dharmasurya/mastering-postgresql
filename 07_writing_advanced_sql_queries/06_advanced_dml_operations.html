
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced DML Operations &#8212; Mastering SQL using Postgresql</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/pdf.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Merging or Upserting Data" href="07_merging_or_upserting_data.html" />
    <link rel="prev" title="CTAS - Create Table as Select" href="05_create_table_as_select.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">Mastering SQL using Postgresql</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../mastering-sql-using-postgresql.html">
   Mastering SQL using Postgresql
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../mastering_postgresql_exercises.html">
   Exercises - Mastering Postgresql
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../01_getting_started/01_getting_started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02_dml_or_crud_operations/01_dml_or_crud_operations.html">
   DML or CRUD Operations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../03_writing_basic_sql_queries/01_writing_basic_sql_queries.html">
   Writing Basic SQL Queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../04_creating_tables_and_indexes/01_creating_tables_and_indexes.html">
   Creating Tables and Indexes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../05_partitioning_tables_and_indexes/01_partitioning_tables_and_indexes.html">
   Partitioning Tables and Indexes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../06_predefined_functions/01_predefined_functions.html">
   Pre-Defined Functions
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="reference internal" href="01_writing_advanced_sql_queries.html">
   Writing Advanced SQL Queries
  </a>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="02_overview_of_views.html">
     Overview of Views
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_named_queries_using_with_clause.html">
     Named Queries - Using WITH Clause
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="04_overview_of_sub_queries.html">
     Overview of Sub Queries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="05_create_table_as_select.html">
     CTAS - Create Table as Select
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Advanced DML Operations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="07_merging_or_upserting_data.html">
     Merging or Upserting Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="08_pivoting_rows_into_columns.html">
     Pivoting Rows into Columns
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="09_overview_of_analytic_functions.html">
     Overview of Analytic Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="10_analytic_functions_aggregations.html">
     Analytic Functions – Aggregations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="11_cumulative_or_moving_aggregations.html">
     Cumulative or Moving Aggregations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="12_analytic_functions_windowing.html">
     Analytic Functions – Windowing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="13_analytic_functions_ranking.html">
     Analytic Functions – Ranking
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="14_analytic_funcions_filtering.html">
     Analytic Functions - Filtering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="15_ranking_and_filtering_recap.html">
     Ranking and Filtering - Recap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="16_exercises_analytic_functions.html">
     Exercises - Analytics Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../08_query_performance_tuning/01_query_performance_tuning.html">
   Query Performance Tuning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mastering_postgresql_exercises.html">
   Exercises - Mastering Postgresql
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Subscribe to our <a href="http://notifyme.itversity.com">Newsletter</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/07_writing_advanced_sql_queries/06_advanced_dml_operations.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/itversity/mastering-postgresql"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/itversity/mastering-postgresql/issues/new?title=Issue%20on%20page%20%2F07_writing_advanced_sql_queries/06_advanced_dml_operations.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/itversity/mastering-postgresql/edit/master/07_writing_advanced_sql_queries/06_advanced_dml_operations.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/itversity/mastering-postgresql/master?urlpath=tree/07_writing_advanced_sql_queries/06_advanced_dml_operations.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="advanced-dml-operations">
<h1>Advanced DML Operations<a class="headerlink" href="#advanced-dml-operations" title="Permalink to this headline">¶</a></h1>
<p>As we gain enough knowledge related to writing queries, let us explore some advanced DML Operations.</p>
<ul class="simple">
<li><p>We can insert query results into a table using <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> with <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>.</p></li>
<li><p>As long as columns specified for table in <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> statement and columns projected in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause match, it works.</p></li>
<li><p>We can also use query results for <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> as well as <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creating customer order metrics table to demonstrate advanced DML Operations. We will also add primary key to this table. We will be storing number of orders placed and revenue generated for each customer in a given month.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS customer_order_metrics_mthly
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE customer_order_metrics_mthly (
    customer_id INT,
    order_month CHAR(7),
    order_count INT,
    order_revenue FLOAT
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE customer_order_metrics_mthly
    ADD PRIMARY KEY (order_month, customer_id)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is the query to get monthly customer orders metrics. First we will be inserting customer_id, order_month and order_count into the table.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the below query is run multiple times, every time data in both orders and order_items need to be processed. As the data volumes grow the query uses considerable amount of resources. It will be better if we can pre-aggregate the data.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_customer_id,
    to_char(o.order_date, &#39;yyyy-MM&#39;) AS order_month,
    count(1) AS order_count,
    round(sum(order_item_subtotal)::numeric, 2) AS order_revenue
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
GROUP BY o.order_customer_id,
    to_char(o.order_date, &#39;yyyy-MM&#39;)
ORDER BY order_month,
    order_count DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_customer_id</th>
        <th>order_month</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>4257</td>
        <td>2013-07</td>
        <td>10</td>
        <td>2059.75</td>
    </tr>
    <tr>
        <td>5293</td>
        <td>2013-07</td>
        <td>10</td>
        <td>2781.73</td>
    </tr>
    <tr>
        <td>9103</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1587.85</td>
    </tr>
    <tr>
        <td>7473</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1244.90</td>
    </tr>
    <tr>
        <td>2071</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1629.84</td>
    </tr>
    <tr>
        <td>32</td>
        <td>2013-07</td>
        <td>9</td>
        <td>2009.75</td>
    </tr>
    <tr>
        <td>488</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1365.82</td>
    </tr>
    <tr>
        <td>7073</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1377.83</td>
    </tr>
    <tr>
        <td>8709</td>
        <td>2013-07</td>
        <td>8</td>
        <td>1349.87</td>
    </tr>
    <tr>
        <td>1498</td>
        <td>2013-07</td>
        <td>8</td>
        <td>1619.88</td>
    </tr>
</table></div></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Here are the number of records that need to be processed every time. Also it involves expensive join.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>172198</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us first insert the data into the table with out revenue. We will update the revenue later as an example for updating using query results.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO customer_order_metrics_mthly
SELECT o.order_customer_id,
    to_char(o.order_date, &#39;yyyy-MM&#39;) AS order_month,
    count(1) order_count,
    NULL
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
GROUP BY o.order_customer_id,
    to_char(o.order_date, &#39;yyyy-MM&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
48059 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM customer_order_metrics_mthly
ORDER BY order_month,
    customer_id
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>customer_id</th>
        <th>order_month</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>12</td>
        <td>2013-07</td>
        <td>2</td>
        <td>None</td>
    </tr>
    <tr>
        <td>16</td>
        <td>2013-07</td>
        <td>1</td>
        <td>None</td>
    </tr>
    <tr>
        <td>17</td>
        <td>2013-07</td>
        <td>2</td>
        <td>None</td>
    </tr>
    <tr>
        <td>19</td>
        <td>2013-07</td>
        <td>3</td>
        <td>None</td>
    </tr>
    <tr>
        <td>32</td>
        <td>2013-07</td>
        <td>9</td>
        <td>None</td>
    </tr>
    <tr>
        <td>45</td>
        <td>2013-07</td>
        <td>4</td>
        <td>None</td>
    </tr>
    <tr>
        <td>48</td>
        <td>2013-07</td>
        <td>4</td>
        <td>None</td>
    </tr>
    <tr>
        <td>54</td>
        <td>2013-07</td>
        <td>2</td>
        <td>None</td>
    </tr>
    <tr>
        <td>58</td>
        <td>2013-07</td>
        <td>4</td>
        <td>None</td>
    </tr>
    <tr>
        <td>64</td>
        <td>2013-07</td>
        <td>2</td>
        <td>None</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Updating order_revenue along with count. This is expensive operation, but we will be running only once.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

UPDATE customer_order_metrics_mthly comd
SET 
    (order_count, order_revenue) = (
        SELECT count(1),
            round(sum(order_item_subtotal)::numeric, 2)
        FROM orders o 
            JOIN order_items oi
                ON o.order_id = oi.order_item_order_id
        WHERE o.order_customer_id = comd.customer_id
            AND to_char(o.order_date, &#39;yyyy-MM&#39;) = comd.order_month
            AND to_char(o.order_date, &#39;yyyy-MM&#39;) = &#39;2013-08&#39;
            AND comd.order_month = &#39;2013-08&#39;
        GROUP BY o.order_customer_id,
            to_char(o.order_date, &#39;yyyy-MM&#39;)
    )
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.order_customer_id = comd.customer_id
        AND to_char(o.order_date, &#39;yyyy-MM&#39;) = comd.order_month
        AND to_char(o.order_date, &#39;yyyy-MM&#39;) = &#39;2013-08&#39;
) AND comd.order_month = &#39;2013-08&#39;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
3935 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As data is pre processed and loaded into the table, queries similar to below ones against <strong>customer_order_metrics_mthly</strong> will run much faster.</p>
<p>We need to process lesser amount of data with out expensive join.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM customer_order_metrics_mthly
WHERE order_month = &#39;2013-08&#39;
ORDER BY order_month,
    customer_id
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>customer_id</th>
        <th>order_month</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-08</td>
        <td>5</td>
        <td>769.82</td>
    </tr>
    <tr>
        <td>13</td>
        <td>2013-08</td>
        <td>5</td>
        <td>1065.93</td>
    </tr>
    <tr>
        <td>14</td>
        <td>2013-08</td>
        <td>3</td>
        <td>459.97</td>
    </tr>
    <tr>
        <td>18</td>
        <td>2013-08</td>
        <td>1</td>
        <td>129.99</td>
    </tr>
    <tr>
        <td>20</td>
        <td>2013-08</td>
        <td>2</td>
        <td>739.91</td>
    </tr>
    <tr>
        <td>22</td>
        <td>2013-08</td>
        <td>5</td>
        <td>769.96</td>
    </tr>
    <tr>
        <td>24</td>
        <td>2013-08</td>
        <td>2</td>
        <td>399.91</td>
    </tr>
    <tr>
        <td>25</td>
        <td>2013-08</td>
        <td>1</td>
        <td>129.99</td>
    </tr>
    <tr>
        <td>33</td>
        <td>2013-08</td>
        <td>3</td>
        <td>929.92</td>
    </tr>
    <tr>
        <td>34</td>
        <td>2013-08</td>
        <td>4</td>
        <td>789.92</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As an example for delete using query, we will delete all the dormant customers from <strong>customers</strong> table. Dormant customers are those customers who never placed any order. For this we will create back up customers table as I do not want to play with customers.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS customers_backup
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE customers_backup
AS
SELECT * FROM customers
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
12435 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM customers_backup c
    LEFT OUTER JOIN orders o
        ON c.customer_id = o.order_customer_id
WHERE o.order_customer_id IS NULL
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>30</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM customers_backup c
WHERE NOT EXISTS (
    SELECT 1 FROM orders o
    WHERE c.customer_id = o.order_customer_id
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>30</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We need to use nested sub queries as part of the delete with <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">EXISTS</span></code> or <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code> as demonstrated below. We cannot use direct joins as part of the <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DELETE FROM customers_backup c
WHERE NOT EXISTS (
    SELECT 1 FROM orders o
    WHERE c.customer_id = o.order_customer_id
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
30 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM customers_backup
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>12405</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DELETE FROM customers_backup c
WHERE customer_id NOT IN (
    SELECT order_customer_id FROM orders o
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
0 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./07_writing_advanced_sql_queries"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="05_create_table_as_select.html" title="previous page">CTAS - Create Table as Select</a>
    <a class='right-next' id="next-link" href="07_merging_or_upserting_data.html" title="next page">Merging or Upserting Data</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Durga Gadiraju<br/>
        
            &copy; Copyright ITVersity, Inc.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-80990145-11', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    
  </body>
</html>