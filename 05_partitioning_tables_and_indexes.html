
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Partitioning Tables and Indexes &#8212; My Jupyter Book</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Pre-Defined Functions" href="06_predefined_functions.html" />
    <link rel="prev" title="Creating Tables and Indexes" href="04_creating_tables_and_indexes.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">My Jupyter Book</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="mastering-postgresql.html">
   Mastering Postgresql
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="01_getting_started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_dml_or_crud_operations.html">
   DML or CRUD Operations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_writing_basic_sql_queries.html">
   Writing Basic SQL Queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_creating_tables_and_indexes.html">
   Creating Tables and Indexes
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Partitioning Tables and Indexes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_predefined_functions.html">
   Pre-Defined Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_writing_advanced_sql_queries.html">
   Writing Advanced SQL Queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_query_performance_tuning.html">
   Query Performance Tuning
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/05_partitioning_tables_and_indexes.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/05_partitioning_tables_and_indexes.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-partitioning">
   Overview of Partitioning
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#list-partitioning">
   List Partitioning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-partitioned-table">
     Create Partitioned Table
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#managing-partitions-list">
   Managing Partitions - List
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#manipulating-data">
   Manipulating Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#range-partitioning">
   Range Partitioning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Create Partitioned Table
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#managing-partitions-range">
   Managing Partitions - Range
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#repartitioning-range">
   Repartitioning - Range
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hash-partitioning">
   Hash Partitioning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Create Partitioned Table
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#managing-partitions-hash">
   Managing Partitions - Hash
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#usage-scenarios">
   Usage Scenarios
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sub-partitioning">
   Sub Partitioning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#list-list-partitioning">
     List - List Partitioning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#list-range-partitioning">
     List - Range Partitioning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-partitioning-tables">
   Exercise - Partitioning Tables
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="partitioning-tables-and-indexes">
<h1>Partitioning Tables and Indexes<a class="headerlink" href="#partitioning-tables-and-indexes" title="Permalink to this headline">¶</a></h1>
<p>As part of this section we will primarily talk about partitioning tables as well as indexes.</p>
<ul class="simple">
<li><p>Overview of Partitioning</p></li>
<li><p>List Partitioning</p></li>
<li><p>Managing Partitions - List</p></li>
<li><p>Manipulating Data</p></li>
<li><p>Range Partitioning</p></li>
<li><p>Managing Partitions - Range</p></li>
<li><p>Repartitioning - Range</p></li>
<li><p>Hash Partitioning</p></li>
<li><p>Managing Partitions - Hash</p></li>
<li><p>Usage Scenarios</p></li>
<li><p>Sub Partitioning</p></li>
<li><p>Exercise - Paritioning Tables</p></li>
</ul>
<p>Here are the key objectives of this section.</p>
<ul class="simple">
<li><p>Different partitioning strategies</p></li>
<li><p>How to create and manage partitioned tables?</p></li>
<li><p>How to manipulate data by inserting, updating and deleting data from managed tables?</p></li>
<li><p>How to repartition the tables if partitioning strategy is changed (example: from yearly to monthly)?</p></li>
<li><p>Learn about sub partitioning or nested partitioning or multi level partitioning with examples.</p></li>
<li><p>Self evaluate whether one understood key skills related to partitioned tables or not using exercises.</p></li>
</ul>
<div class="section" id="overview-of-partitioning">
<h2>Overview of Partitioning<a class="headerlink" href="#overview-of-partitioning" title="Permalink to this headline">¶</a></h2>
<p>Most of the modern database technologies support wide variety of partitioning strategies. However, here are the most commonly used ones.</p>
<ul class="simple">
<li><p>List Partitioning</p></li>
<li><p>Range Partitioning</p></li>
<li><p>Hash Partitioning</p></li>
<li><p>List and Range are more widely used compared to Hash Partitioning.</p></li>
<li><p>We can also mix and match these to have multi level partitioning. It is known as sub partitioning.</p></li>
<li><p>We can either partition a table with out primary key or partition a table with primary key when partition column is prime attribute (one of the primary key columns).</p></li>
<li><p>Indexes can be added to the partitioned table. If we create on the main table, it is global index and if we create index on each partition then it is partitioned index.</p></li>
</ul>
</div>
<div class="section" id="list-partitioning">
<h2>List Partitioning<a class="headerlink" href="#list-partitioning" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can take care of list partitioning of tables.</p>
<ul class="simple">
<li><p>It is primarily used to create partitions based up on the values.</p></li>
<li><p>Here are the steps involved in creating table using list partitioning strategy.</p>
<ul>
<li><p>Create table using <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">LIST</span></code></p></li>
<li><p>Add default and value specific partitions</p></li>
<li><p>Validate by inserting data into the table</p></li>
</ul>
</li>
<li><p>We can detach as well as drop the partitions from the table.</p></li>
</ul>
<div class="section" id="create-partitioned-table">
<h3>Create Partitioned Table<a class="headerlink" href="#create-partitioned-table" title="Permalink to this headline">¶</a></h3>
<p>Let us create partitioned table with name <code class="docutils literal notranslate"><span class="pre">users_part</span></code>.</p>
<ul class="simple">
<li><p>It contains same columns as <code class="docutils literal notranslate"><span class="pre">users</span></code>.</p></li>
<li><p>We will partition based up on <code class="docutils literal notranslate"><span class="pre">user_role</span></code> field.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> DROP TABLE IF EXISTS users
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    user_first_name VARCHAR(30) NOT NULL,
    user_last_name VARCHAR(30) NOT NULL,
    user_email_id VARCHAR(50) NOT NULL,
    user_email_validated BOOLEAN DEFAULT FALSE,
    user_password VARCHAR(200),
    user_role VARCHAR(1) NOT NULL DEFAULT &#39;U&#39;, --U and A
    is_active BOOLEAN DEFAULT FALSE,
    created_dt DATE DEFAULT CURRENT_DATE,
    last_updated_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> DROP TABLE IF EXISTS users_part
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_part (
    user_id SERIAL,
    user_first_name VARCHAR(30) NOT NULL,
    user_last_name VARCHAR(30) NOT NULL,
    user_email_id VARCHAR(50) NOT NULL,
    user_email_validated BOOLEAN DEFAULT FALSE,
    user_password VARCHAR(200),
    user_role VARCHAR(1) NOT NULL DEFAULT &#39;U&#39;, --U and A
    is_active BOOLEAN DEFAULT FALSE,
    created_dt DATE DEFAULT CURRENT_DATE,
    last_updated_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_role, user_id)
) PARTITION BY LIST(user_role)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Additional indexes on the users_part table.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE INDEX users_part_email_id_idx 
    ON users_part(user_email_id)
</pre></div>
</div>
</div>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>Below <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> statement will fail as we have not added any partitions to the table <code class="docutils literal notranslate"><span class="pre">users_part</span></code> even though it is created as partitioned table.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_part (user_first_name, user_last_name, user_email_id)
VALUES 
    (&#39;Scott&#39;, &#39;Tiger&#39;, &#39;scott@tiger.com&#39;),
    (&#39;Donald&#39;, &#39;Duck&#39;, &#39;donald@duck.com&#39;),
    (&#39;Mickey&#39;, &#39;Mouse&#39;, &#39;mickey@mouse.com&#39;)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="managing-partitions-list">
<h2>Managing Partitions - List<a class="headerlink" href="#managing-partitions-list" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to manage partitions for a partitioned table using <code class="docutils literal notranslate"><span class="pre">users_part</span></code>.</p>
<ul class="simple">
<li><p>All users data with <code class="docutils literal notranslate"><span class="pre">user_role</span></code> as <strong>‘U’</strong> should go to one partition by name <code class="docutils literal notranslate"><span class="pre">users_part_u</span></code>.</p></li>
<li><p>All users data with <code class="docutils literal notranslate"><span class="pre">user_role</span></code> as <strong>‘A’</strong> should go to one partition by name <code class="docutils literal notranslate"><span class="pre">users_part_a</span></code>.</p></li>
<li><p>We can add partition to existing partitioned table using <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span> <span class="pre">partition_name</span> <span class="pre">PARTITION</span> <span class="pre">OF</span> <span class="pre">table_name</span></code>.</p></li>
<li><p>We can have a partition for default values so that all the data that does not satisfy the partition condition can be added to it.</p></li>
<li><p>We can have a partition for each value or for a set of values.</p>
<ul>
<li><p>We can have one partition for <code class="docutils literal notranslate"><span class="pre">U</span></code> as well as <code class="docutils literal notranslate"><span class="pre">A</span></code> and default partition for all other values.</p></li>
<li><p>We can have individual partitions for <code class="docutils literal notranslate"><span class="pre">U</span></code>, <code class="docutils literal notranslate"><span class="pre">A</span></code> respectively and default partition for all other values.</p></li>
<li><p>We can use <code class="docutils literal notranslate"><span class="pre">FOR</span> <span class="pre">VALUES</span> <span class="pre">IN</span> <span class="pre">(val1,</span> <span class="pre">val2)</span></code> as part of <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span> <span class="pre">partition_name</span> <span class="pre">PARTITION</span> <span class="pre">OF</span> <span class="pre">table_name</span></code> to specify values for respective table created for partition.</p></li>
</ul>
</li>
<li><p>Once partitions are added, we can insert data into the partitioned table.</p></li>
<li><p>We can detach using <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> and drop the partition or drop the partition directly. To drop the partition we need to use <code class="docutils literal notranslate"><span class="pre">DROP</span> <span class="pre">TABLE</span></code> command.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is how we can create partition for default values for a list partitioned table <strong>users_part</strong>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_part_default
PARTITION OF users_part DEFAULT
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the 3 records will go to default partition as we have not defined any partition for user_role ‘U’.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_part (user_first_name, user_last_name, user_email_id, user_role)
VALUES 
    (&#39;Scott&#39;, &#39;Tiger&#39;, &#39;scott@tiger.com&#39;, &#39;U&#39;),
    (&#39;Donald&#39;, &#39;Duck&#39;, &#39;donald@duck.com&#39;, &#39;U&#39;),
    (&#39;Mickey&#39;, &#39;Mouse&#39;, &#39;mickey@mouse.com&#39;, &#39;U&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part_default
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_part_a 
PARTITION OF users_part  
FOR VALUES IN (&#39;A&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

UPDATE users_part
SET
    user_role = &#39;A&#39;
WHERE user_email_id = &#39;scott@tiger.com&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part_a
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part_default
</pre></div>
</div>
</div>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>This will fail as there are records with user_role ‘U’ in default partition.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_part_u 
PARTITION OF users_part  
FOR VALUES IN (&#39;U&#39;)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can detach the partition, add partition for ‘U’ and load the data from detached partitione into the new partition created.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE users_part
    DETACH PARTITION users_part_default
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_part_u 
PARTITION OF users_part  
FOR VALUES IN (&#39;U&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_part
SELECT * FROM users_part_default
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part_a
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part_u
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can drop and create partition for default or truncate and attach the existing default partition.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE users_part_default
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_part_default
PARTITION OF users_part DEFAULT
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="manipulating-data">
<h2>Manipulating Data<a class="headerlink" href="#manipulating-data" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can manipulate data for a partitioned table.</p>
<ul class="simple">
<li><p>We can insert data using the table (most preferred way).</p></li>
<li><p>As we define table for each partition, we can insert data using table created for specific partition.</p></li>
<li><p>In the case of <code class="docutils literal notranslate"><span class="pre">users_part</span></code> partitioned table, we can either use table name<code class="docutils literal notranslate"><span class="pre">users_part</span></code> or partition name <code class="docutils literal notranslate"><span class="pre">users_part_u</span></code> to insert records with user_role <strong>‘U’</strong>.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users_part_u</span> 
<span class="n">PARTITION</span> <span class="k">OF</span> <span class="n">users_part</span>  
<span class="k">FOR</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>As part of the update, if we change the value in a partitioned column which will result in changing partition, then internally data from one partition will be moved to other.</p></li>
<li><p>We can delete the data using the table or the table created for each partition (either by using table name <code class="docutils literal notranslate"><span class="pre">users_part</span></code> or partitions such as <code class="docutils literal notranslate"><span class="pre">users_part_u</span></code>, <code class="docutils literal notranslate"><span class="pre">users_part_a</span></code> etc</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DML is same irrespective of the partitioning strategy. This applies to all 3 partitioning strategies - <strong>list</strong>, <strong>range</strong> as well as <strong>hash</strong>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

TRUNCATE TABLE users_part
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_part (user_first_name, user_last_name, user_email_id, user_role)
VALUES 
    (&#39;Scott&#39;, &#39;Tiger&#39;, &#39;scott@tiger.com&#39;, &#39;U&#39;),
    (&#39;Donald&#39;, &#39;Duck&#39;, &#39;donald@duck.com&#39;, &#39;U&#39;),
    (&#39;Mickey&#39;, &#39;Mouse&#39;, &#39;mickey@mouse.com&#39;, &#39;U&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part_u
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_part_a (user_first_name, user_last_name, user_email_id, user_role)
VALUES
    (&#39;Matt&#39;, &#39;Clarke&#39;, &#39;matt@clarke.com&#39;, &#39;A&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

UPDATE users_part SET
    user_role = &#39;A&#39;
WHERE user_email_id = &#39;donald@duck.com&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part_a
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DELETE FROM users_part WHERE user_email_id = &#39;donald@duck.com&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DELETE FROM users_part_u WHERE user_email_id = &#39;mickey@mouse.com&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_part
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="range-partitioning">
<h2>Range Partitioning<a class="headerlink" href="#range-partitioning" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can take care of range partitioning of tables.</p>
<ul class="simple">
<li><p>It is primarily used to create partitions based up on a given range of values.</p></li>
<li><p>Here are the steps involved in creating table using range partitioning strategy.</p>
<ul>
<li><p>Create table using <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">RANGE</span></code></p></li>
<li><p>Add default and range specific partitions</p></li>
<li><p>Validate by inserting data into the table</p></li>
</ul>
</li>
<li><p>We can detach as well as drop the partitions from the table.</p></li>
</ul>
<div class="section" id="id1">
<h3>Create Partitioned Table<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Let us create partitioned table with name <code class="docutils literal notranslate"><span class="pre">users_range_part</span></code>.</p>
<ul class="simple">
<li><p>It contains same columns as <code class="docutils literal notranslate"><span class="pre">users</span></code>.</p></li>
<li><p>We will partition the table based up on <code class="docutils literal notranslate"><span class="pre">created_dt</span></code> field.</p></li>
<li><p>We will create one partition per year with naming convention <strong>users_range_part_yyyy</strong> (users_range_part_2016).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> DROP TABLE IF EXISTS users_range_part
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_range_part (
    user_id SERIAL,
    user_first_name VARCHAR(30) NOT NULL,
    user_last_name VARCHAR(30) NOT NULL,
    user_email_id VARCHAR(50) NOT NULL,
    user_email_validated BOOLEAN DEFAULT FALSE,
    user_password VARCHAR(200),
    user_role VARCHAR(1) NOT NULL DEFAULT &#39;U&#39;, --U and A
    is_active BOOLEAN DEFAULT FALSE,
    created_dt DATE DEFAULT CURRENT_DATE,
    last_updated_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (created_dt, user_id)
) PARTITION BY RANGE(created_dt)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We will not be able to insert the data until we add at least one partition.</p>
</div>
</div>
</div>
<div class="section" id="managing-partitions-range">
<h2>Managing Partitions - Range<a class="headerlink" href="#managing-partitions-range" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to manage partitions for the table <code class="docutils literal notranslate"><span class="pre">users_range_part</span></code>.</p>
<ul class="simple">
<li><p>All users data created in a specific year should go to the respective partition created.</p></li>
<li><p>For example, all users data created in the year of 2016 should go to <code class="docutils literal notranslate"><span class="pre">users_range_part_2016</span></code>.</p></li>
<li><p>We can add partition to existing partitioned table using <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span> <span class="pre">partition_name</span> <span class="pre">PARTITION</span> <span class="pre">OF</span> <span class="pre">table_name</span></code>.</p></li>
<li><p>We can have a partition for default values so that all the data that does not satisfy the partition condition can be added to it.</p></li>
<li><p>We can have a partition for specific range of values using <code class="docutils literal notranslate"><span class="pre">FOR</span> <span class="pre">VALUES</span> <span class="pre">FROM</span> <span class="pre">(from_value)</span> <span class="pre">TO</span> <span class="pre">(to_value)</span></code> as part of <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span> <span class="pre">partition_name</span> <span class="pre">PARTITION</span> <span class="pre">OF</span> <span class="pre">table_name</span></code>.</p></li>
<li><p>Once partitions are added, we can insert data into the partitioned table.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is how we can create partition for default values for a range partitioned table <strong>users_range_part</strong>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_range_part_default
PARTITION OF users_range_part DEFAULT
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_range_part_2016
PARTITION OF users_range_part
FOR VALUES FROM (&#39;2016-01-01&#39;) TO (&#39;2016-12-31&#39;)
</pre></div>
</div>
</div>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>As there is a overlap between the previous partition and below one, command to create partition for data ranging from 2016-01-01 till 2017-12-31 will fail.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_range_part_2017
PARTITION OF users_range_part
FOR VALUES FROM (&#39;2016-01-01&#39;) TO (&#39;2017-12-31&#39;)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is how we can create partitions for the years <strong>2017</strong>, <strong>2018</strong>, <strong>2019</strong> etc</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_range_part_2017
PARTITION OF users_range_part
FOR VALUES FROM (&#39;2017-01-01&#39;) TO (&#39;2017-12-31&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_range_part_2018
PARTITION OF users_range_part
FOR VALUES FROM (&#39;2018-01-01&#39;) TO (&#39;2018-12-31&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_range_part_2019
PARTITION OF users_range_part
FOR VALUES FROM (&#39;2019-01-01&#39;) TO (&#39;2019-12-31&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_range_part_2020
PARTITION OF users_range_part
FOR VALUES FROM (&#39;2020-01-01&#39;) TO (&#39;2020-12-31&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_range_part 
    (user_first_name, user_last_name, user_email_id, created_dt)
VALUES 
    (&#39;Scott&#39;, &#39;Tiger&#39;, &#39;scott@tiger.com&#39;, &#39;2018-10-01&#39;),
    (&#39;Donald&#39;, &#39;Duck&#39;, &#39;donald@duck.com&#39;, &#39;2019-02-10&#39;),
    (&#39;Mickey&#39;, &#39;Mouse&#39;, &#39;mickey@mouse.com&#39;, &#39;2017-06-22&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT user_first_name, user_last_name, user_email_id, created_dt
FROM users_range_part_default
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT user_first_name, user_last_name, user_email_id, created_dt
FROM users_range_part_2017
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT user_first_name, user_last_name, user_email_id, created_dt
FROM users_range_part_2018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT user_first_name, user_last_name, user_email_id, created_dt
FROM users_range_part_2019
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT user_first_name, user_last_name, user_email_id, created_dt
FROM users_range_part_2020
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="repartitioning-range">
<h2>Repartitioning - Range<a class="headerlink" href="#repartitioning-range" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can repartition the existing partitioned table.</p>
<ul class="simple">
<li><p>We will use <strong>users_range_part</strong> table. It is originally partitioned for each year.</p></li>
<li><p>Now we would like to partition for each month.</p></li>
<li><p>Here are the steps that are involved in repartitioning from year to month.</p>
<ul>
<li><p>Detach all yearly partitions from <strong>users_range_part</strong>.</p></li>
<li><p>Add new partitions for each month.</p></li>
<li><p>Load data from detached partitions into the table with new partitions for each month.</p></li>
<li><p>Validate to ensure that all the data is copied.</p></li>
<li><p>Drop all the detached partitions.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Detach all yearly partitions</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE users_range_part
    DETACH PARTITION users_range_part_2016
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE users_range_part
    DETACH PARTITION users_range_part_2017
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE users_range_part
    DETACH PARTITION users_range_part_2018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE users_range_part
    DETACH PARTITION users_range_part_2019
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE users_range_part
    DETACH PARTITION users_range_part_2020
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Add new partitions for every month between 2016 January and 2020 December.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install psycopg2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.tseries.offsets</span> <span class="kn">import</span> <span class="n">MonthBegin</span><span class="p">,</span> <span class="n">MonthEnd</span>

<span class="n">months</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;1/1/2016&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;3/31/2016&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
    <span class="n">begin_date</span> <span class="o">=</span> <span class="n">month</span> <span class="o">-</span> <span class="n">MonthBegin</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">month</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">begin_date</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.tseries.offsets</span> <span class="kn">import</span> <span class="n">MonthBegin</span><span class="p">,</span> <span class="n">MonthEnd</span>

<span class="n">months</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;1/1/2016&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;12/31/2020&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">)</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5432&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;itversity_sms_db&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;itversity_sms_user&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s1">&#39;sms_password&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;users_range_part&#39;</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">CREATE TABLE </span><span class="si">{table_name}</span><span class="s1">_</span><span class="si">{yyyymm}</span><span class="s1"></span>
<span class="s1">PARTITION OF </span><span class="si">{table_name}</span><span class="s1"></span>
<span class="s1">FOR VALUES FROM (&#39;</span><span class="si">{begin_date}</span><span class="s1">&#39;) TO (&#39;</span><span class="si">{end_date}</span><span class="s1">&#39;)</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
    <span class="n">begin_date</span> <span class="o">=</span> <span class="n">month</span> <span class="o">-</span> <span class="n">MonthBegin</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">month</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding partition for </span><span class="si">{</span><span class="n">begin_date</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">query</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">yyyymm</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">begin_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">begin_date</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">end_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">),</span> <span class="p">()</span>
    <span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Load data from detached yearly partitions into monthly partitioned table.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_range_part
SELECT * FROM users_range_part_2016
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_range_part
SELECT * FROM users_range_part_2017
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_range_part
SELECT * FROM users_range_part_2018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_range_part
SELECT * FROM users_range_part_2019
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_range_part
SELECT * FROM users_range_part_2020
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_range_part
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_range_part_201706
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_range_part_201810
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_range_part_201902
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As we are able to see the data in the monthly partitioned table, we can drop the tables which are created earlier using yearly partitioning strategy.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE users_range_part_2016
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE users_range_part_2017
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE users_range_part_2018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE users_range_part_2019
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE users_range_part_2020
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT table_catalog, 
    table_schema, 
    table_name FROM information_schema.tables
WHERE table_name ~ &#39;users_range_part_&#39;
ORDER BY table_name
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="hash-partitioning">
<h2>Hash Partitioning<a class="headerlink" href="#hash-partitioning" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can take care of Hash partitioning of tables.</p>
<ul class="simple">
<li><p>It is primarily used to create partitions based up on modulus and reminder.</p></li>
<li><p>Here are the steps involved in creating table using hash partitioning strategy.</p>
<ul>
<li><p>Create table using <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">HASH</span></code></p></li>
<li><p>Add default and remainder specific partitions based up on modulus.</p></li>
<li><p>Validate by inserting data into the table</p></li>
</ul>
</li>
<li><p>We can detach as well as drop the partitions from the table.</p></li>
<li><p>Hash partitioning is typically done on sparse columns such as <code class="docutils literal notranslate"><span class="pre">user_id</span></code>.</p></li>
<li><p>If we want to use hash partitioning on more than one tables with common key, we typically partition all the tables using same key.</p></li>
</ul>
<div class="section" id="id2">
<h3>Create Partitioned Table<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Let us create partitioned table with name <code class="docutils literal notranslate"><span class="pre">users_hash_part</span></code>.</p>
<ul class="simple">
<li><p>It contains same columns as <code class="docutils literal notranslate"><span class="pre">users</span></code>.</p></li>
<li><p>We will partition the table based up on <code class="docutils literal notranslate"><span class="pre">user_id</span></code> field.</p></li>
<li><p>We will create one partition for each reminder with modulus 8.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> DROP TABLE IF EXISTS users_hash_part
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part (
    user_id SERIAL,
    user_first_name VARCHAR(30) NOT NULL,
    user_last_name VARCHAR(30) NOT NULL,
    user_email_id VARCHAR(50) NOT NULL,
    user_email_validated BOOLEAN DEFAULT FALSE,
    user_password VARCHAR(200),
    user_role VARCHAR(1) NOT NULL DEFAULT &#39;U&#39;, --U and A
    is_active BOOLEAN DEFAULT FALSE,
    created_dt DATE DEFAULT CURRENT_DATE,
    last_updated_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id)
) PARTITION BY HASH(user_id)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We will not be able to insert the data until we add at least one partition.</p>
</div>
</div>
</div>
<div class="section" id="managing-partitions-hash">
<h2>Managing Partitions - Hash<a class="headerlink" href="#managing-partitions-hash" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to manage partitions using table <code class="docutils literal notranslate"><span class="pre">users_hash_part</span></code> which is partitioned using <strong>hash</strong>.</p>
<ul class="simple">
<li><p>We would like to divide our data into 8 hash buckets.</p></li>
<li><p>While adding partitions for <strong>hash partitioned table</strong>, we need to specify modulus and remainder.</p></li>
<li><p>For each and every record inserted, following will happen for the column specified as partitioned key.</p>
<ul>
<li><p>A hash will be computed. Hash is nothing but an integer.</p></li>
<li><p>The integer generated will be divided by the value specified in <strong>modulus</strong>.</p></li>
<li><p>Based up on the remainder, the record will be inserted into corresponding partition.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>We cannot have a default partition for hash partitioned table.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_default
PARTITION OF users_hash_part DEFAULT
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us add partitions using modulus as 8. For each remainder between 0 to 7. we need to add a partition.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_0_of_8
PARTITION OF users_hash_part
FOR VALUES WITH (modulus 8, remainder 0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_1_of_8
PARTITION OF users_hash_part
FOR VALUES WITH (modulus 8, remainder 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_2_of_8
PARTITION OF users_hash_part
FOR VALUES WITH (modulus 8, remainder 2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_3_of_8
PARTITION OF users_hash_part
FOR VALUES WITH (modulus 8, remainder 3)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_4_of_8
PARTITION OF users_hash_part
FOR VALUES WITH (modulus 8, remainder 4)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_5_of_8
PARTITION OF users_hash_part
FOR VALUES WITH (modulus 8, remainder 5)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_6_of_8
PARTITION OF users_hash_part
FOR VALUES WITH (modulus 8, remainder 6)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_hash_part_7_of_8
PARTITION OF users_hash_part
FOR VALUES WITH (modulus 8, remainder 7)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO users_hash_part
    (user_first_name, user_last_name, user_email_id, created_dt)
VALUES 
    (&#39;Scott&#39;, &#39;Tiger&#39;, &#39;scott@tiger.com&#39;, &#39;2018-10-01&#39;),
    (&#39;Donald&#39;, &#39;Duck&#39;, &#39;donald@duck.com&#39;, &#39;2019-02-10&#39;),
    (&#39;Mickey&#39;, &#39;Mouse&#39;, &#39;mickey@mouse.com&#39;, &#39;2017-06-22&#39;)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>user_id</strong> is populated by sequence. The hash of every sequence generated integer will be divided by modulus (which is 8) and based up on the remainder data will be inserted into corresponding partition.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part_0_of_8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part_1_of_8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part_2_of_8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part_3_of_8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part_4_of_8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part_5_of_8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part_6_of_8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM users_hash_part_7_of_8
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="usage-scenarios">
<h2>Usage Scenarios<a class="headerlink" href="#usage-scenarios" title="Permalink to this headline">¶</a></h2>
<p>Let us go through some of the usage scenarios with respect to partitioning.</p>
<ul class="simple">
<li><p>It is typically used to manage large tables so that the tables does not grow abnormally over a period of time.</p></li>
<li><p>Partitioning is quite often used on top of log tables, reporting tables etc.</p></li>
<li><p>If a log table is partitioned and if we want to have data for 7 years, partitions older than 7 years can be quickly dropped.</p></li>
<li><p>Dropping partitions to clean up huge chunk of data is much faster compared to running delete command on non partitioned table.</p></li>
<li><p>For tables like orders with limited set of statuses, we often use list partitioning based up on the status. It can be 2 partitions (CLOSED orders and ACTIVE orders) or separate partition for each status.</p>
<ul>
<li><p>As most of the operations will be on <strong>Active Orders</strong>, this approach can significantly improve the performance.</p></li>
</ul>
</li>
<li><p>In case of log tables, where we might want to retain data for several years, we tend to use range partition on date column. If we use list partition, then we might end up in duplication of data unnecessarily.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Monthly partition using list. We need to have additional column to store the month to use list partitioning strategy.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS users_mthly
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_mthly (
    user_id SERIAL,
    user_first_name VARCHAR(30) NOT NULL,
    user_last_name VARCHAR(30) NOT NULL,
    user_email_id VARCHAR(50) NOT NULL,
    user_email_validated BOOLEAN DEFAULT FALSE,
    user_password VARCHAR(200),
    user_role VARCHAR(1) NOT NULL DEFAULT &#39;U&#39;, --U and A
    is_active BOOLEAN DEFAULT FALSE,
    created_dt DATE DEFAULT CURRENT_DATE,
    created_mnth INT,
    last_updated_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (created_mnth, user_id)
) PARTITION BY LIST(created_mnth)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_mthly_201601
PARTITION OF users_mthly
FOR VALUES IN (201601)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_mthly_201602
PARTITION OF users_mthly
FOR VALUES IN (201602)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Monthly partition using range. Partition strategy is defined on top of <strong>created_dt</strong>. No additional column is required.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS users_mthly
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_mthly (
    user_id SERIAL,
    user_first_name VARCHAR(30) NOT NULL,
    user_last_name VARCHAR(30) NOT NULL,
    user_email_id VARCHAR(50) NOT NULL,
    user_email_validated BOOLEAN DEFAULT FALSE,
    user_password VARCHAR(200),
    user_role VARCHAR(1) NOT NULL DEFAULT &#39;U&#39;, --U and A
    is_active BOOLEAN DEFAULT FALSE,
    created_dt DATE DEFAULT CURRENT_DATE,
    last_updated_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (created_dt, user_id)
) PARTITION BY RANGE(created_dt)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_mthly_201601
PARTITION OF users_mthly
FOR VALUES FROM (&#39;2016-01-01&#39;) TO (&#39;2016-01-31&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_mthly_201602
PARTITION OF users_mthly
FOR VALUES FROM (&#39;2016-02-01&#39;) TO (&#39;2016-02-29&#39;)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="sub-partitioning">
<h2>Sub Partitioning<a class="headerlink" href="#sub-partitioning" title="Permalink to this headline">¶</a></h2>
<p>We can have sub partitions created with different permutations and combinations. Sub Partitioning is also known as nested partitioning.</p>
<ul class="simple">
<li><p>List - List</p></li>
<li><p>List - Range
and others.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Try different sub-partitioning strategies based up on your requirements.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_sms_user:sms_password@localhost:5432/itversity_sms_db
</pre></div>
</div>
</div>
</div>
<div class="section" id="list-list-partitioning">
<h3>List - List Partitioning<a class="headerlink" href="#list-list-partitioning" title="Permalink to this headline">¶</a></h3>
<p>Let us understand how we can create table using list - list sub partitioning. We would like to have main partition per year and then sub partitions per quarter.</p>
<ul class="simple">
<li><p>Create table <code class="docutils literal notranslate"><span class="pre">users_qtly</span></code> with <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">LIST</span></code> with <code class="docutils literal notranslate"><span class="pre">created_year</span></code>.</p></li>
<li><p>Create tables for yearly partitions with <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">LIST</span></code> with <code class="docutils literal notranslate"><span class="pre">created_month</span></code>.</p></li>
<li><p>Create tables for quarterly partitions with list of values using <code class="docutils literal notranslate"><span class="pre">FOR</span> <span class="pre">VALUES</span> <span class="pre">IN</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS users_qtly
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_qtly (
    user_id SERIAL,
    user_first_name VARCHAR(30) NOT NULL,
    user_last_name VARCHAR(30) NOT NULL,
    user_email_id VARCHAR(50) NOT NULL,
    user_email_validated BOOLEAN DEFAULT FALSE,
    user_password VARCHAR(200),
    user_role VARCHAR(1) NOT NULL DEFAULT &#39;U&#39;, --U and A
    is_active BOOLEAN DEFAULT FALSE,
    created_dt DATE DEFAULT CURRENT_DATE,
    created_year INT,
    created_mnth INT,
    last_updated_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (created_year, created_mnth, user_id)
) PARTITION BY LIST(created_year)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_qtly_2016
PARTITION OF users_qtly
FOR VALUES IN (2016)
PARTITION BY LIST (created_mnth)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_qtly_2016q1
PARTITION OF users_qtly_2016
FOR VALUES IN (1, 2, 3)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_qtly_2016q2
PARTITION OF users_qtly_2016
FOR VALUES IN (4, 5, 6)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="list-range-partitioning">
<h3>List - Range Partitioning<a class="headerlink" href="#list-range-partitioning" title="Permalink to this headline">¶</a></h3>
<p>Let us understand how we can create table using list - Range sub partitioning using same example as before (partitioning by year and then by quarter).</p>
<ul class="simple">
<li><p>Create table with <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">LIST</span></code> with <code class="docutils literal notranslate"><span class="pre">created_year</span></code>.</p></li>
<li><p>Create tables for yearly partitions with <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">RANGE</span></code> with <code class="docutils literal notranslate"><span class="pre">created_month</span></code>.</p></li>
<li><p>Create tables for quarterly partitions with the range of values using <code class="docutils literal notranslate"><span class="pre">FOR</span> <span class="pre">VALUES</span> <span class="pre">FROM</span> <span class="pre">(lower_bound)</span> <span class="pre">TO</span> <span class="pre">(upper_bound)</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS users_qtly
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_qtly (
    user_id SERIAL,
    user_first_name VARCHAR(30) NOT NULL,
    user_last_name VARCHAR(30) NOT NULL,
    user_email_id VARCHAR(50) NOT NULL,
    user_email_validated BOOLEAN DEFAULT FALSE,
    user_password VARCHAR(200),
    user_role VARCHAR(1) NOT NULL DEFAULT &#39;U&#39;, --U and A
    is_active BOOLEAN DEFAULT FALSE,
    created_dt DATE DEFAULT CURRENT_DATE,
    created_year INT,
    created_mnth INT,
    last_updated_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (created_year, created_mnth, user_id)
) PARTITION BY LIST(created_year)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_qtly_2016
PARTITION OF users_qtly
FOR VALUES IN (2016)
PARTITION BY RANGE (created_mnth)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_qtly_2016q1
PARTITION OF users_qtly_2016
FOR VALUES FROM (1) TO (3)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE users_qtly_2016q2
PARTITION OF users_qtly_2016
FOR VALUES FROM (4) TO (6)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_sms_user:***@localhost:5432/itversity_sms_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="exercise-partitioning-tables">
<h2>Exercise - Partitioning Tables<a class="headerlink" href="#exercise-partitioning-tables" title="Permalink to this headline">¶</a></h2>
<p>Here is the exercise to get comfort with partitioning. We will be using range partitioning.</p>
<ul class="simple">
<li><p>Use retail database. Make sure <strong>orders</strong> table already exists.</p></li>
<li><p>Create table <strong>orders_part</strong> with the same columns as orders.</p></li>
<li><p>Partition the table by month using range partitioning on <strong>order_date</strong>.</p></li>
<li><p>Add 14 partitions - 13 based up on the data and 1 default. Here is the naming convention.</p>
<ul>
<li><p>Default - orders_part_default</p></li>
<li><p>Partition for 2014 January - orders_part_201401</p></li>
</ul>
</li>
<li><p>Load the data from <strong>orders</strong> into <strong>orders_part</strong>.</p></li>
<li><p>Get count on <strong>orders_part</strong> as well as all the 14 partitions. You should get 0 for default partition and all the records should be distributed using the other 13 partitions.</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="04_creating_tables_and_indexes.html" title="previous page">Creating Tables and Indexes</a>
    <a class='right-next' id="next-link" href="06_predefined_functions.html" title="next page">Pre-Defined Functions</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>