
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Writing Advanced SQL Queries &#8212; My Jupyter Book</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Query Performance Tuning" href="08_query_performance_tuning.html" />
    <link rel="prev" title="Pre-Defined Functions" href="06_predefined_functions.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">My Jupyter Book</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="mastering-postgresql.html">
   Mastering Postgresql
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="01_getting_started/01_getting_started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="reference internal" href="02_dml_or_crud_operations.html">
   DML or CRUD Operations
  </a>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="03_writing_basic_sql_queries.html">
     Writing Basic SQL Queries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="04_creating_tables_and_indexes.html">
     Creating Tables and Indexes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="05_partitioning_tables_and_indexes.html">
     Partitioning Tables and Indexes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="06_predefined_functions.html">
     Pre-Defined Functions
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Writing Advanced SQL Queries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="08_query_performance_tuning.html">
     Query Performance Tuning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mastering_postgresql_exercises.html">
     Exercises - Mastering Postgresql
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/07_writing_advanced_sql_queries.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/07_writing_advanced_sql_queries.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-views">
   Overview of Views
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#named-queries-using-with-clause">
   Named Queries - Using WITH Clause
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-sub-queries">
   Overview of Sub Queries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ctas-create-table-as-select">
   CTAS - Create Table as Select
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-dml-operations">
   Advanced DML Operations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#merging-or-upserting-data">
   Merging or Upserting Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pivoting-rows-into-columns">
   Pivoting Rows into Columns
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-analytic-functions">
   Overview of Analytic Functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prepare-tables">
     Prepare Tables
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analytic-functions-aggregations">
   Analytic Functions – Aggregations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cumulative-or-moving-aggregations">
   Cumulative or Moving Aggregations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analytic-functions-windowing">
   Analytic Functions – Windowing
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#getting-lead-and-lag-values">
     Getting LEAD and LAG values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#getting-first-and-last-values">
     Getting first and last values
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analytic-functions-ranking">
   Analytic Functions – Ranking
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analytic-functions-filtering">
   Analytic Functions - Filtering
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#order-of-execution-of-sql">
     Order of execution of SQL
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Overview of Sub Queries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#filtering-analytic-function-results">
     Filtering - Analytic Function Results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ranking-and-filtering-recap">
   Ranking and Filtering - Recap
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises-analytics-functions">
   Exercises - Analytics Functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prepare-hr-database">
     Prepare HR Database
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-1">
     Exercise 1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-2">
     Exercise 2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-3">
     Exercise 3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-4">
     Exercise 4
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-5">
     Exercise 5
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="writing-advanced-sql-queries">
<h1>Writing Advanced SQL Queries<a class="headerlink" href="#writing-advanced-sql-queries" title="Permalink to this headline">¶</a></h1>
<p>As part of this section we will understand how to write queries using some of the advanced features.</p>
<ul class="simple">
<li><p>Overview of Views</p></li>
<li><p>Overview of Sub Queries</p></li>
<li><p>CTAS - Create Table As Select</p></li>
<li><p>Advanced DML Operations</p></li>
<li><p>Merging or Upserting Data</p></li>
<li><p>Pivoting Rows into Columns</p></li>
<li><p>Overview of Analytic Functions</p></li>
<li><p>Analytic Functions – Aggregations</p></li>
<li><p>Cumulative Aggregations</p></li>
<li><p>Analytic Functions – Windowing</p></li>
<li><p>Analytic Functions – Ranking</p></li>
<li><p>Getting Top 5 Daily Products</p></li>
<li><p>Exercises - Analytic Functions</p></li>
</ul>
<div class="section" id="overview-of-views">
<h2>Overview of Views<a class="headerlink" href="#overview-of-views" title="Permalink to this headline">¶</a></h2>
<p>Here are the details related to views.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/MTfKsGcmwjA?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>View is nothing but a named query. We typically create views for most commonly used queries.</p></li>
<li><p>Unlike tables, views does not physically store the data and when ever we write a query against view it will fetch the data from underlying tables defined as part of the views.</p></li>
<li><p>We can perform DML operations over the tables via views with restrictions (for example, we cannot perform DML operations on views with joins, group by etc).</p></li>
<li><p>Views that can be used to perform DML operations on underlying tables are called as <strong>updatable views</strong></p></li>
<li><p>Views can be used to provide restricted permissions on tables for DML Operations. However, it is not used these days.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE OR REPLACE VIEW orders_v
AS
SELECT * FROM orders
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE VIEW orders_v
AS
SELECT * FROM orders
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
(psycopg2.errors.DuplicateTable) relation &quot;orders_v&quot; already exists

[SQL: CREATE VIEW orders_v AS
SELECT * FROM orders]
(Background on this error at: http://sqlalche.me/e/13/f405)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM information_schema.tables
WHERE table_name ~ &#39;orders&#39;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
2 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>table_catalog</th>
        <th>table_schema</th>
        <th>table_name</th>
        <th>table_type</th>
        <th>self_referencing_column_name</th>
        <th>reference_generation</th>
        <th>user_defined_type_catalog</th>
        <th>user_defined_type_schema</th>
        <th>user_defined_type_name</th>
        <th>is_insertable_into</th>
        <th>is_typed</th>
        <th>commit_action</th>
    </tr>
    <tr>
        <td>itversity_retail_db</td>
        <td>public</td>
        <td>orders</td>
        <td>BASE TABLE</td>
        <td>None</td>
        <td>None</td>
        <td>None</td>
        <td>None</td>
        <td>None</td>
        <td>YES</td>
        <td>NO</td>
        <td>None</td>
    </tr>
    <tr>
        <td>itversity_retail_db</td>
        <td>public</td>
        <td>orders_v</td>
        <td>VIEW</td>
        <td>None</td>
        <td>None</td>
        <td>None</td>
        <td>None</td>
        <td>None</td>
        <td>YES</td>
        <td>NO</td>
        <td>None</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

UPDATE orders_v
SET order_status = lower(order_status)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
68883 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM orders LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_id</th>
        <th>order_date</th>
        <th>order_customer_id</th>
        <th>order_status</th>
    </tr>
    <tr>
        <td>122</td>
        <td>2013-07-26 00:00:00</td>
        <td>2071</td>
        <td>processing</td>
    </tr>
    <tr>
        <td>123</td>
        <td>2013-07-26 00:00:00</td>
        <td>3695</td>
        <td>pending_payment</td>
    </tr>
    <tr>
        <td>124</td>
        <td>2013-07-26 00:00:00</td>
        <td>2374</td>
        <td>complete</td>
    </tr>
    <tr>
        <td>125</td>
        <td>2013-07-26 00:00:00</td>
        <td>4611</td>
        <td>pending_payment</td>
    </tr>
    <tr>
        <td>126</td>
        <td>2013-07-26 00:00:00</td>
        <td>610</td>
        <td>complete</td>
    </tr>
    <tr>
        <td>127</td>
        <td>2013-07-26 00:00:00</td>
        <td>5261</td>
        <td>pending_payment</td>
    </tr>
    <tr>
        <td>128</td>
        <td>2013-07-26 00:00:00</td>
        <td>2772</td>
        <td>pending_payment</td>
    </tr>
    <tr>
        <td>129</td>
        <td>2013-07-26 00:00:00</td>
        <td>9937</td>
        <td>closed</td>
    </tr>
    <tr>
        <td>130</td>
        <td>2013-07-26 00:00:00</td>
        <td>7509</td>
        <td>pending_payment</td>
    </tr>
    <tr>
        <td>131</td>
        <td>2013-07-26 00:00:00</td>
        <td>10072</td>
        <td>processing</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

UPDATE orders_v
SET order_status = upper(order_status)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
68883 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE OR REPLACE VIEW order_details_v
AS
SELECT * FROM orders o
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM order_details_v LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_id</th>
        <th>order_date</th>
        <th>order_customer_id</th>
        <th>order_status</th>
        <th>order_item_id</th>
        <th>order_item_order_id</th>
        <th>order_item_product_id</th>
        <th>order_item_quantity</th>
        <th>order_item_subtotal</th>
        <th>order_item_product_price</th>
    </tr>
    <tr>
        <td>1</td>
        <td>2013-07-25 00:00:00</td>
        <td>11599</td>
        <td>CLOSED</td>
        <td>1</td>
        <td>1</td>
        <td>957</td>
        <td>1</td>
        <td>299.98</td>
        <td>299.98</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>2</td>
        <td>2</td>
        <td>1073</td>
        <td>1</td>
        <td>199.99</td>
        <td>199.99</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>3</td>
        <td>2</td>
        <td>502</td>
        <td>5</td>
        <td>250.0</td>
        <td>50.0</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>4</td>
        <td>2</td>
        <td>403</td>
        <td>1</td>
        <td>129.99</td>
        <td>129.99</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2013-07-25 00:00:00</td>
        <td>8827</td>
        <td>CLOSED</td>
        <td>5</td>
        <td>4</td>
        <td>897</td>
        <td>2</td>
        <td>49.98</td>
        <td>24.99</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2013-07-25 00:00:00</td>
        <td>8827</td>
        <td>CLOSED</td>
        <td>6</td>
        <td>4</td>
        <td>365</td>
        <td>5</td>
        <td>299.95</td>
        <td>59.99</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2013-07-25 00:00:00</td>
        <td>8827</td>
        <td>CLOSED</td>
        <td>7</td>
        <td>4</td>
        <td>502</td>
        <td>3</td>
        <td>150.0</td>
        <td>50.0</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2013-07-25 00:00:00</td>
        <td>8827</td>
        <td>CLOSED</td>
        <td>8</td>
        <td>4</td>
        <td>1014</td>
        <td>4</td>
        <td>199.92</td>
        <td>49.98</td>
    </tr>
    <tr>
        <td>5</td>
        <td>2013-07-25 00:00:00</td>
        <td>11318</td>
        <td>COMPLETE</td>
        <td>9</td>
        <td>5</td>
        <td>957</td>
        <td>1</td>
        <td>299.98</td>
        <td>299.98</td>
    </tr>
    <tr>
        <td>5</td>
        <td>2013-07-25 00:00:00</td>
        <td>11318</td>
        <td>COMPLETE</td>
        <td>10</td>
        <td>5</td>
        <td>365</td>
        <td>5</td>
        <td>299.95</td>
        <td>59.99</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM order_details_v
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>172198</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT order_date,
    order_item_product_id,
    round(sum(order_item_subtotal)::numeric, 2) AS revenue
FROM order_details_v 
GROUP BY order_date,
    order_item_product_id
ORDER BY order_date,
    revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>9599.36</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>8499.15</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>7558.74</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>6999.65</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>6397.44</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>5589.57</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>5100.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>2879.28</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM order_details_v
WHERE order_id = 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
3 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_id</th>
        <th>order_date</th>
        <th>order_customer_id</th>
        <th>order_status</th>
        <th>order_item_id</th>
        <th>order_item_order_id</th>
        <th>order_item_product_id</th>
        <th>order_item_quantity</th>
        <th>order_item_subtotal</th>
        <th>order_item_product_price</th>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>2</td>
        <td>2</td>
        <td>1073</td>
        <td>1</td>
        <td>199.99</td>
        <td>199.99</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>3</td>
        <td>2</td>
        <td>502</td>
        <td>5</td>
        <td>250.0</td>
        <td>50.0</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>4</td>
        <td>2</td>
        <td>403</td>
        <td>1</td>
        <td>129.99</td>
        <td>129.99</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We cannot directly update data in tables via views when the view is defined with joins. Even operations such as <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> or <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> etc will make views not updatable by default.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

UPDATE order_details_v
SET
    order_status = &#39;pending_payment&#39;
WHERE order_id = 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
(psycopg2.errors.ObjectNotInPrerequisiteState) cannot update view &quot;order_details_v&quot;
DETAIL:  Views that do not select from a single table or view are not automatically updatable.
HINT:  To enable updating the view, provide an INSTEAD OF UPDATE trigger or an unconditional ON UPDATE DO INSTEAD rule.

[SQL: UPDATE order_details_v SET order_status = &#39;pending_payment&#39;
WHERE order_id = 2]
(Background on this error at: http://sqlalche.me/e/13/e3q8)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="named-queries-using-with-clause">
<h2>Named Queries - Using WITH Clause<a class="headerlink" href="#named-queries-using-with-clause" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to use <code class="docutils literal notranslate"><span class="pre">WITH</span></code> clause to define a named query.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/g7kMZxWlwUQ?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>At times we might have to develop a large query in which same complex logic need to be used multiple times. The query can become cumbersome if you just define the same logic multiple times.</p></li>
<li><p>One of the way to mitigate that issue is by providing the name to the logic using WITH clause.</p></li>
<li><p>We can only use the names provided to named queries as part of the main query which follows the WITH clause.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case of frequently used complex and large query, we use named queries while defining the views. We will then use view for reporting purposes.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

WITH order_details_nq AS (
    SELECT * FROM orders o
        JOIN order_items oi
            on o.order_id = oi.order_item_order_id
) SELECT * FROM order_details_nq LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_id</th>
        <th>order_date</th>
        <th>order_customer_id</th>
        <th>order_status</th>
        <th>order_item_id</th>
        <th>order_item_order_id</th>
        <th>order_item_product_id</th>
        <th>order_item_quantity</th>
        <th>order_item_subtotal</th>
        <th>order_item_product_price</th>
    </tr>
    <tr>
        <td>1</td>
        <td>2013-07-25 00:00:00</td>
        <td>11599</td>
        <td>CLOSED</td>
        <td>1</td>
        <td>1</td>
        <td>957</td>
        <td>1</td>
        <td>299.98</td>
        <td>299.98</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>2</td>
        <td>2</td>
        <td>1073</td>
        <td>1</td>
        <td>199.99</td>
        <td>199.99</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>3</td>
        <td>2</td>
        <td>502</td>
        <td>5</td>
        <td>250.0</td>
        <td>50.0</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-07-25 00:00:00</td>
        <td>256</td>
        <td>PENDING_PAYMENT</td>
        <td>4</td>
        <td>2</td>
        <td>403</td>
        <td>1</td>
        <td>129.99</td>
        <td>129.99</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2013-07-25 00:00:00</td>
        <td>8827</td>
        <td>CLOSED</td>
        <td>5</td>
        <td>4</td>
        <td>897</td>
        <td>2</td>
        <td>49.98</td>
        <td>24.99</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2013-07-25 00:00:00</td>
        <td>8827</td>
        <td>CLOSED</td>
        <td>6</td>
        <td>4</td>
        <td>365</td>
        <td>5</td>
        <td>299.95</td>
        <td>59.99</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2013-07-25 00:00:00</td>
        <td>8827</td>
        <td>CLOSED</td>
        <td>7</td>
        <td>4</td>
        <td>502</td>
        <td>3</td>
        <td>150.0</td>
        <td>50.0</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2013-07-25 00:00:00</td>
        <td>8827</td>
        <td>CLOSED</td>
        <td>8</td>
        <td>4</td>
        <td>1014</td>
        <td>4</td>
        <td>199.92</td>
        <td>49.98</td>
    </tr>
    <tr>
        <td>5</td>
        <td>2013-07-25 00:00:00</td>
        <td>11318</td>
        <td>COMPLETE</td>
        <td>9</td>
        <td>5</td>
        <td>957</td>
        <td>1</td>
        <td>299.98</td>
        <td>299.98</td>
    </tr>
    <tr>
        <td>5</td>
        <td>2013-07-25 00:00:00</td>
        <td>11318</td>
        <td>COMPLETE</td>
        <td>10</td>
        <td>5</td>
        <td>365</td>
        <td>5</td>
        <td>299.95</td>
        <td>59.99</td>
    </tr>
</table></div></div>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>One cannot use the named queries apart from the query in which it is defined. Following query will fail.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM order_details_nq LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
(psycopg2.errors.UndefinedTable) relation &quot;order_details_nq&quot; does not exist
LINE 1: SELECT * FROM order_details_nq LIMIT 10
                      ^

[SQL: SELECT * FROM order_details_nq LIMIT 10]
(Background on this error at: http://sqlalche.me/e/13/f405)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

WITH order_details_nq AS (
    SELECT * FROM orders o
        JOIN order_items oi
            on o.order_id = oi.order_item_order_id
) SELECT order_date,
    order_item_product_id,
    round(sum(order_item_subtotal)::numeric, 2) AS revenue
FROM order_details_nq 
GROUP BY order_date,
    order_item_product_id
ORDER BY order_date,
    revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>9599.36</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>8499.15</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>7558.74</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>6999.65</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>6397.44</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>5589.57</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>5100.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>2879.28</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE OR REPLACE VIEW daily_product_revenue_v
AS
WITH order_details_nq AS (
    SELECT * FROM orders o
        JOIN order_items oi
            on o.order_id = oi.order_item_order_id
) SELECT order_date,
    order_item_product_id,
    round(sum(order_item_subtotal)::numeric, 2) AS revenue
FROM order_details_nq 
GROUP BY order_date,
    order_item_product_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM daily_product_revenue_v
ORDER BY order_date, revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>9599.36</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>8499.15</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>7558.74</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>6999.65</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>6397.44</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>5589.57</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>5100.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>2879.28</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
    </tr>
</table></div></div>
</div>
</div>
<div class="section" id="overview-of-sub-queries">
<h2>Overview of Sub Queries<a class="headerlink" href="#overview-of-sub-queries" title="Permalink to this headline">¶</a></h2>
<p>Let us understand details related to Sub Queries. We will also briefly discuss about nested sub queries.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/aiHFzFZIEZI?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>We can have queries in from clause and such queries are called as sub queries.</p></li>
<li><p>Sub queries are commonly used with queries using analytic functions to filter the data further. We will see details after going through analytic functions as part of this section.</p></li>
<li><p>It is mandatory to have alias for the sub query.</p></li>
<li><p>Sub queries can also be used in <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause with <code class="docutils literal notranslate"><span class="pre">IN</span></code> as well as <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code>. As part of the sub query we can have join like conditions between tables in <code class="docutils literal notranslate"><span class="pre">FROM</span></code> clause of the main query and sub query. Such queries are called as <strong>Nested Sub Queries</strong>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Simplest example for a subquery</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM (SELECT current_date) AS q
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>current_date</th>
    </tr>
    <tr>
        <td>2020-12-01</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Realistic example for a subquery. We will get into details related to this query after covering analytic functions</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM (
    SELECT nq.*,
        dense_rank() OVER (
            PARTITION BY order_date
            ORDER BY revenue DESC
        ) AS drnk
    FROM (
        SELECT o.order_date,
            oi.order_item_product_id,
            round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
        FROM orders o 
            JOIN order_items oi
                ON o.order_id = oi.order_item_order_id
        WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
        GROUP BY o.order_date, oi.order_item_product_id
    ) nq
) nq1
WHERE drnk &lt;= 5
ORDER BY order_date, revenue DESC
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>drnk</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1014</td>
        <td>4798.08</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>1004</td>
        <td>9599.52</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>191</td>
        <td>5999.40</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>957</td>
        <td>5699.62</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>1073</td>
        <td>5399.73</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>365</td>
        <td>5099.15</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>957</td>
        <td>5099.66</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>365</td>
        <td>4799.20</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>403</td>
        <td>4419.66</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>191</td>
        <td>4299.57</td>
        <td>5</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Multiple realistic examples for nested sub queries. You can see example with <code class="docutils literal notranslate"><span class="pre">IN</span></code> as well as <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> operators.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM order_items oi
WHERE oi.order_item_order_id 
    NOT IN (
        SELECT order_id FROM orders o
        WHERE o.order_id = oi.order_item_order_id
    )
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
0 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_item_id</th>
        <th>order_item_order_id</th>
        <th>order_item_product_id</th>
        <th>order_item_quantity</th>
        <th>order_item_subtotal</th>
        <th>order_item_product_price</th>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM order_items oi
WHERE oi.order_item_order_id 
    IN (
        SELECT order_id FROM orders o
        WHERE o.order_id = oi.order_item_order_id
    )
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>172198</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM order_items oi
WHERE NOT EXISTS (
        SELECT 1 FROM orders o
        WHERE o.order_id = oi.order_item_order_id
    )
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
0 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_item_id</th>
        <th>order_item_order_id</th>
        <th>order_item_product_id</th>
        <th>order_item_quantity</th>
        <th>order_item_subtotal</th>
        <th>order_item_product_price</th>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM order_items oi
WHERE EXISTS (
        SELECT 1 FROM orders o
        WHERE o.order_id = oi.order_item_order_id
    )
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_item_id</th>
        <th>order_item_order_id</th>
        <th>order_item_product_id</th>
        <th>order_item_quantity</th>
        <th>order_item_subtotal</th>
        <th>order_item_product_price</th>
    </tr>
    <tr>
        <td>1</td>
        <td>1</td>
        <td>957</td>
        <td>1</td>
        <td>299.98</td>
        <td>299.98</td>
    </tr>
    <tr>
        <td>2</td>
        <td>2</td>
        <td>1073</td>
        <td>1</td>
        <td>199.99</td>
        <td>199.99</td>
    </tr>
    <tr>
        <td>3</td>
        <td>2</td>
        <td>502</td>
        <td>5</td>
        <td>250.0</td>
        <td>50.0</td>
    </tr>
    <tr>
        <td>4</td>
        <td>2</td>
        <td>403</td>
        <td>1</td>
        <td>129.99</td>
        <td>129.99</td>
    </tr>
    <tr>
        <td>5</td>
        <td>4</td>
        <td>897</td>
        <td>2</td>
        <td>49.98</td>
        <td>24.99</td>
    </tr>
    <tr>
        <td>6</td>
        <td>4</td>
        <td>365</td>
        <td>5</td>
        <td>299.95</td>
        <td>59.99</td>
    </tr>
    <tr>
        <td>7</td>
        <td>4</td>
        <td>502</td>
        <td>3</td>
        <td>150.0</td>
        <td>50.0</td>
    </tr>
    <tr>
        <td>8</td>
        <td>4</td>
        <td>1014</td>
        <td>4</td>
        <td>199.92</td>
        <td>49.98</td>
    </tr>
    <tr>
        <td>9</td>
        <td>5</td>
        <td>957</td>
        <td>1</td>
        <td>299.98</td>
        <td>299.98</td>
    </tr>
    <tr>
        <td>10</td>
        <td>5</td>
        <td>365</td>
        <td>5</td>
        <td>299.95</td>
        <td>59.99</td>
    </tr>
</table></div></div>
</div>
</div>
<div class="section" id="ctas-create-table-as-select">
<h2>CTAS - Create Table as Select<a class="headerlink" href="#ctas-create-table-as-select" title="Permalink to this headline">¶</a></h2>
<p>Let us understand details related to CTAS or Create Table As Select.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/n4YoASApp1k?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>CTAS is primarily used to create tables based on query results.</p></li>
<li><p>Following are some of the use cases for which we typically use CTAS.</p>
<ul>
<li><p>Taking back up of tables for troubleshooting and debugging performance issues.</p></li>
<li><p>Reorganizing the tables for performance tuning.</p></li>
<li><p>Getting query results into a table for data analysis as well as checking data quality.</p></li>
</ul>
</li>
<li><p>We cannot specify column names and data types as part of <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> clause in CTAS. It will pick the column names from the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause.</p></li>
<li><p>It is a good practice to specify meaningful aliases as part of the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause for derived values.</p></li>
<li><p>Also it is a good practice to explicitly type cast to the desired data type for derived values.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS customers_backup
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE customers_backup
AS
SELECT * FROM customers
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
12435 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS orders_backup
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE orders_backup
AS
SELECT order_id,
    to_char(order_date, &#39;yyyy&#39;)::int AS order_year,
    to_char(order_date, &#39;MM&#39;)::int AS order_month,
    to_char(order_date, &#39;dd&#39;)::int AS order_day_of_month,
    to_char(order_date, &#39;DDD&#39;)::int AS order_day_of_year,
    order_customer_id,
    order_status
FROM orders
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
68883 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM orders_backup LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_id</th>
        <th>order_year</th>
        <th>order_month</th>
        <th>order_day_of_month</th>
        <th>order_day_of_year</th>
        <th>order_customer_id</th>
        <th>order_status</th>
    </tr>
    <tr>
        <td>1021</td>
        <td>2013</td>
        <td>7</td>
        <td>30</td>
        <td>211</td>
        <td>10118</td>
        <td>COMPLETE</td>
    </tr>
    <tr>
        <td>4068</td>
        <td>2013</td>
        <td>8</td>
        <td>17</td>
        <td>229</td>
        <td>12293</td>
        <td>PENDING</td>
    </tr>
    <tr>
        <td>5881</td>
        <td>2013</td>
        <td>8</td>
        <td>30</td>
        <td>242</td>
        <td>3715</td>
        <td>CLOSED</td>
    </tr>
    <tr>
        <td>7564</td>
        <td>2013</td>
        <td>9</td>
        <td>9</td>
        <td>252</td>
        <td>8648</td>
        <td>CLOSED</td>
    </tr>
    <tr>
        <td>8766</td>
        <td>2013</td>
        <td>9</td>
        <td>18</td>
        <td>261</td>
        <td>855</td>
        <td>COMPLETE</td>
    </tr>
    <tr>
        <td>8926</td>
        <td>2013</td>
        <td>9</td>
        <td>19</td>
        <td>262</td>
        <td>10517</td>
        <td>ON_HOLD</td>
    </tr>
    <tr>
        <td>9290</td>
        <td>2013</td>
        <td>9</td>
        <td>21</td>
        <td>264</td>
        <td>11879</td>
        <td>COMPLETE</td>
    </tr>
    <tr>
        <td>9793</td>
        <td>2013</td>
        <td>9</td>
        <td>24</td>
        <td>267</td>
        <td>9809</td>
        <td>COMPLETE</td>
    </tr>
    <tr>
        <td>9816</td>
        <td>2013</td>
        <td>9</td>
        <td>24</td>
        <td>267</td>
        <td>1753</td>
        <td>COMPLETE</td>
    </tr>
    <tr>
        <td>14047</td>
        <td>2013</td>
        <td>10</td>
        <td>20</td>
        <td>293</td>
        <td>6473</td>
        <td>CLOSED</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At times we have to create empty table with only structure of the table. We can specify always false condition such as <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">=</span> <span class="pre">2</span></code> as part of <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause using CTAS.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS order_items_empty
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE order_items_empty
AS
SELECT * FROM order_items WHERE 1 = 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
0 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM order_items_empty
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>0</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Keeping databases clean is very important. It is a good practice to clean up any temporary tables created for learning or troubleshooting issues.</p>
<p>In this case all the tables created using CTAS are dropped</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS customers_backup;
DROP TABLE IF EXISTS orders_backup;
DROP TABLE IF EXISTS order_items_empty;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
Done.
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="advanced-dml-operations">
<h2>Advanced DML Operations<a class="headerlink" href="#advanced-dml-operations" title="Permalink to this headline">¶</a></h2>
<p>As we gain enough knowledge related to writing queries, let us explore some advanced DML Operations.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/STEZ7KlfNuY?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>We can insert query results into a table using <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> with <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>.</p></li>
<li><p>As long as columns specified for table in <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> statement and columns projected in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause match, it works.</p></li>
<li><p>We can also use query results for <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> as well as <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creating customer order metrics table to demonstrate advanced DML Operations. We will also add primary key to this table. We will be storing number of orders placed and revenue generated for each customer in a given month.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS customer_order_metrics_mthly
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE customer_order_metrics_mthly (
    customer_id INT,
    order_month CHAR(7),
    order_count INT,
    order_revenue FLOAT
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE customer_order_metrics_mthly
    ADD PRIMARY KEY (order_month, customer_id)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is the query to get monthly customer orders metrics. First we will be inserting customer_id, order_month and order_count into the table.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the below query is run multiple times, every time data in both orders and order_items need to be processed. As the data volumes grow the query uses considerable amount of resources. It will be better if we can pre-aggregate the data.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_customer_id,
    to_char(o.order_date, &#39;yyyy-MM&#39;) AS order_month,
    count(1) AS order_count,
    round(sum(order_item_subtotal)::numeric, 2) AS order_revenue
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
GROUP BY o.order_customer_id,
    to_char(o.order_date, &#39;yyyy-MM&#39;)
ORDER BY order_month,
    order_count DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_customer_id</th>
        <th>order_month</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>4257</td>
        <td>2013-07</td>
        <td>10</td>
        <td>2059.75</td>
    </tr>
    <tr>
        <td>5293</td>
        <td>2013-07</td>
        <td>10</td>
        <td>2781.73</td>
    </tr>
    <tr>
        <td>9103</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1587.85</td>
    </tr>
    <tr>
        <td>7473</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1244.90</td>
    </tr>
    <tr>
        <td>2071</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1629.84</td>
    </tr>
    <tr>
        <td>32</td>
        <td>2013-07</td>
        <td>9</td>
        <td>2009.75</td>
    </tr>
    <tr>
        <td>488</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1365.82</td>
    </tr>
    <tr>
        <td>7073</td>
        <td>2013-07</td>
        <td>9</td>
        <td>1377.83</td>
    </tr>
    <tr>
        <td>8709</td>
        <td>2013-07</td>
        <td>8</td>
        <td>1349.87</td>
    </tr>
    <tr>
        <td>1498</td>
        <td>2013-07</td>
        <td>8</td>
        <td>1619.88</td>
    </tr>
</table></div></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Here are the number of records that need to be processed every time. Also it involves expensive join.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>172198</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us first insert the data into the table with out revenue. We will update the revenue later as an example for updating using query results.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO customer_order_metrics_mthly
SELECT o.order_customer_id,
    to_char(o.order_date, &#39;yyyy-MM&#39;) AS order_month,
    count(1) order_count,
    NULL
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
GROUP BY o.order_customer_id,
    to_char(o.order_date, &#39;yyyy-MM&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
48059 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM customer_order_metrics_mthly
ORDER BY order_month,
    customer_id
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>customer_id</th>
        <th>order_month</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>12</td>
        <td>2013-07</td>
        <td>2</td>
        <td>None</td>
    </tr>
    <tr>
        <td>16</td>
        <td>2013-07</td>
        <td>1</td>
        <td>None</td>
    </tr>
    <tr>
        <td>17</td>
        <td>2013-07</td>
        <td>2</td>
        <td>None</td>
    </tr>
    <tr>
        <td>19</td>
        <td>2013-07</td>
        <td>3</td>
        <td>None</td>
    </tr>
    <tr>
        <td>32</td>
        <td>2013-07</td>
        <td>9</td>
        <td>None</td>
    </tr>
    <tr>
        <td>45</td>
        <td>2013-07</td>
        <td>4</td>
        <td>None</td>
    </tr>
    <tr>
        <td>48</td>
        <td>2013-07</td>
        <td>4</td>
        <td>None</td>
    </tr>
    <tr>
        <td>54</td>
        <td>2013-07</td>
        <td>2</td>
        <td>None</td>
    </tr>
    <tr>
        <td>58</td>
        <td>2013-07</td>
        <td>4</td>
        <td>None</td>
    </tr>
    <tr>
        <td>64</td>
        <td>2013-07</td>
        <td>2</td>
        <td>None</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Updating order_revenue along with count. This is expensive operation, but we will be running only once.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

UPDATE customer_order_metrics_mthly comd
SET 
    (order_count, order_revenue) = (
        SELECT count(1),
            round(sum(order_item_subtotal)::numeric, 2)
        FROM orders o 
            JOIN order_items oi
                ON o.order_id = oi.order_item_order_id
        WHERE o.order_customer_id = comd.customer_id
            AND to_char(o.order_date, &#39;yyyy-MM&#39;) = comd.order_month
            AND to_char(o.order_date, &#39;yyyy-MM&#39;) = &#39;2013-08&#39;
            AND comd.order_month = &#39;2013-08&#39;
        GROUP BY o.order_customer_id,
            to_char(o.order_date, &#39;yyyy-MM&#39;)
    )
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.order_customer_id = comd.customer_id
        AND to_char(o.order_date, &#39;yyyy-MM&#39;) = comd.order_month
        AND to_char(o.order_date, &#39;yyyy-MM&#39;) = &#39;2013-08&#39;
) AND comd.order_month = &#39;2013-08&#39;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
3935 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As data is pre processed and loaded into the table, queries similar to below ones against <strong>customer_order_metrics_mthly</strong> will run much faster.</p>
<p>We need to process lesser amount of data with out expensive join.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM customer_order_metrics_mthly
WHERE order_month = &#39;2013-08&#39;
ORDER BY order_month,
    customer_id
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>customer_id</th>
        <th>order_month</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>2</td>
        <td>2013-08</td>
        <td>5</td>
        <td>769.82</td>
    </tr>
    <tr>
        <td>13</td>
        <td>2013-08</td>
        <td>5</td>
        <td>1065.93</td>
    </tr>
    <tr>
        <td>14</td>
        <td>2013-08</td>
        <td>3</td>
        <td>459.97</td>
    </tr>
    <tr>
        <td>18</td>
        <td>2013-08</td>
        <td>1</td>
        <td>129.99</td>
    </tr>
    <tr>
        <td>20</td>
        <td>2013-08</td>
        <td>2</td>
        <td>739.91</td>
    </tr>
    <tr>
        <td>22</td>
        <td>2013-08</td>
        <td>5</td>
        <td>769.96</td>
    </tr>
    <tr>
        <td>24</td>
        <td>2013-08</td>
        <td>2</td>
        <td>399.91</td>
    </tr>
    <tr>
        <td>25</td>
        <td>2013-08</td>
        <td>1</td>
        <td>129.99</td>
    </tr>
    <tr>
        <td>33</td>
        <td>2013-08</td>
        <td>3</td>
        <td>929.92</td>
    </tr>
    <tr>
        <td>34</td>
        <td>2013-08</td>
        <td>4</td>
        <td>789.92</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As an example for delete using query, we will delete all the dormant customers from <strong>customers</strong> table. Dormant customers are those customers who never placed any order. For this we will create back up customers table as I do not want to play with customers.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS customers_backup
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE customers_backup
AS
SELECT * FROM customers
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
12435 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM customers_backup c
    LEFT OUTER JOIN orders o
        ON c.customer_id = o.order_customer_id
WHERE o.order_customer_id IS NULL
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>30</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM customers_backup c
WHERE NOT EXISTS (
    SELECT 1 FROM orders o
    WHERE c.customer_id = o.order_customer_id
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>30</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We need to use nested sub queries as part of the delete with <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">EXISTS</span></code> or <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code> as demonstrated below. We cannot use direct joins as part of the <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DELETE FROM customers_backup c
WHERE NOT EXISTS (
    SELECT 1 FROM orders o
    WHERE c.customer_id = o.order_customer_id
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
30 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM customers_backup
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>count</th>
    </tr>
    <tr>
        <td>12405</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DELETE FROM customers_backup c
WHERE customer_id NOT IN (
    SELECT order_customer_id FROM orders o
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
0 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="merging-or-upserting-data">
<h2>Merging or Upserting Data<a class="headerlink" href="#merging-or-upserting-data" title="Permalink to this headline">¶</a></h2>
<p>At times we need to merge or upsert the data (update existing records and insert new records)</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/24N2OTRm560?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>One of the way to achieve merge or upsert is to develop 2 statements - one to update and other to insert.</p></li>
<li><p>The queries in both the statements (update and insert) should return mutually exclusive results.</p></li>
<li><p>Even though the statements can be executed in any order, updating first and then inserting perform better in most of the cases (as update have to deal with lesser number of records with this approach)</p></li>
<li><p>We can also take care of merge or upsert using <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> with <code class="docutils literal notranslate"><span class="pre">ON</span> <span class="pre">CONFLICT</span> <span class="pre">(columns)</span> <span class="pre">DO</span> <span class="pre">UPDATE</span></code>.</p></li>
<li><p>Postgres does not have either <code class="docutils literal notranslate"><span class="pre">MERGE</span></code> or <code class="docutils literal notranslate"><span class="pre">UPSERT</span></code> as part of the SQL syntax.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> DROP TABLE IF EXISTS customer_order_metrics_dly
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE customer_order_metrics_dly (
    customer_id INT,
    order_date DATE,
    order_count INT,
    order_revenue FLOAT
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE customer_order_metrics_dly
    ADD PRIMARY KEY (customer_id, order_date)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us go through the 2 statement approach. Here we are inserting data for the month of August 2013.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO customer_order_metrics_dly
SELECT o.order_customer_id,
    o.order_date,
    count(1) order_count,
    NULL
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
WHERE o.order_date BETWEEN &#39;2013-08-01&#39; AND &#39;2013-08-31&#39;
GROUP BY o.order_customer_id,
    o.order_date
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
4708 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Now we want to merge data into the table using 2013 August to 2013 October. As we are using 2 statement approach, first we should update and then we should insert</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

UPDATE customer_order_metrics_dly comd
SET 
    (order_count, order_revenue) = (
        SELECT count(1),
            round(sum(oi.order_item_subtotal)::numeric, 2)
        FROM orders o 
            JOIN order_items oi
                ON o.order_id = oi.order_item_order_id
        WHERE o.order_date BETWEEN &#39;2013-08-01&#39; AND &#39;2013-10-31&#39;
            AND o.order_customer_id = comd.customer_id
            AND o.order_date = comd.order_date
        GROUP BY o.order_customer_id,
            o.order_date
    )
WHERE comd.order_date BETWEEN &#39;2013-08-01&#39; AND &#39;2013-10-31&#39;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
4708 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM customer_order_metrics_dly
ORDER BY order_date, customer_id
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>customer_id</th>
        <th>order_date</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>34</td>
        <td>2013-08-01</td>
        <td>4</td>
        <td>789.92</td>
    </tr>
    <tr>
        <td>109</td>
        <td>2013-08-01</td>
        <td>3</td>
        <td>799.9</td>
    </tr>
    <tr>
        <td>174</td>
        <td>2013-08-01</td>
        <td>5</td>
        <td>654.89</td>
    </tr>
    <tr>
        <td>267</td>
        <td>2013-08-01</td>
        <td>4</td>
        <td>559.97</td>
    </tr>
    <tr>
        <td>478</td>
        <td>2013-08-01</td>
        <td>5</td>
        <td>729.9</td>
    </tr>
    <tr>
        <td>553</td>
        <td>2013-08-01</td>
        <td>2</td>
        <td>399.9</td>
    </tr>
    <tr>
        <td>692</td>
        <td>2013-08-01</td>
        <td>2</td>
        <td>479.92</td>
    </tr>
    <tr>
        <td>696</td>
        <td>2013-08-01</td>
        <td>2</td>
        <td>649.88</td>
    </tr>
    <tr>
        <td>800</td>
        <td>2013-08-01</td>
        <td>5</td>
        <td>609.95</td>
    </tr>
    <tr>
        <td>835</td>
        <td>2013-08-01</td>
        <td>5</td>
        <td>589.9</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT to_char(order_date, &#39;yyyy-MM&#39;), count(1) FROM customer_order_metrics_dly
GROUP BY to_char(order_date, &#39;yyyy-MM&#39;)
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>to_char</th>
        <th>count</th>
    </tr>
    <tr>
        <td>2013-08</td>
        <td>4708</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO customer_order_metrics_dly
SELECT o.order_customer_id AS customer_id,
    o.order_date,
    count(1) order_count,
    round(sum(order_item_subtotal)::numeric, 2)
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
WHERE o.order_date BETWEEN &#39;2013-08-01&#39; AND &#39;2013-10-31&#39;
    AND NOT EXISTS (
        SELECT 1 FROM customer_order_metrics_dly codm
        WHERE o.order_customer_id = codm.customer_id
            AND o.order_date = codm.order_date
    )
GROUP BY o.order_customer_id,
    o.order_date
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
9265 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM customer_order_metrics_dly
WHERE order_date::varchar ~ &#39;2013-09&#39;
ORDER BY order_date, customer_id
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>customer_id</th>
        <th>order_date</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>19</td>
        <td>2013-09-01</td>
        <td>5</td>
        <td>839.92</td>
    </tr>
    <tr>
        <td>95</td>
        <td>2013-09-01</td>
        <td>5</td>
        <td>969.85</td>
    </tr>
    <tr>
        <td>136</td>
        <td>2013-09-01</td>
        <td>4</td>
        <td>639.94</td>
    </tr>
    <tr>
        <td>247</td>
        <td>2013-09-01</td>
        <td>2</td>
        <td>639.94</td>
    </tr>
    <tr>
        <td>383</td>
        <td>2013-09-01</td>
        <td>5</td>
        <td>729.9</td>
    </tr>
    <tr>
        <td>437</td>
        <td>2013-09-01</td>
        <td>4</td>
        <td>829.97</td>
    </tr>
    <tr>
        <td>543</td>
        <td>2013-09-01</td>
        <td>4</td>
        <td>1489.83</td>
    </tr>
    <tr>
        <td>601</td>
        <td>2013-09-01</td>
        <td>2</td>
        <td>159.99</td>
    </tr>
    <tr>
        <td>689</td>
        <td>2013-09-01</td>
        <td>2</td>
        <td>419.96</td>
    </tr>
    <tr>
        <td>842</td>
        <td>2013-09-01</td>
        <td>4</td>
        <td>954.87</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT to_char(order_date, &#39;yyyy-MM&#39;), count(1) FROM customer_order_metrics_dly
GROUP BY to_char(order_date, &#39;yyyy-MM&#39;)
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
3 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>to_char</th>
        <th>count</th>
    </tr>
    <tr>
        <td>2013-08</td>
        <td>4708</td>
    </tr>
    <tr>
        <td>2013-10</td>
        <td>4417</td>
    </tr>
    <tr>
        <td>2013-09</td>
        <td>4848</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us see how we can upsert or merge the data using <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> with <code class="docutils literal notranslate"><span class="pre">ON</span> <span class="pre">CONFLICT</span> <span class="pre">(columns)</span> <span class="pre">DO</span> <span class="pre">UPDATE</span></code>. We will first insert data for the month of August 2013 and then upsert or merge for the months of August 2013 to October 2013.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> TRUNCATE TABLE customer_order_metrics_dly
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO customer_order_metrics_dly
SELECT o.order_customer_id,
    o.order_date,
    count(1) order_count,
    NULL
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
WHERE o.order_date BETWEEN &#39;2013-08-01&#39; AND &#39;2013-08-31&#39;
GROUP BY o.order_customer_id,
    o.order_date
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
4708 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We need to have unique or primary key constraint on the columns specified as part of <code class="docutils literal notranslate"><span class="pre">ON</span> <span class="pre">CONFLICT</span></code> clause.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE customer_order_metrics_dly DROP CONSTRAINT customer_order_metrics_dly_pkey
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE customer_order_metrics_dly
    ADD PRIMARY KEY (customer_id, order_date)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

INSERT INTO customer_order_metrics_dly
SELECT o.order_customer_id,
    o.order_date,
    count(1) order_count,
    round(sum(order_item_subtotal)::numeric, 2) AS order_revenue
FROM orders o 
    JOIN order_items oi
        ON o.order_id = oi.order_item_order_id
WHERE o.order_date BETWEEN &#39;2013-08-01&#39; AND &#39;2013-10-31&#39;
GROUP BY o.order_customer_id,
    o.order_date
ON CONFLICT (customer_id, order_date) DO UPDATE SET
    order_count = EXCLUDED.order_count,
    order_revenue = EXCLUDED.order_revenue
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
13973 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM customer_order_metrics_dly
WHERE order_date::varchar ~ &#39;2013-09&#39;
ORDER BY order_date, customer_id
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>customer_id</th>
        <th>order_date</th>
        <th>order_count</th>
        <th>order_revenue</th>
    </tr>
    <tr>
        <td>19</td>
        <td>2013-09-01</td>
        <td>5</td>
        <td>839.92</td>
    </tr>
    <tr>
        <td>95</td>
        <td>2013-09-01</td>
        <td>5</td>
        <td>969.85</td>
    </tr>
    <tr>
        <td>136</td>
        <td>2013-09-01</td>
        <td>4</td>
        <td>639.94</td>
    </tr>
    <tr>
        <td>247</td>
        <td>2013-09-01</td>
        <td>2</td>
        <td>639.94</td>
    </tr>
    <tr>
        <td>383</td>
        <td>2013-09-01</td>
        <td>5</td>
        <td>729.9</td>
    </tr>
    <tr>
        <td>437</td>
        <td>2013-09-01</td>
        <td>4</td>
        <td>829.97</td>
    </tr>
    <tr>
        <td>543</td>
        <td>2013-09-01</td>
        <td>4</td>
        <td>1489.83</td>
    </tr>
    <tr>
        <td>601</td>
        <td>2013-09-01</td>
        <td>2</td>
        <td>159.99</td>
    </tr>
    <tr>
        <td>689</td>
        <td>2013-09-01</td>
        <td>2</td>
        <td>419.96</td>
    </tr>
    <tr>
        <td>842</td>
        <td>2013-09-01</td>
        <td>4</td>
        <td>954.87</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT to_char(order_date, &#39;yyyy-MM&#39;), count(1) FROM customer_order_metrics_dly
GROUP BY to_char(order_date, &#39;yyyy-MM&#39;)
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
3 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>to_char</th>
        <th>count</th>
    </tr>
    <tr>
        <td>2013-08</td>
        <td>4708</td>
    </tr>
    <tr>
        <td>2013-10</td>
        <td>4417</td>
    </tr>
    <tr>
        <td>2013-09</td>
        <td>4848</td>
    </tr>
</table></div></div>
</div>
</div>
<div class="section" id="pivoting-rows-into-columns">
<h2>Pivoting Rows into Columns<a class="headerlink" href="#pivoting-rows-into-columns" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can pivot rows into columns in Postgres.</p>
<ul class="simple">
<li><p>Actual results</p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>order_date</p></th>
<th class="head"><p>order_status</p></th>
<th class="head"><p>count</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2013-07-25 00:00:00</p></td>
<td><p>CANCELED</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-25 00:00:00</p></td>
<td><p>CLOSED</p></td>
<td><p>20</p></td>
</tr>
<tr class="row-even"><td><p>2013-07-25 00:00:00</p></td>
<td><p>COMPLETE</p></td>
<td><p>42</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-25 00:00:00</p></td>
<td><p>ON_HOLD</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>2013-07-25 00:00:00</p></td>
<td><p>PAYMENT_REVIEW</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-25 00:00:00</p></td>
<td><p>PENDING</p></td>
<td><p>13</p></td>
</tr>
<tr class="row-even"><td><p>2013-07-25 00:00:00</p></td>
<td><p>PENDING_PAYMENT</p></td>
<td><p>41</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-25 00:00:00</p></td>
<td><p>PROCESSING</p></td>
<td><p>16</p></td>
</tr>
<tr class="row-even"><td><p>2013-07-25 00:00:00</p></td>
<td><p>SUSPECTED_FRAUD</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-26 00:00:00</p></td>
<td><p>CANCELED</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>2013-07-26 00:00:00</p></td>
<td><p>CLOSED</p></td>
<td><p>29</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-26 00:00:00</p></td>
<td><p>COMPLETE</p></td>
<td><p>87</p></td>
</tr>
<tr class="row-even"><td><p>2013-07-26 00:00:00</p></td>
<td><p>ON_HOLD</p></td>
<td><p>19</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-26 00:00:00</p></td>
<td><p>PAYMENT_REVIEW</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-even"><td><p>2013-07-26 00:00:00</p></td>
<td><p>PENDING</p></td>
<td><p>31</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-26 00:00:00</p></td>
<td><p>PENDING_PAYMENT</p></td>
<td><p>59</p></td>
</tr>
<tr class="row-even"><td><p>2013-07-26 00:00:00</p></td>
<td><p>PROCESSING</p></td>
<td><p>30</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-26 00:00:00</p></td>
<td><p>SUSPECTED_FRAUD</p></td>
<td><p>5</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>Pivoted results</p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>order_date</p></th>
<th class="head"><p>CANCELED</p></th>
<th class="head"><p>CLOSED</p></th>
<th class="head"><p>COMPLETE</p></th>
<th class="head"><p>ON_HOLD</p></th>
<th class="head"><p>PAYMENT_REVIEW</p></th>
<th class="head"><p>PENDING</p></th>
<th class="head"><p>PENDING_PAYMENT</p></th>
<th class="head"><p>PROCESSING</p></th>
<th class="head"><p>SUSPECTED_FRAUD</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2013-07-25</p></td>
<td><p>1</p></td>
<td><p>20</p></td>
<td><p>42</p></td>
<td><p>5</p></td>
<td><p>3</p></td>
<td><p>13</p></td>
<td><p>41</p></td>
<td><p>16</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>2013-07-26</p></td>
<td><p>3</p></td>
<td><p>29</p></td>
<td><p>87</p></td>
<td><p>19</p></td>
<td><p>6</p></td>
<td><p>31</p></td>
<td><p>59</p></td>
<td><p>30</p></td>
<td><p>5</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>We need to use <code class="docutils literal notranslate"><span class="pre">crosstab</span></code> as part of <code class="docutils literal notranslate"><span class="pre">FROM</span></code> clause to pivot the data. We need to pass the main query to <code class="docutils literal notranslate"><span class="pre">crosstab</span></code> function.</p></li>
<li><p>We need to install <code class="docutils literal notranslate"><span class="pre">tablefunc</span></code> as Postgres superuser to expose functions like crosstab - <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">EXTENSION</span> <span class="pre">tablefunc;</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are using environment provided by us, you don’t need to install <code class="docutils literal notranslate"><span class="pre">tablefunc</span></code>. If you are using your own environment run this command by logging in as superuser into postgres server to install <code class="docutils literal notranslate"><span class="pre">tablefunc</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">EXTENSION</span> <span class="pre">tablefunc;</span></code></p>
<p>However, in some cases you might have to run scripts in postgres. Follow official instructions by searching around.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT order_date,
    order_status,
    count(1)
FROM orders
GROUP BY order_date,
    order_status
ORDER BY order_date,
    order_status
LIMIT 18
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM crosstab(
    &#39;SELECT order_date,
        order_status,
        count(1) AS order_count
    FROM orders
    GROUP BY order_date,
        order_status&#39;,
    &#39;SELECT DISTINCT order_status FROM orders ORDER BY 1&#39;
) AS (
    order_date DATE,
    &quot;CANCELED&quot; INT,
    &quot;CLOSED&quot; INT,
    &quot;COMPLETE&quot; INT,
    &quot;ON_HOLD&quot; INT,
    &quot;PAYMENT_REVIEW&quot; INT,
    &quot;PENDING&quot; INT,
    &quot;PENDING_PAYMENT&quot; INT,
    &quot;PROCESSING&quot; INT,
    &quot;SUSPECTED_FRAUD&quot; INT
)
LIMIT 10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="overview-of-analytic-functions">
<h2>Overview of Analytic Functions<a class="headerlink" href="#overview-of-analytic-functions" title="Permalink to this headline">¶</a></h2>
<p>Let us get an overview of Analytics or Windowing Functions as part of <strong>SQL</strong>.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/QCbSM0tcFrc?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>Aggregate Functions (<code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code>, <code class="docutils literal notranslate"><span class="pre">avg</span></code>)</p></li>
<li><p>Window Functions (<code class="docutils literal notranslate"><span class="pre">lead</span></code>, <code class="docutils literal notranslate"><span class="pre">lag</span></code>, <code class="docutils literal notranslate"><span class="pre">first_value</span></code>, <code class="docutils literal notranslate"><span class="pre">last_value</span></code>)</p></li>
<li><p>Rank Functions (<code class="docutils literal notranslate"><span class="pre">rank</span></code>, <code class="docutils literal notranslate"><span class="pre">dense_rank</span></code>, <code class="docutils literal notranslate"><span class="pre">row_number</span></code> etc)</p></li>
<li><p>For all the functions when used as part of Analytic or Windowing functions we use <code class="docutils literal notranslate"><span class="pre">OVER</span></code> clause.</p></li>
<li><p>For aggregate functions we typically use <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span></code></p></li>
<li><p>For global ranking and windowing functions we can use <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">sort_column</span></code> and for ranking and windowing with in a partition or group we can use <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">partition_column</span> <span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">sort_column</span></code>.</p></li>
<li><p>Here is how the syntax will look like.</p>
<ul>
<li><p>Aggregate - <code class="docutils literal notranslate"><span class="pre">func()</span> <span class="pre">OVER</span> <span class="pre">(PARTITION</span> <span class="pre">BY</span> <span class="pre">partition_column)</span></code></p></li>
<li><p>Global Rank - <code class="docutils literal notranslate"><span class="pre">func()</span> <span class="pre">OVER</span> <span class="pre">(ORDER</span> <span class="pre">BY</span> <span class="pre">sort_column</span> <span class="pre">DESC)</span></code></p></li>
<li><p>Rank in a partition - <code class="docutils literal notranslate"><span class="pre">func()</span> <span class="pre">OVER</span> <span class="pre">(PARTITION</span> <span class="pre">BY</span> <span class="pre">partition_column</span> <span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">sort_column</span> <span class="pre">DESC)</span></code></p></li>
</ul>
</li>
<li><p>We can also get cumulative or moving metrics by adding <code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span></code> clause. We will see details later.</p></li>
</ul>
<div class="section" id="prepare-tables">
<h3>Prepare Tables<a class="headerlink" href="#prepare-tables" title="Permalink to this headline">¶</a></h3>
<p>Let us create couple of tables which will be used for the demonstrations of Windowing and Ranking functions.</p>
<ul class="simple">
<li><p>We have <strong>ORDERS</strong> and <strong>ORDER_ITEMS</strong> tables in our retail database.</p></li>
<li><p>Let us take care of computing daily revenue as well as daily product revenue.</p></li>
<li><p>As we will be using same data set several times, let us create the tables to pre compute the data.</p></li>
<li><p><strong>daily_revenue</strong> will have the <strong>order_date</strong> and <strong>revenue</strong>, where data is aggregated using <strong>order_date</strong> as partition key.</p></li>
<li><p><strong>daily_product_revenue</strong> will have <strong>order_date</strong>, <strong>order_item_product_id</strong> and <strong>revenue</strong>. In this case data is aggregated using <strong>order_date</strong> and <strong>order_item_product_id</strong> as partition keys.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us create table using CTAS to save daily revenue.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS daily_revenue
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE daily_revenue
AS
SELECT o.order_date,
    round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
364 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM daily_revenue
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us create table using CTAS to save daily product revenue.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP TABLE IF EXISTS daily_product_revenue
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE TABLE daily_product_revenue
AS
SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date, oi.order_item_product_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
9120 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM daily_product_revenue
ORDER BY order_date, revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
    </tr>
</table></div></div>
</div>
</div>
</div>
<div class="section" id="analytic-functions-aggregations">
<h2>Analytic Functions – Aggregations<a class="headerlink" href="#analytic-functions-aggregations" title="Permalink to this headline">¶</a></h2>
<p>Let us see how we can perform aggregations with in a partition or group using Windowing/Analytics Functions.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZrOXdVk-d0s?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>For simple aggregations where we have to get grouping key and aggregated results we can use <strong>GROUP BY</strong>.</p></li>
<li><p>If we want to get the raw data along with aggregated results, then using <strong>GROUP BY</strong> is not possible or overly complicated.</p></li>
<li><p>Using aggregate functions with <strong>OVER</strong> Clause not only simplifies the process of writing query, but also better with respect to performance.</p></li>
<li><p>Let us take an example of getting employee salary percentage when compared to department salary expense.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are using Jupyter based environment make sure to restart the kernel, as the session might have been already connected with retail database.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT employee_id, department_id, salary 
FROM employees 
ORDER BY department_id, salary
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us write the query using <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> approach.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT department_id,
    sum(salary) AS department_salary_expense
FROM employees
GROUP BY department_id
ORDER BY department_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
12 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>department_id</th>
        <th>department_salary_expense</th>
    </tr>
    <tr>
        <td>10</td>
        <td>4400.00</td>
    </tr>
    <tr>
        <td>20</td>
        <td>19000.00</td>
    </tr>
    <tr>
        <td>30</td>
        <td>24900.00</td>
    </tr>
    <tr>
        <td>40</td>
        <td>6500.00</td>
    </tr>
    <tr>
        <td>50</td>
        <td>156400.00</td>
    </tr>
    <tr>
        <td>60</td>
        <td>28800.00</td>
    </tr>
    <tr>
        <td>70</td>
        <td>10000.00</td>
    </tr>
    <tr>
        <td>80</td>
        <td>304500.00</td>
    </tr>
    <tr>
        <td>90</td>
        <td>58000.00</td>
    </tr>
    <tr>
        <td>100</td>
        <td>51600.00</td>
    </tr>
    <tr>
        <td>110</td>
        <td>20300.00</td>
    </tr>
    <tr>
        <td>None</td>
        <td>7000.00</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT e.employee_id, e.department_id, e.salary,
    ae.department_salary_expense,
    ae.avg_salary_expense
FROM employees e JOIN (
    SELECT department_id, 
        sum(salary) AS department_salary_expense,
        round(avg(salary)::numeric, 2) AS avg_salary_expense
    FROM employees
    GROUP BY department_id
) ae
ON e.department_id = ae.department_id
ORDER BY department_id, salary
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>department_salary_expense</th>
        <th>avg_salary_expense</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>4400.00</td>
        <td>4400.00</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>19000.00</td>
        <td>9500.00</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>19000.00</td>
        <td>9500.00</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>6500.00</td>
        <td>6500.00</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT e.employee_id, e.department_id, e.salary,
    ae.department_salary_expense,
    ae.avg_salary_expense,
    round(e.salary/ae.department_salary_expense * 100, 2) pct_salary
FROM employees e JOIN (
    SELECT department_id, 
        sum(salary) AS department_salary_expense,
        round(avg(salary)::numeric, 2) AS avg_salary_expense
    FROM employees
    GROUP BY department_id
) ae
ON e.department_id = ae.department_id
ORDER BY department_id, salary
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>department_salary_expense</th>
        <th>avg_salary_expense</th>
        <th>pct_salary</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>4400.00</td>
        <td>4400.00</td>
        <td>100.00</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>19000.00</td>
        <td>9500.00</td>
        <td>31.58</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>19000.00</td>
        <td>9500.00</td>
        <td>68.42</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>10.04</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>10.44</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>11.24</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>11.65</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>12.45</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>44.18</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>6500.00</td>
        <td>6500.00</td>
        <td>100.00</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us see how we can get it using Analytics/Windowing Functions.</p>
</div>
<ul class="simple">
<li><p>We can use all standard aggregate functions such as <code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code>, <code class="docutils literal notranslate"><span class="pre">avg</span></code> etc.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT e.employee_id, e.department_id, e.salary,
    sum(e.salary) OVER (
        PARTITION BY e.department_id
    ) AS department_salary_expense
FROM employees e
ORDER BY e.department_id
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>department_salary_expense</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>4400.00</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>19000.00</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>19000.00</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>24900.00</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>24900.00</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>24900.00</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>24900.00</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>24900.00</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>24900.00</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>6500.00</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT e.employee_id, e.department_id, e.salary,
    sum(e.salary) OVER (
        PARTITION BY e.department_id
    ) AS department_salary_expense,
    round(e.salary / sum(e.salary) OVER (
        PARTITION BY e.department_id
    ) * 100, 2) AS pct_salary
FROM employees e
ORDER BY e.department_id,
    e.salary
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>department_salary_expense</th>
        <th>pct_salary</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>4400.00</td>
        <td>100.00</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>19000.00</td>
        <td>31.58</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>19000.00</td>
        <td>68.42</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>24900.00</td>
        <td>10.04</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>24900.00</td>
        <td>10.44</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>24900.00</td>
        <td>11.24</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>24900.00</td>
        <td>11.65</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>24900.00</td>
        <td>12.45</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>24900.00</td>
        <td>44.18</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>6500.00</td>
        <td>100.00</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT e.employee_id, e.department_id, e.salary,
    sum(e.salary) OVER (
        PARTITION BY e.department_id
    ) AS sum_sal_expense,
    round(avg(e.salary) OVER (
        PARTITION BY e.department_id
    ), 2) AS avg_sal_expense,
    min(e.salary) OVER (
        PARTITION BY e.department_id
    ) AS min_sal_expense,
    max(e.salary) OVER (
        PARTITION BY e.department_id
    ) AS max_sal_expense,
    count(e.salary) OVER (
        PARTITION BY e.department_id
    ) AS cnt_sal_expense
FROM employees e
ORDER BY e.department_id,
    e.salary
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>sum_sal_expense</th>
        <th>avg_sal_expense</th>
        <th>min_sal_expense</th>
        <th>max_sal_expense</th>
        <th>cnt_sal_expense</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>4400.00</td>
        <td>4400.00</td>
        <td>4400.00</td>
        <td>4400.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>19000.00</td>
        <td>9500.00</td>
        <td>6000.00</td>
        <td>13000.00</td>
        <td>2</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>19000.00</td>
        <td>9500.00</td>
        <td>6000.00</td>
        <td>13000.00</td>
        <td>2</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>2500.00</td>
        <td>11000.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>2500.00</td>
        <td>11000.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>2500.00</td>
        <td>11000.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>2500.00</td>
        <td>11000.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>2500.00</td>
        <td>11000.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>24900.00</td>
        <td>4150.00</td>
        <td>2500.00</td>
        <td>11000.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>6500.00</td>
        <td>6500.00</td>
        <td>6500.00</td>
        <td>6500.00</td>
        <td>1</td>
    </tr>
</table></div></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are using Jupyter based environment make sure to restart the kernel, as the session might have been already connected with hr database.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT
    order_date,
    order_item_product_id,
    revenue,
    sum(revenue) OVER (PARTITION BY order_date) AS sum_revenue,
    min(revenue) OVER (PARTITION BY order_date) AS min_revenue,
    max(revenue) OVER (PARTITION BY order_date) AS max_revenue
FROM daily_product_revenue
ORDER BY order_date,
    revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>sum_revenue</th>
        <th>min_revenue</th>
        <th>max_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
        <td>31547.23</td>
        <td>49.98</td>
        <td>5599.72</td>
    </tr>
</table></div></div>
</div>
</div>
<div class="section" id="cumulative-or-moving-aggregations">
<h2>Cumulative or Moving Aggregations<a class="headerlink" href="#cumulative-or-moving-aggregations" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can take care of cumulative or moving aggregations using Analytic Functions.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/OrUUippbNqw?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>When it comes to Windowing or Analytic Functions we can also specify window spec using <code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span></code> clause.</p></li>
<li><p>Even when we do not specify window spec, the default window spec is used. For most of the functions the default window spec is <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span> <span class="pre">AND</span> <span class="pre">UNBOUNDED</span> <span class="pre">FOLLOWING</span></code>. You also have special clauses such as <code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code>.</p></li>
<li><p>Here are some of the examples with respect to <code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span></code>.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span> <span class="pre">AND</span> <span class="pre">UNBOUNDED</span> <span class="pre">FOLLOWING</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span> <span class="pre">AND</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span> <span class="pre">AND</span> <span class="pre">UNBOUNDED</span> <span class="pre">FOLLOWING</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">3</span> <span class="pre">PRECEDING</span> <span class="pre">AND</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span></code> - moving aggregations using current record and previous 3 records.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span> <span class="pre">AND</span> <span class="pre">3</span> <span class="pre">FOLLOWING</span></code> - moving aggregations using current record and following 3 records.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">3</span> <span class="pre">PRECEDING</span> <span class="pre">AND</span> <span class="pre">3</span> <span class="pre">FOLLOWING</span></code> - moving aggregations based up on 7 records (current record, 3 previous records and 3 following records)</p></li>
</ul>
</li>
<li><p>We can leverage <code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span></code> for cumulative aggregations or moving aggregations.</p></li>
<li><p>Here is an example of cumulative sum.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are using Jupyter based environment make sure to restart the kernel, as the session might have been already connected with retail database.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even though it is not mandatory to specify <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> as per syntax for cumulative aggregations, it is a must to specify. If not, you will end up getting incorrect results.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT e.employee_id, e.department_id, e.salary,
    sum(e.salary) OVER (
        PARTITION BY e.department_id
        ORDER BY e.salary
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS sum_sal_expense
FROM employees e
ORDER BY e.department_id, e.salary DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>sum_sal_expense</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>4400.00</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>19000.00</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>6000.00</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>24900.00</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>13900.00</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>10800.00</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>7900.00</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>5100.00</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>2500.00</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>6500.00</td>
    </tr>
</table></div></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are using Jupyter based environment make sure to restart the kernel, as the session might have been already connected with hr database.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is the example for cumulative sum for every month using daily_product_revenue in retail database.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    round(sum(t.revenue) OVER (
        PARTITION BY to_char(order_date, &#39;yyyy-MM&#39;)
        ORDER BY order_date
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ), 2) AS cumulative_daily_revenue
FROM daily_revenue t
ORDER BY to_char(order_date, &#39;yyyy-MM&#39;),
    order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
        <th>cumulative_daily_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
        <td>31547.23</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
        <td>86260.46</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
        <td>134671.94</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
        <td>170343.97</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
        <td>224923.67</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
        <td>274252.96</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
        <td>333465.45</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
        <td>49160.08</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
        <td>99848.66</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
        <td>143265.40</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here are examples for 3 day moving sum as well as average using daily_revenue in retail database.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    round(sum(t.revenue) OVER (
        ORDER BY order_date
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ), 2) AS moving_3day_revenue
FROM daily_revenue t
ORDER BY order_date
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
        <th>moving_3day_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
        <td>31547.23</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
        <td>86260.46</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
        <td>134671.94</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
        <td>138796.74</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
        <td>138663.21</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
        <td>139581.02</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
        <td>163121.48</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
        <td>157701.86</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
        <td>159061.15</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
        <td>143265.40</td>
    </tr>
    <tr>
        <td>2013-08-04 00:00:00</td>
        <td>35093.01</td>
        <td>129198.33</td>
    </tr>
    <tr>
        <td>2013-08-05 00:00:00</td>
        <td>34025.27</td>
        <td>112535.02</td>
    </tr>
    <tr>
        <td>2013-08-06 00:00:00</td>
        <td>57843.89</td>
        <td>126962.17</td>
    </tr>
    <tr>
        <td>2013-08-07 00:00:00</td>
        <td>45525.59</td>
        <td>137394.75</td>
    </tr>
    <tr>
        <td>2013-08-08 00:00:00</td>
        <td>33549.47</td>
        <td>136918.95</td>
    </tr>
    <tr>
        <td>2013-08-09 00:00:00</td>
        <td>29225.16</td>
        <td>108300.22</td>
    </tr>
    <tr>
        <td>2013-08-10 00:00:00</td>
        <td>46435.04</td>
        <td>109209.67</td>
    </tr>
    <tr>
        <td>2013-08-11 00:00:00</td>
        <td>31155.50</td>
        <td>106815.70</td>
    </tr>
    <tr>
        <td>2013-08-12 00:00:00</td>
        <td>59014.74</td>
        <td>136605.28</td>
    </tr>
    <tr>
        <td>2013-08-13 00:00:00</td>
        <td>17956.88</td>
        <td>108127.12</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    round(sum(t.revenue) OVER (
        ORDER BY order_date
        ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING
    ), 2) AS moving_3day_revenue
FROM daily_revenue t
ORDER BY order_date
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
        <th>moving_3day_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
        <td>134671.94</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
        <td>170343.97</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
        <td>224923.67</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
        <td>242705.73</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
        <td>247204.99</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
        <td>247953.59</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
        <td>262970.14</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
        <td>251807.18</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
        <td>237570.90</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
        <td>212383.68</td>
    </tr>
    <tr>
        <td>2013-08-04 00:00:00</td>
        <td>35093.01</td>
        <td>221067.49</td>
    </tr>
    <tr>
        <td>2013-08-05 00:00:00</td>
        <td>34025.27</td>
        <td>215904.50</td>
    </tr>
    <tr>
        <td>2013-08-06 00:00:00</td>
        <td>57843.89</td>
        <td>206037.23</td>
    </tr>
    <tr>
        <td>2013-08-07 00:00:00</td>
        <td>45525.59</td>
        <td>200169.38</td>
    </tr>
    <tr>
        <td>2013-08-08 00:00:00</td>
        <td>33549.47</td>
        <td>212579.15</td>
    </tr>
    <tr>
        <td>2013-08-09 00:00:00</td>
        <td>29225.16</td>
        <td>185890.76</td>
    </tr>
    <tr>
        <td>2013-08-10 00:00:00</td>
        <td>46435.04</td>
        <td>199379.91</td>
    </tr>
    <tr>
        <td>2013-08-11 00:00:00</td>
        <td>31155.50</td>
        <td>183787.32</td>
    </tr>
    <tr>
        <td>2013-08-12 00:00:00</td>
        <td>59014.74</td>
        <td>196605.61</td>
    </tr>
    <tr>
        <td>2013-08-13 00:00:00</td>
        <td>17956.88</td>
        <td>199737.25</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    round(avg(t.revenue) OVER (
        ORDER BY order_date
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ), 2) AS moving_3day_revenue
FROM daily_revenue t
ORDER BY order_date
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
        <th>moving_3day_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
        <td>31547.23</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
        <td>43130.23</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
        <td>44890.65</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
        <td>46265.58</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
        <td>46221.07</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
        <td>46527.01</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
        <td>54373.83</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
        <td>52567.29</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
        <td>53020.38</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
        <td>47755.13</td>
    </tr>
    <tr>
        <td>2013-08-04 00:00:00</td>
        <td>35093.01</td>
        <td>43066.11</td>
    </tr>
    <tr>
        <td>2013-08-05 00:00:00</td>
        <td>34025.27</td>
        <td>37511.67</td>
    </tr>
    <tr>
        <td>2013-08-06 00:00:00</td>
        <td>57843.89</td>
        <td>42320.72</td>
    </tr>
    <tr>
        <td>2013-08-07 00:00:00</td>
        <td>45525.59</td>
        <td>45798.25</td>
    </tr>
    <tr>
        <td>2013-08-08 00:00:00</td>
        <td>33549.47</td>
        <td>45639.65</td>
    </tr>
    <tr>
        <td>2013-08-09 00:00:00</td>
        <td>29225.16</td>
        <td>36100.07</td>
    </tr>
    <tr>
        <td>2013-08-10 00:00:00</td>
        <td>46435.04</td>
        <td>36403.22</td>
    </tr>
    <tr>
        <td>2013-08-11 00:00:00</td>
        <td>31155.50</td>
        <td>35605.23</td>
    </tr>
    <tr>
        <td>2013-08-12 00:00:00</td>
        <td>59014.74</td>
        <td>45535.09</td>
    </tr>
    <tr>
        <td>2013-08-13 00:00:00</td>
        <td>17956.88</td>
        <td>36042.37</td>
    </tr>
</table></div></div>
</div>
</div>
<div class="section" id="analytic-functions-windowing">
<h2>Analytic Functions – Windowing<a class="headerlink" href="#analytic-functions-windowing" title="Permalink to this headline">¶</a></h2>
<p>Let us go through the list of Windowing functions supported by Postgres.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/dL2mrHq_E-I?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lead</span></code> and <code class="docutils literal notranslate"><span class="pre">lag</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">first_value</span></code> and <code class="docutils literal notranslate"><span class="pre">last_value</span></code></p></li>
<li><p>We can either use <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">sort_column</span></code> or <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">partition_column</span> <span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">sort_column</span></code> while using Windowing Functions.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="section" id="getting-lead-and-lag-values">
<h3>Getting LEAD and LAG values<a class="headerlink" href="#getting-lead-and-lag-values" title="Permalink to this headline">¶</a></h3>
<p>Let us understand LEAD and LAG functions to get column values from following or prior records.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is the example to get values from either immediate prior or following record along with values from curent record. We will get values from prior or following record based on <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> within <code class="docutils literal notranslate"><span class="pre">OVER</span></code> Clause.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    lead(order_date) OVER (ORDER BY order_date DESC) AS prior_date,
    lead(revenue) OVER (ORDER BY order_date DESC) AS prior_revenue,
    lag(order_date) OVER (ORDER BY order_date) AS lag_prior_date,
    lag(revenue) OVER (ORDER BY order_date) AS lag_prior_revenue
FROM daily_revenue AS t
ORDER BY order_date DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
        <th>prior_date</th>
        <th>prior_revenue</th>
        <th>lag_prior_date</th>
        <th>lag_prior_revenue</th>
    </tr>
    <tr>
        <td>2014-07-24 00:00:00</td>
        <td>50885.19</td>
        <td>2014-07-23 00:00:00</td>
        <td>38795.23</td>
        <td>2014-07-23 00:00:00</td>
        <td>38795.23</td>
    </tr>
    <tr>
        <td>2014-07-23 00:00:00</td>
        <td>38795.23</td>
        <td>2014-07-22 00:00:00</td>
        <td>36717.24</td>
        <td>2014-07-22 00:00:00</td>
        <td>36717.24</td>
    </tr>
    <tr>
        <td>2014-07-22 00:00:00</td>
        <td>36717.24</td>
        <td>2014-07-21 00:00:00</td>
        <td>51427.70</td>
        <td>2014-07-21 00:00:00</td>
        <td>51427.70</td>
    </tr>
    <tr>
        <td>2014-07-21 00:00:00</td>
        <td>51427.70</td>
        <td>2014-07-20 00:00:00</td>
        <td>60047.45</td>
        <td>2014-07-20 00:00:00</td>
        <td>60047.45</td>
    </tr>
    <tr>
        <td>2014-07-20 00:00:00</td>
        <td>60047.45</td>
        <td>2014-07-19 00:00:00</td>
        <td>38420.99</td>
        <td>2014-07-19 00:00:00</td>
        <td>38420.99</td>
    </tr>
    <tr>
        <td>2014-07-19 00:00:00</td>
        <td>38420.99</td>
        <td>2014-07-18 00:00:00</td>
        <td>43856.60</td>
        <td>2014-07-18 00:00:00</td>
        <td>43856.60</td>
    </tr>
    <tr>
        <td>2014-07-18 00:00:00</td>
        <td>43856.60</td>
        <td>2014-07-17 00:00:00</td>
        <td>36384.77</td>
        <td>2014-07-17 00:00:00</td>
        <td>36384.77</td>
    </tr>
    <tr>
        <td>2014-07-17 00:00:00</td>
        <td>36384.77</td>
        <td>2014-07-16 00:00:00</td>
        <td>43011.92</td>
        <td>2014-07-16 00:00:00</td>
        <td>43011.92</td>
    </tr>
    <tr>
        <td>2014-07-16 00:00:00</td>
        <td>43011.92</td>
        <td>2014-07-15 00:00:00</td>
        <td>53480.23</td>
        <td>2014-07-15 00:00:00</td>
        <td>53480.23</td>
    </tr>
    <tr>
        <td>2014-07-15 00:00:00</td>
        <td>53480.23</td>
        <td>2014-07-14 00:00:00</td>
        <td>29937.52</td>
        <td>2014-07-14 00:00:00</td>
        <td>29937.52</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is the example to get values from either prior or following 7th record along with values from current record.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    lead(order_date, 7) OVER (ORDER BY order_date DESC) AS prior_date,
    lead(revenue, 7) OVER (ORDER BY order_date DESC) AS prior_revenue
FROM daily_revenue t
ORDER BY order_date DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
        <th>prior_date</th>
        <th>prior_revenue</th>
    </tr>
    <tr>
        <td>2014-07-24 00:00:00</td>
        <td>50885.19</td>
        <td>2014-07-17 00:00:00</td>
        <td>36384.77</td>
    </tr>
    <tr>
        <td>2014-07-23 00:00:00</td>
        <td>38795.23</td>
        <td>2014-07-16 00:00:00</td>
        <td>43011.92</td>
    </tr>
    <tr>
        <td>2014-07-22 00:00:00</td>
        <td>36717.24</td>
        <td>2014-07-15 00:00:00</td>
        <td>53480.23</td>
    </tr>
    <tr>
        <td>2014-07-21 00:00:00</td>
        <td>51427.70</td>
        <td>2014-07-14 00:00:00</td>
        <td>29937.52</td>
    </tr>
    <tr>
        <td>2014-07-20 00:00:00</td>
        <td>60047.45</td>
        <td>2014-07-13 00:00:00</td>
        <td>40410.99</td>
    </tr>
    <tr>
        <td>2014-07-19 00:00:00</td>
        <td>38420.99</td>
        <td>2014-07-12 00:00:00</td>
        <td>38449.77</td>
    </tr>
    <tr>
        <td>2014-07-18 00:00:00</td>
        <td>43856.60</td>
        <td>2014-07-11 00:00:00</td>
        <td>29596.32</td>
    </tr>
    <tr>
        <td>2014-07-17 00:00:00</td>
        <td>36384.77</td>
        <td>2014-07-10 00:00:00</td>
        <td>47826.02</td>
    </tr>
    <tr>
        <td>2014-07-16 00:00:00</td>
        <td>43011.92</td>
        <td>2014-07-09 00:00:00</td>
        <td>36929.91</td>
    </tr>
    <tr>
        <td>2014-07-15 00:00:00</td>
        <td>53480.23</td>
        <td>2014-07-08 00:00:00</td>
        <td>50434.81</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For values related to non existing prior or following record, we will get nulls.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    lead(order_date, 7) OVER (ORDER BY order_date DESC) AS prior_date,
    lead(revenue, 7) OVER (ORDER BY order_date DESC) AS prior_revenue
FROM daily_revenue t
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
        <th>prior_date</th>
        <th>prior_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can replace nulls by passing relevant values as 3rd argument. However, the data type of the values should be compatible with the columns on which <code class="docutils literal notranslate"><span class="pre">lead</span></code> or <code class="docutils literal notranslate"><span class="pre">lag</span></code> is applied.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    lead(order_date, 7) OVER (ORDER BY order_date DESC) AS prior_date,
    lead(revenue, 7, 0.0) OVER (ORDER BY order_date DESC) AS prior_revenue
FROM daily_revenue t
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
        <th>prior_date</th>
        <th>prior_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
        <td>None</td>
        <td>0.0</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
        <td>None</td>
        <td>0.0</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
        <td>None</td>
        <td>0.0</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
        <td>None</td>
        <td>0.0</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
        <td>None</td>
        <td>0.0</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
        <td>None</td>
        <td>0.0</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
        <td>None</td>
        <td>0.0</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM daily_product_revenue 
ORDER BY order_date, revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    LEAD(order_item_product_id) OVER (
        PARTITION BY order_date 
        ORDER BY revenue DESC
    ) next_product_id,
    LEAD(revenue) OVER (
        PARTITION BY order_date 
        ORDER BY revenue DESC
    ) next_revenue
FROM daily_product_revenue t
ORDER BY order_date, revenue DESC
LIMIT 30
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
30 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>next_product_id</th>
        <th>next_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>191</td>
        <td>5099.49</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>957</td>
        <td>4499.70</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>365</td>
        <td>3359.44</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>1073</td>
        <td>2999.85</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>1014</td>
        <td>2798.88</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
        <td>403</td>
        <td>1949.85</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
        <td>502</td>
        <td>1650.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
        <td>627</td>
        <td>1079.73</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
        <td>226</td>
        <td>599.99</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
        <td>24</td>
        <td>319.96</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>24</td>
        <td>319.96</td>
        <td>821</td>
        <td>207.96</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>821</td>
        <td>207.96</td>
        <td>625</td>
        <td>199.99</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>625</td>
        <td>199.99</td>
        <td>705</td>
        <td>119.99</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>705</td>
        <td>119.99</td>
        <td>572</td>
        <td>119.97</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>572</td>
        <td>119.97</td>
        <td>666</td>
        <td>109.99</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>666</td>
        <td>109.99</td>
        <td>725</td>
        <td>108.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>725</td>
        <td>108.00</td>
        <td>134</td>
        <td>100.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>134</td>
        <td>100.00</td>
        <td>906</td>
        <td>99.96</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>906</td>
        <td>99.96</td>
        <td>828</td>
        <td>95.97</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>828</td>
        <td>95.97</td>
        <td>810</td>
        <td>79.96</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>810</td>
        <td>79.96</td>
        <td>924</td>
        <td>79.95</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>924</td>
        <td>79.95</td>
        <td>926</td>
        <td>79.95</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>926</td>
        <td>79.95</td>
        <td>93</td>
        <td>74.97</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>93</td>
        <td>74.97</td>
        <td>835</td>
        <td>63.98</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>835</td>
        <td>63.98</td>
        <td>897</td>
        <td>49.98</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>897</td>
        <td>49.98</td>
        <td>None</td>
        <td>None</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>365</td>
        <td>7978.67</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>957</td>
        <td>6899.54</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>191</td>
        <td>6799.32</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>1014</td>
        <td>4798.08</td>
    </tr>
</table></div></div>
</div>
</div>
<div class="section" id="getting-first-and-last-values">
<h3>Getting first and last values<a class="headerlink" href="#getting-first-and-last-values" title="Permalink to this headline">¶</a></h3>
<p>Let us see how we can get first and last value based on the criteria. <code class="docutils literal notranslate"><span class="pre">min</span></code> or <code class="docutils literal notranslate"><span class="pre">max</span></code> can be used to get only the min or max of the metric we are interested in, however we cannot get other attributes of those records.</p>
<p>Here is the example of using first_value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    first_value(order_item_product_id) OVER (
        PARTITION BY order_date ORDER BY revenue DESC
    ) first_product_id,
    first_value(revenue) OVER (
        PARTITION BY order_date ORDER BY revenue DESC
    ) first_revenue,
    max(revenue) OVER (
        PARTITION BY order_date
    ) max_revenue
FROM daily_product_revenue t
ORDER BY order_date, revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>first_product_id</th>
        <th>first_revenue</th>
        <th>max_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>5599.72</td>
    </tr>
</table></div></div>
</div>
<p>Let us see an example with last_value. While using last_value we need to specify <strong>ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING</strong>.</p>
<ul class="simple">
<li><p>By default it uses <code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span> <span class="pre">AND</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span></code>.</p></li>
<li><p>The last value with in <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span> <span class="pre">AND</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span></code> will be current record.</p></li>
<li><p>To get the right value, we have to change the windowing clause to <code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span> <span class="pre">AND</span> <span class="pre">UNBOUNDED</span> <span class="pre">FOLLOWING</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    last_value(order_item_product_id) OVER (
        PARTITION BY order_date ORDER BY revenue    
        ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING
    ) last_product_id,
    max(revenue) OVER (
        PARTITION BY order_date
    ) last_revenue
FROM daily_product_revenue AS t
ORDER BY order_date, revenue DESC
LIMIT 30
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
30 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>last_product_id</th>
        <th>last_revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>24</td>
        <td>319.96</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>821</td>
        <td>207.96</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>625</td>
        <td>199.99</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>705</td>
        <td>119.99</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>572</td>
        <td>119.97</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>666</td>
        <td>109.99</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>725</td>
        <td>108.00</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>134</td>
        <td>100.00</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>906</td>
        <td>99.96</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>828</td>
        <td>95.97</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>810</td>
        <td>79.96</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>924</td>
        <td>79.95</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>926</td>
        <td>79.95</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>93</td>
        <td>74.97</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>835</td>
        <td>63.98</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>897</td>
        <td>49.98</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>1004</td>
        <td>10799.46</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>1004</td>
        <td>10799.46</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>1004</td>
        <td>10799.46</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>1004</td>
        <td>10799.46</td>
    </tr>
</table></div></div>
</div>
</div>
</div>
<div class="section" id="analytic-functions-ranking">
<h2>Analytic Functions – Ranking<a class="headerlink" href="#analytic-functions-ranking" title="Permalink to this headline">¶</a></h2>
<p>Let us see how we can assign ranks using different <strong>rank</strong> functions.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/9B1A5EV_PsI?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>If we have to assign ranks globally, we just need to specify <strong>ORDER BY</strong></p></li>
<li><p>If we have to assign ranks with in a key then we need to specify <strong>PARTITION BY</strong> and then <strong>ORDER BY</strong>.</p></li>
<li><p>By default <strong>ORDER BY</strong> will sort the data in ascending order. We can change the order by passing <strong>DESC</strong> after order by.</p></li>
<li><p>We have 3 main functions to assign ranks - <code class="docutils literal notranslate"><span class="pre">rank</span></code>, <code class="docutils literal notranslate"><span class="pre">dense_rank</span></code> and <code class="docutils literal notranslate"><span class="pre">row_number</span></code>. We will see the differences between the 3 in a moment.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is an example to assign sparse ranks using daily_product_revenue with in each day based on revenue.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
    rank() OVER (
        PARTITION BY order_date
        ORDER BY revenue DESC
    ) AS rnk
FROM daily_product_revenue t
ORDER BY order_date, revenue DESC
LIMIT 30
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
30 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>rnk</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
        <td>6</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
        <td>7</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
        <td>8</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
        <td>9</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
        <td>10</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>24</td>
        <td>319.96</td>
        <td>11</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>821</td>
        <td>207.96</td>
        <td>12</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>625</td>
        <td>199.99</td>
        <td>13</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>705</td>
        <td>119.99</td>
        <td>14</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>572</td>
        <td>119.97</td>
        <td>15</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>666</td>
        <td>109.99</td>
        <td>16</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>725</td>
        <td>108.00</td>
        <td>17</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>134</td>
        <td>100.00</td>
        <td>18</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>906</td>
        <td>99.96</td>
        <td>19</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>828</td>
        <td>95.97</td>
        <td>20</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>810</td>
        <td>79.96</td>
        <td>21</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>924</td>
        <td>79.95</td>
        <td>22</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>926</td>
        <td>79.95</td>
        <td>22</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>93</td>
        <td>74.97</td>
        <td>24</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>835</td>
        <td>63.98</td>
        <td>25</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>897</td>
        <td>49.98</td>
        <td>26</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>4</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is another example to assign sparse ranks using employees data set with in each department. Make sure to restart kernel as you might have connected to retail database.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT employee_id, department_id, salary FROM employees 
ORDER BY department_id,
    salary DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT employee_id, department_id, salary,
    rank() OVER (
        PARTITION BY department_id 
        ORDER BY salary DESC
    ) AS rnk
FROM employees
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>rnk</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>2</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>2</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>3</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>4</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>5</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>121</td>
        <td>50</td>
        <td>8200.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>120</td>
        <td>50</td>
        <td>8000.00</td>
        <td>2</td>
    </tr>
    <tr>
        <td>122</td>
        <td>50</td>
        <td>7900.00</td>
        <td>3</td>
    </tr>
    <tr>
        <td>123</td>
        <td>50</td>
        <td>6500.00</td>
        <td>4</td>
    </tr>
    <tr>
        <td>124</td>
        <td>50</td>
        <td>5800.00</td>
        <td>5</td>
    </tr>
    <tr>
        <td>184</td>
        <td>50</td>
        <td>4200.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>185</td>
        <td>50</td>
        <td>4100.00</td>
        <td>7</td>
    </tr>
    <tr>
        <td>192</td>
        <td>50</td>
        <td>4000.00</td>
        <td>8</td>
    </tr>
    <tr>
        <td>193</td>
        <td>50</td>
        <td>3900.00</td>
        <td>9</td>
    </tr>
    <tr>
        <td>188</td>
        <td>50</td>
        <td>3800.00</td>
        <td>10</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is an example to assign dense ranks using employees data set with in each department.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT employee_id, department_id, salary,
    dense_rank() OVER (
        PARTITION BY department_id 
        ORDER BY salary DESC
    ) AS drnk
FROM employees
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>drnk</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>2</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>2</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>3</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>4</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>5</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>121</td>
        <td>50</td>
        <td>8200.00</td>
        <td>1</td>
    </tr>
    <tr>
        <td>120</td>
        <td>50</td>
        <td>8000.00</td>
        <td>2</td>
    </tr>
    <tr>
        <td>122</td>
        <td>50</td>
        <td>7900.00</td>
        <td>3</td>
    </tr>
    <tr>
        <td>123</td>
        <td>50</td>
        <td>6500.00</td>
        <td>4</td>
    </tr>
    <tr>
        <td>124</td>
        <td>50</td>
        <td>5800.00</td>
        <td>5</td>
    </tr>
    <tr>
        <td>184</td>
        <td>50</td>
        <td>4200.00</td>
        <td>6</td>
    </tr>
    <tr>
        <td>185</td>
        <td>50</td>
        <td>4100.00</td>
        <td>7</td>
    </tr>
    <tr>
        <td>192</td>
        <td>50</td>
        <td>4000.00</td>
        <td>8</td>
    </tr>
    <tr>
        <td>193</td>
        <td>50</td>
        <td>3900.00</td>
        <td>9</td>
    </tr>
    <tr>
        <td>188</td>
        <td>50</td>
        <td>3800.00</td>
        <td>10</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is an example for global rank based on salary. If all the salaries are unique, we can use <code class="docutils literal notranslate"><span class="pre">LIMIT</span></code> but when they are not unique, we have to go with analytic functions.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT employee_id, department_id, salary,
    rank() OVER (
        ORDER BY salary DESC
    ) AS rnk,
    dense_rank() OVER (
        ORDER BY salary DESC
    ) AS drnk
FROM employees
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>rnk</th>
        <th>drnk</th>
    </tr>
    <tr>
        <td>100</td>
        <td>90</td>
        <td>24000.00</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>101</td>
        <td>90</td>
        <td>17000.00</td>
        <td>2</td>
        <td>2</td>
    </tr>
    <tr>
        <td>102</td>
        <td>90</td>
        <td>17000.00</td>
        <td>2</td>
        <td>2</td>
    </tr>
    <tr>
        <td>145</td>
        <td>80</td>
        <td>14000.00</td>
        <td>4</td>
        <td>3</td>
    </tr>
    <tr>
        <td>146</td>
        <td>80</td>
        <td>13500.00</td>
        <td>5</td>
        <td>4</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>6</td>
        <td>5</td>
    </tr>
    <tr>
        <td>205</td>
        <td>110</td>
        <td>12000.00</td>
        <td>7</td>
        <td>6</td>
    </tr>
    <tr>
        <td>147</td>
        <td>80</td>
        <td>12000.00</td>
        <td>7</td>
        <td>6</td>
    </tr>
    <tr>
        <td>108</td>
        <td>100</td>
        <td>12000.00</td>
        <td>7</td>
        <td>6</td>
    </tr>
    <tr>
        <td>168</td>
        <td>80</td>
        <td>11500.00</td>
        <td>10</td>
        <td>7</td>
    </tr>
    <tr>
        <td>148</td>
        <td>80</td>
        <td>11000.00</td>
        <td>11</td>
        <td>8</td>
    </tr>
    <tr>
        <td>174</td>
        <td>80</td>
        <td>11000.00</td>
        <td>11</td>
        <td>8</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>11</td>
        <td>8</td>
    </tr>
    <tr>
        <td>149</td>
        <td>80</td>
        <td>10500.00</td>
        <td>14</td>
        <td>9</td>
    </tr>
    <tr>
        <td>162</td>
        <td>80</td>
        <td>10500.00</td>
        <td>14</td>
        <td>9</td>
    </tr>
    <tr>
        <td>169</td>
        <td>80</td>
        <td>10000.00</td>
        <td>16</td>
        <td>10</td>
    </tr>
    <tr>
        <td>204</td>
        <td>70</td>
        <td>10000.00</td>
        <td>16</td>
        <td>10</td>
    </tr>
    <tr>
        <td>150</td>
        <td>80</td>
        <td>10000.00</td>
        <td>16</td>
        <td>10</td>
    </tr>
    <tr>
        <td>156</td>
        <td>80</td>
        <td>10000.00</td>
        <td>16</td>
        <td>10</td>
    </tr>
    <tr>
        <td>170</td>
        <td>80</td>
        <td>9600.00</td>
        <td>20</td>
        <td>11</td>
    </tr>
</table></div></div>
</div>
<p>Let us understand the difference between <strong>rank</strong>, <strong>dense_rank</strong> and <strong>row_number</strong>.</p>
<ul class="simple">
<li><p>We can use either of the functions to generate ranks when the rank field does not have duplicates.</p></li>
<li><p>When rank field have duplicates then row_number should not be used as it generate unique number for each record with in the partition.</p></li>
<li><p><strong>rank</strong> will skip the ranks in between if multiple people get the same rank while <strong>dense_rank</strong> continue with the next number.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT
    employee_id,
    department_id,
    salary,
    rank() OVER (
        PARTITION BY department_id
        ORDER BY salary DESC
      ) rnk,
    dense_rank() OVER (
        PARTITION BY department_id
        ORDER BY salary DESC
      ) drnk,
    row_number() OVER (
        PARTITION BY department_id
        ORDER BY salary DESC, employee_id
      ) rn
FROM employees
ORDER BY department_id, salary DESC
LIMIT 50
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_hr_user:***@localhost:5432/itversity_hr_db
50 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>employee_id</th>
        <th>department_id</th>
        <th>salary</th>
        <th>rnk</th>
        <th>drnk</th>
        <th>rn</th>
    </tr>
    <tr>
        <td>200</td>
        <td>10</td>
        <td>4400.00</td>
        <td>1</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>201</td>
        <td>20</td>
        <td>13000.00</td>
        <td>1</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>202</td>
        <td>20</td>
        <td>6000.00</td>
        <td>2</td>
        <td>2</td>
        <td>2</td>
    </tr>
    <tr>
        <td>114</td>
        <td>30</td>
        <td>11000.00</td>
        <td>1</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>115</td>
        <td>30</td>
        <td>3100.00</td>
        <td>2</td>
        <td>2</td>
        <td>2</td>
    </tr>
    <tr>
        <td>116</td>
        <td>30</td>
        <td>2900.00</td>
        <td>3</td>
        <td>3</td>
        <td>3</td>
    </tr>
    <tr>
        <td>117</td>
        <td>30</td>
        <td>2800.00</td>
        <td>4</td>
        <td>4</td>
        <td>4</td>
    </tr>
    <tr>
        <td>118</td>
        <td>30</td>
        <td>2600.00</td>
        <td>5</td>
        <td>5</td>
        <td>5</td>
    </tr>
    <tr>
        <td>119</td>
        <td>30</td>
        <td>2500.00</td>
        <td>6</td>
        <td>6</td>
        <td>6</td>
    </tr>
    <tr>
        <td>203</td>
        <td>40</td>
        <td>6500.00</td>
        <td>1</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>121</td>
        <td>50</td>
        <td>8200.00</td>
        <td>1</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>120</td>
        <td>50</td>
        <td>8000.00</td>
        <td>2</td>
        <td>2</td>
        <td>2</td>
    </tr>
    <tr>
        <td>122</td>
        <td>50</td>
        <td>7900.00</td>
        <td>3</td>
        <td>3</td>
        <td>3</td>
    </tr>
    <tr>
        <td>123</td>
        <td>50</td>
        <td>6500.00</td>
        <td>4</td>
        <td>4</td>
        <td>4</td>
    </tr>
    <tr>
        <td>124</td>
        <td>50</td>
        <td>5800.00</td>
        <td>5</td>
        <td>5</td>
        <td>5</td>
    </tr>
    <tr>
        <td>184</td>
        <td>50</td>
        <td>4200.00</td>
        <td>6</td>
        <td>6</td>
        <td>6</td>
    </tr>
    <tr>
        <td>185</td>
        <td>50</td>
        <td>4100.00</td>
        <td>7</td>
        <td>7</td>
        <td>7</td>
    </tr>
    <tr>
        <td>192</td>
        <td>50</td>
        <td>4000.00</td>
        <td>8</td>
        <td>8</td>
        <td>8</td>
    </tr>
    <tr>
        <td>193</td>
        <td>50</td>
        <td>3900.00</td>
        <td>9</td>
        <td>9</td>
        <td>9</td>
    </tr>
    <tr>
        <td>188</td>
        <td>50</td>
        <td>3800.00</td>
        <td>10</td>
        <td>10</td>
        <td>10</td>
    </tr>
    <tr>
        <td>137</td>
        <td>50</td>
        <td>3600.00</td>
        <td>11</td>
        <td>11</td>
        <td>11</td>
    </tr>
    <tr>
        <td>189</td>
        <td>50</td>
        <td>3600.00</td>
        <td>11</td>
        <td>11</td>
        <td>12</td>
    </tr>
    <tr>
        <td>141</td>
        <td>50</td>
        <td>3500.00</td>
        <td>13</td>
        <td>12</td>
        <td>13</td>
    </tr>
    <tr>
        <td>186</td>
        <td>50</td>
        <td>3400.00</td>
        <td>14</td>
        <td>13</td>
        <td>14</td>
    </tr>
    <tr>
        <td>129</td>
        <td>50</td>
        <td>3300.00</td>
        <td>15</td>
        <td>14</td>
        <td>15</td>
    </tr>
    <tr>
        <td>133</td>
        <td>50</td>
        <td>3300.00</td>
        <td>15</td>
        <td>14</td>
        <td>16</td>
    </tr>
    <tr>
        <td>125</td>
        <td>50</td>
        <td>3200.00</td>
        <td>17</td>
        <td>15</td>
        <td>17</td>
    </tr>
    <tr>
        <td>138</td>
        <td>50</td>
        <td>3200.00</td>
        <td>17</td>
        <td>15</td>
        <td>18</td>
    </tr>
    <tr>
        <td>180</td>
        <td>50</td>
        <td>3200.00</td>
        <td>17</td>
        <td>15</td>
        <td>19</td>
    </tr>
    <tr>
        <td>194</td>
        <td>50</td>
        <td>3200.00</td>
        <td>17</td>
        <td>15</td>
        <td>20</td>
    </tr>
    <tr>
        <td>142</td>
        <td>50</td>
        <td>3100.00</td>
        <td>21</td>
        <td>16</td>
        <td>21</td>
    </tr>
    <tr>
        <td>181</td>
        <td>50</td>
        <td>3100.00</td>
        <td>21</td>
        <td>16</td>
        <td>22</td>
    </tr>
    <tr>
        <td>196</td>
        <td>50</td>
        <td>3100.00</td>
        <td>21</td>
        <td>16</td>
        <td>23</td>
    </tr>
    <tr>
        <td>187</td>
        <td>50</td>
        <td>3000.00</td>
        <td>24</td>
        <td>17</td>
        <td>24</td>
    </tr>
    <tr>
        <td>197</td>
        <td>50</td>
        <td>3000.00</td>
        <td>24</td>
        <td>17</td>
        <td>25</td>
    </tr>
    <tr>
        <td>134</td>
        <td>50</td>
        <td>2900.00</td>
        <td>26</td>
        <td>18</td>
        <td>26</td>
    </tr>
    <tr>
        <td>190</td>
        <td>50</td>
        <td>2900.00</td>
        <td>26</td>
        <td>18</td>
        <td>27</td>
    </tr>
    <tr>
        <td>130</td>
        <td>50</td>
        <td>2800.00</td>
        <td>28</td>
        <td>19</td>
        <td>28</td>
    </tr>
    <tr>
        <td>183</td>
        <td>50</td>
        <td>2800.00</td>
        <td>28</td>
        <td>19</td>
        <td>29</td>
    </tr>
    <tr>
        <td>195</td>
        <td>50</td>
        <td>2800.00</td>
        <td>28</td>
        <td>19</td>
        <td>30</td>
    </tr>
    <tr>
        <td>126</td>
        <td>50</td>
        <td>2700.00</td>
        <td>31</td>
        <td>20</td>
        <td>31</td>
    </tr>
    <tr>
        <td>139</td>
        <td>50</td>
        <td>2700.00</td>
        <td>31</td>
        <td>20</td>
        <td>32</td>
    </tr>
    <tr>
        <td>143</td>
        <td>50</td>
        <td>2600.00</td>
        <td>33</td>
        <td>21</td>
        <td>33</td>
    </tr>
    <tr>
        <td>198</td>
        <td>50</td>
        <td>2600.00</td>
        <td>33</td>
        <td>21</td>
        <td>34</td>
    </tr>
    <tr>
        <td>199</td>
        <td>50</td>
        <td>2600.00</td>
        <td>33</td>
        <td>21</td>
        <td>35</td>
    </tr>
    <tr>
        <td>131</td>
        <td>50</td>
        <td>2500.00</td>
        <td>36</td>
        <td>22</td>
        <td>36</td>
    </tr>
    <tr>
        <td>140</td>
        <td>50</td>
        <td>2500.00</td>
        <td>36</td>
        <td>22</td>
        <td>37</td>
    </tr>
    <tr>
        <td>144</td>
        <td>50</td>
        <td>2500.00</td>
        <td>36</td>
        <td>22</td>
        <td>38</td>
    </tr>
    <tr>
        <td>182</td>
        <td>50</td>
        <td>2500.00</td>
        <td>36</td>
        <td>22</td>
        <td>39</td>
    </tr>
    <tr>
        <td>191</td>
        <td>50</td>
        <td>2500.00</td>
        <td>36</td>
        <td>22</td>
        <td>40</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is another example to with respect to all 3 functions. Make sure to restart kernel as you might have connected to HR database.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT
    t.*,
    rank() OVER (
        PARTITION BY order_date
        ORDER BY revenue DESC
    ) rnk,
    dense_rank() OVER (
        PARTITION BY order_date
        ORDER BY revenue DESC
    ) drnk,
    row_number() OVER (
        PARTITION BY order_date
        ORDER BY revenue DESC
    ) rn
FROM daily_product_revenue AS t
ORDER BY order_date, revenue DESC
LIMIT 30
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>rnk</th>
        <th>drnk</th>
        <th>rn</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>2</td>
        <td>2</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>3</td>
        <td>3</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>4</td>
        <td>4</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>5</td>
        <td>5</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
        <td>6</td>
        <td>6</td>
        <td>6</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
        <td>7</td>
        <td>7</td>
        <td>7</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
        <td>8</td>
        <td>8</td>
        <td>8</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
        <td>9</td>
        <td>9</td>
        <td>9</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
        <td>10</td>
        <td>10</td>
        <td>10</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>24</td>
        <td>319.96</td>
        <td>11</td>
        <td>11</td>
        <td>11</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>821</td>
        <td>207.96</td>
        <td>12</td>
        <td>12</td>
        <td>12</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>625</td>
        <td>199.99</td>
        <td>13</td>
        <td>13</td>
        <td>13</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>705</td>
        <td>119.99</td>
        <td>14</td>
        <td>14</td>
        <td>14</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>572</td>
        <td>119.97</td>
        <td>15</td>
        <td>15</td>
        <td>15</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>666</td>
        <td>109.99</td>
        <td>16</td>
        <td>16</td>
        <td>16</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>725</td>
        <td>108.00</td>
        <td>17</td>
        <td>17</td>
        <td>17</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>134</td>
        <td>100.00</td>
        <td>18</td>
        <td>18</td>
        <td>18</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>906</td>
        <td>99.96</td>
        <td>19</td>
        <td>19</td>
        <td>19</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>828</td>
        <td>95.97</td>
        <td>20</td>
        <td>20</td>
        <td>20</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>810</td>
        <td>79.96</td>
        <td>21</td>
        <td>21</td>
        <td>21</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>924</td>
        <td>79.95</td>
        <td>22</td>
        <td>22</td>
        <td>22</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>926</td>
        <td>79.95</td>
        <td>22</td>
        <td>22</td>
        <td>23</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>93</td>
        <td>74.97</td>
        <td>24</td>
        <td>23</td>
        <td>24</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>835</td>
        <td>63.98</td>
        <td>25</td>
        <td>24</td>
        <td>25</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>897</td>
        <td>49.98</td>
        <td>26</td>
        <td>25</td>
        <td>26</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>1</td>
        <td>1</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>2</td>
        <td>2</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>3</td>
        <td>3</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>4</td>
        <td>4</td>
        <td>4</td>
    </tr>
</table></div></div>
</div>
</div>
<div class="section" id="analytic-functions-filtering">
<h2>Analytic Functions - Filtering<a class="headerlink" href="#analytic-functions-filtering" title="Permalink to this headline">¶</a></h2>
<p>Let us go through the solution for getting top 5 daily products based up on the revenue. In that process we will understand how to apply filtering on top of the derived values using analytic functions.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/hp0cmesr8i8?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="section" id="order-of-execution-of-sql">
<h3>Order of execution of SQL<a class="headerlink" href="#order-of-execution-of-sql" title="Permalink to this headline">¶</a></h3>
<p>Let us review the order of execution of SQL. First let us review the order of writing the query.</p>
<ol class="simple">
<li><p><strong>SELECT</strong></p></li>
<li><p><strong>FROM</strong></p></li>
<li><p><strong>JOIN</strong> or <strong>OUTER JOIN</strong> with <strong>ON</strong></p></li>
<li><p><strong>WHERE</strong></p></li>
<li><p><strong>GROUP BY</strong> and optionally <strong>HAVING</strong></p></li>
<li><p><strong>ORDER BY</strong></p></li>
</ol>
<p>Let us come up with a query which will compute daily revenue using COMPLETE or CLOSED orders and also sorted by order_date.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date
ORDER BY o.order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date
    HAVING round(sum(oi.order_item_subtotal)::numeric, 2) &gt;= 50000
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
    </tr>
    <tr>
        <td>2013-08-06 00:00:00</td>
        <td>57843.89</td>
    </tr>
    <tr>
        <td>2013-08-12 00:00:00</td>
        <td>59014.74</td>
    </tr>
    <tr>
        <td>2013-08-17 00:00:00</td>
        <td>63226.83</td>
    </tr>
    <tr>
        <td>2013-08-24 00:00:00</td>
        <td>52650.15</td>
    </tr>
    <tr>
        <td>2013-09-05 00:00:00</td>
        <td>59942.43</td>
    </tr>
    <tr>
        <td>2013-09-06 00:00:00</td>
        <td>61976.10</td>
    </tr>
</table></div></div>
</div>
<p>However order of execution is typically as follows.</p>
<ol class="simple">
<li><p><strong>FROM</strong></p></li>
<li><p><strong>JOIN</strong> or <strong>OUTER JOIN</strong> with <strong>ON</strong></p></li>
<li><p><strong>WHERE</strong></p></li>
<li><p><strong>GROUP BY</strong> and optionally <strong>HAVING</strong></p></li>
<li><p><strong>SELECT</strong></p></li>
<li><p><strong>ORDER BY</strong></p></li>
</ol>
<p>As <strong>SELECT</strong> is executed before <strong>ORDER BY</strong> clause, we will not be able to refer the aliases defined in <strong>SELECT</strong> caluse in other clauses except for <strong>ORDER BY</strong> in most of the traditional databases including Postgresql.</p>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>This will fail as revenue which is an alias defined in <strong>SELECT</strong> cannot be used in <strong>WHERE</strong>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND revenue &gt;= 50000
GROUP BY o.order_date
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
(psycopg2.errors.UndefinedColumn) column &quot;revenue&quot; does not exist
LINE 5:     AND revenue &gt;= 50000
                ^

[SQL: SELECT o.order_date, round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND revenue &gt;= 50000
GROUP BY o.order_date
ORDER BY order_date
LIMIT 10]
(Background on this error at: http://sqlalche.me/e/13/f405)
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This will also fail as we cannot use aggregate functions in <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND round(sum(oi.order_item_subtotal)::numeric, 2) &gt;= 50000
GROUP BY o.order_date
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
(psycopg2.errors.GroupingError) aggregate functions are not allowed in WHERE
LINE 5:     AND round(sum(oi.order_item_subtotal)::numeric, 2) &gt;= 50...
                      ^

[SQL: SELECT o.order_date, round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND round(sum(oi.order_item_subtotal)::numeric, 2) &gt;= 50000
GROUP BY o.order_date
ORDER BY order_date
LIMIT 10]
(Background on this error at: http://sqlalche.me/e/13/f405)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date
ORDER BY order_date,
    revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>31547.23</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>48411.48</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>35672.03</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>49329.29</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>49160.08</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>43416.74</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date
    HAVING round(sum(oi.order_item_subtotal)::numeric, 2) &gt;= 50000
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>54713.23</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>54579.70</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>59212.49</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>50688.58</td>
    </tr>
    <tr>
        <td>2013-08-06 00:00:00</td>
        <td>57843.89</td>
    </tr>
    <tr>
        <td>2013-08-12 00:00:00</td>
        <td>59014.74</td>
    </tr>
    <tr>
        <td>2013-08-17 00:00:00</td>
        <td>63226.83</td>
    </tr>
    <tr>
        <td>2013-08-24 00:00:00</td>
        <td>52650.15</td>
    </tr>
    <tr>
        <td>2013-09-05 00:00:00</td>
        <td>59942.43</td>
    </tr>
    <tr>
        <td>2013-09-06 00:00:00</td>
        <td>61976.10</td>
    </tr>
</table></div></div>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>This one will also fail as we are trying to use alias <code class="docutils literal notranslate"><span class="pre">drnk</span></code> from <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause in <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>


SELECT t.*,
dense_rank() OVER (
  PARTITION BY order_date
  ORDER BY revenue DESC
) AS drnk
FROM daily_product_revenue t
WHERE drnk &lt;= 5
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
(psycopg2.errors.UndefinedColumn) column &quot;drnk&quot; does not exist
LINE 6: WHERE drnk &lt;= 5
              ^

[SQL: SELECT t.*, dense_rank() OVER (
  PARTITION BY order_date
  ORDER BY revenue DESC
) AS drnk
FROM daily_product_revenue t
WHERE drnk &lt;= 5]
(Background on this error at: http://sqlalche.me/e/13/f405)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h3>Overview of Sub Queries<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Let us recap about Sub Queries.</p>
<ul class="simple">
<li><p>We typically have Sub Queries in <strong>FROM</strong> Clause.</p></li>
<li><p>We need to provide alias to the Sub Queries in <strong>FROM</strong> Clause in Postgresql.</p></li>
<li><p>We use sub queries quite often over queries using Analytics/Windowing Functions</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM (SELECT current_date) AS q
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>current_date</th>
    </tr>
    <tr>
        <td>2020-12-01</td>
    </tr>
</table></div></div>
</div>
<p>Let us see few more examples with respect to Sub Queries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM (
  SELECT order_date, count(1) AS order_count
  FROM orders
  GROUP BY order_date
) AS q
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_count</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>143</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>269</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>202</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>187</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>253</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>227</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>252</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>246</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>224</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>183</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM (
  SELECT order_date, count(1) AS order_count
  FROM orders
  GROUP BY order_date
) q
WHERE q.order_count &gt; 150
ORDER BY order_date
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_count</th>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>269</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>202</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>187</td>
    </tr>
    <tr>
        <td>2013-07-29 00:00:00</td>
        <td>253</td>
    </tr>
    <tr>
        <td>2013-07-30 00:00:00</td>
        <td>227</td>
    </tr>
    <tr>
        <td>2013-07-31 00:00:00</td>
        <td>252</td>
    </tr>
    <tr>
        <td>2013-08-01 00:00:00</td>
        <td>246</td>
    </tr>
    <tr>
        <td>2013-08-02 00:00:00</td>
        <td>224</td>
    </tr>
    <tr>
        <td>2013-08-03 00:00:00</td>
        <td>183</td>
    </tr>
    <tr>
        <td>2013-08-04 00:00:00</td>
        <td>187</td>
    </tr>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Above query is an example for sub queries. We can achieve using HAVING clause (no need to have sub query to filter)</p>
</div>
</div>
<div class="section" id="filtering-analytic-function-results">
<h3>Filtering - Analytic Function Results<a class="headerlink" href="#filtering-analytic-function-results" title="Permalink to this headline">¶</a></h3>
<p>Let us understand how to filter on top of results of Analytic Functions.</p>
<ul class="simple">
<li><p>We can use Analytic Functions only in <strong>SELECT</strong> Clause.</p></li>
<li><p>If we have to filter based on Analytic Function results, then we need to use Sub Queries.</p></li>
<li><p>Once the query is added as subquery, we can apply filter using aliases of the Analytic Functions.</p></li>
</ul>
<p>Here is the example where we can filter data based on Analytic Functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT t.*,
dense_rank() OVER (
  PARTITION BY order_date
  ORDER BY revenue DESC
) AS drnk
FROM daily_product_revenue t
WHERE drnk &lt;= 5
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
(psycopg2.errors.UndefinedColumn) column &quot;drnk&quot; does not exist
LINE 6: WHERE drnk &lt;= 5
              ^

[SQL: SELECT t.*, dense_rank() OVER (
  PARTITION BY order_date
  ORDER BY revenue DESC
) AS drnk
FROM daily_product_revenue t
WHERE drnk &lt;= 5]
(Background on this error at: http://sqlalche.me/e/13/f405)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM (
  SELECT t.*,
    dense_rank() OVER (
      PARTITION BY order_date
      ORDER BY revenue DESC
    ) AS drnk
  FROM daily_product_revenue t
) q
WHERE q.drnk &lt;= 5
ORDER BY q.order_date, q.revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>drnk</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1014</td>
        <td>4798.08</td>
        <td>5</td>
    </tr>
</table></div></div>
</div>
</div>
</div>
<div class="section" id="ranking-and-filtering-recap">
<h2>Ranking and Filtering - Recap<a class="headerlink" href="#ranking-and-filtering-recap" title="Permalink to this headline">¶</a></h2>
<p>Let us recap the procedure to get top 5 products by revenue for each day.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><iframe width="560" height="315" src="https://www.youtube.com/embed/k9KYtK-is2w?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div>
</div>
<ul class="simple">
<li><p>We have our original data in <strong>orders</strong> and <strong>order_items</strong></p></li>
<li><p>We can pre-compute the data or create a view with the logic to generate <strong>daily product revenue</strong></p></li>
<li><p>Then, we have to use the view or table or even sub query to compute rank</p></li>
<li><p>Once the ranks are computed, we need to use sub query to filter based up on our requirement.</p></li>
</ul>
<p>Let us come up with the query to compute daily product revenue.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sql extension is already loaded. To reload it, use:
  %reload_ext sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
       oi.order_item_product_id,
       round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
FROM orders o JOIN order_items oi
ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date, oi.order_item_product_id
ORDER BY o.order_date, revenue DESC
LIMIT 30
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
30 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>24</td>
        <td>319.96</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>821</td>
        <td>207.96</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>625</td>
        <td>199.99</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>705</td>
        <td>119.99</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>572</td>
        <td>119.97</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>666</td>
        <td>109.99</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>725</td>
        <td>108.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>134</td>
        <td>100.00</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>906</td>
        <td>99.96</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>828</td>
        <td>95.97</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>810</td>
        <td>79.96</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>924</td>
        <td>79.95</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>926</td>
        <td>79.95</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>93</td>
        <td>74.97</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>835</td>
        <td>63.98</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>897</td>
        <td>49.98</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
    </tr>
</table></div></div>
</div>
<p>Let us compute the rank for each product with in each date using revenue as criteria.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>


SELECT nq.*,
    dense_rank() OVER (
        PARTITION BY order_date
        ORDER BY revenue DESC
    ) AS drnk
FROM (
    SELECT o.order_date,
        oi.order_item_product_id,
        round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
    FROM orders o 
        JOIN order_items oi
            ON o.order_id = oi.order_item_order_id
    WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    GROUP BY o.order_date, oi.order_item_product_id
) nq
ORDER BY order_date, revenue DESC
LIMIT 30
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
30 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>drnk</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1014</td>
        <td>2798.88</td>
        <td>6</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>403</td>
        <td>1949.85</td>
        <td>7</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>502</td>
        <td>1650.00</td>
        <td>8</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>627</td>
        <td>1079.73</td>
        <td>9</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>226</td>
        <td>599.99</td>
        <td>10</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>24</td>
        <td>319.96</td>
        <td>11</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>821</td>
        <td>207.96</td>
        <td>12</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>625</td>
        <td>199.99</td>
        <td>13</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>705</td>
        <td>119.99</td>
        <td>14</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>572</td>
        <td>119.97</td>
        <td>15</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>666</td>
        <td>109.99</td>
        <td>16</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>725</td>
        <td>108.00</td>
        <td>17</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>134</td>
        <td>100.00</td>
        <td>18</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>906</td>
        <td>99.96</td>
        <td>19</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>828</td>
        <td>95.97</td>
        <td>20</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>810</td>
        <td>79.96</td>
        <td>21</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>924</td>
        <td>79.95</td>
        <td>22</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>926</td>
        <td>79.95</td>
        <td>22</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>93</td>
        <td>74.97</td>
        <td>23</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>835</td>
        <td>63.98</td>
        <td>24</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>897</td>
        <td>49.98</td>
        <td>25</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>4</td>
    </tr>
</table></div></div>
</div>
<p>Now let us see how we can filter the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM (
    SELECT nq.*,
        dense_rank() OVER (
            PARTITION BY order_date
            ORDER BY revenue DESC
        ) AS drnk
    FROM (
        SELECT o.order_date,
            oi.order_item_product_id,
            round(sum(oi.order_item_subtotal)::numeric, 2) AS revenue
        FROM orders o 
            JOIN order_items oi
                ON o.order_id = oi.order_item_order_id
        WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
        GROUP BY o.order_date, oi.order_item_product_id
    ) nq
) nq1
WHERE drnk &lt;= 5
ORDER BY order_date, revenue DESC
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>drnk</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1014</td>
        <td>4798.08</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>1004</td>
        <td>9599.52</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>191</td>
        <td>5999.40</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>957</td>
        <td>5699.62</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>1073</td>
        <td>5399.73</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>365</td>
        <td>5099.15</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>957</td>
        <td>5099.66</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>365</td>
        <td>4799.20</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>403</td>
        <td>4419.66</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>191</td>
        <td>4299.57</td>
        <td>5</td>
    </tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM (SELECT dpr.*,
  dense_rank() OVER (
    PARTITION BY order_date
    ORDER BY revenue DESC
  ) AS drnk
FROM daily_product_revenue AS dpr) q
WHERE drnk &lt;= 5
ORDER BY order_date, revenue DESC
LIMIT 20
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
20 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>order_date</th>
        <th>order_item_product_id</th>
        <th>revenue</th>
        <th>drnk</th>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>191</td>
        <td>5099.49</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>957</td>
        <td>4499.70</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>365</td>
        <td>3359.44</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-25 00:00:00</td>
        <td>1073</td>
        <td>2999.85</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1004</td>
        <td>10799.46</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>365</td>
        <td>7978.67</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>957</td>
        <td>6899.54</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>191</td>
        <td>6799.32</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-26 00:00:00</td>
        <td>1014</td>
        <td>4798.08</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>1004</td>
        <td>9599.52</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>191</td>
        <td>5999.40</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>957</td>
        <td>5699.62</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>1073</td>
        <td>5399.73</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-27 00:00:00</td>
        <td>365</td>
        <td>5099.15</td>
        <td>5</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>1004</td>
        <td>5599.72</td>
        <td>1</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>957</td>
        <td>5099.66</td>
        <td>2</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>365</td>
        <td>4799.20</td>
        <td>3</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>403</td>
        <td>4419.66</td>
        <td>4</td>
    </tr>
    <tr>
        <td>2013-07-28 00:00:00</td>
        <td>191</td>
        <td>4299.57</td>
        <td>5</td>
    </tr>
</table></div></div>
</div>
</div>
<div class="section" id="exercises-analytics-functions">
<h2>Exercises - Analytics Functions<a class="headerlink" href="#exercises-analytics-functions" title="Permalink to this headline">¶</a></h2>
<p>Let us take care of the exercises related to analytics functions. We will be using HR database for the same.</p>
<ul class="simple">
<li><p>Get all the employees who is making more than average salary with in each department.</p></li>
<li><p>Get cumulative salary for one of the department along with department name.</p></li>
<li><p>Get top 3 paid employees with in each department by salary (use dense_rank)</p></li>
<li><p>Get top 3 products sold in the month of 2014 January by revenue.</p></li>
<li><p>Get top 3 products in each category sold in the month of 2014 January by revenue.</p></li>
</ul>
<div class="section" id="prepare-hr-database">
<h3>Prepare HR Database<a class="headerlink" href="#prepare-hr-database" title="Permalink to this headline">¶</a></h3>
<p>Here are the steps to prepare HR database.</p>
<ul class="simple">
<li><p>Connect to HR DB using <code class="docutils literal notranslate"><span class="pre">psql</span></code> or SQL Workbench. Here is the sample <code class="docutils literal notranslate"><span class="pre">psql</span></code> command.</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>psql -h localhost <span class="se">\</span>
    -p <span class="m">5432</span> <span class="se">\</span>
    -d itversity_hr_db <span class="se">\</span>
    -U itversity_hr_user <span class="se">\</span>
    -W
</pre></div>
</div>
<ul class="simple">
<li><p>Run scripts to create tables and load the data. You can also drop the tables if they already exists.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>\i /data/hr_db/drop_tables_pg.sql
\i /data/hr_db/create_tables_pg.sql
\i /data/hr_db/load_tables_pg.sql
</pre></div>
</div>
<ul class="simple">
<li><p>Validate to ensure that data is available in the tables by running these queries.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM employees LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> 

SELECT * FROM departments 
ORDER BY manager_id NULLS LAST
LIMIT 10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercise-1">
<h3>Exercise 1<a class="headerlink" href="#exercise-1" title="Permalink to this headline">¶</a></h3>
<p>Get all the employees who is making more than average salary with in each department.</p>
<ul class="simple">
<li><p>Use HR database employees and department tables for this problem.</p></li>
<li><p>Compute average salary expense for each department and get those employee details who are making more salary than average salary.</p></li>
<li><p>Make sure average salary expense per department is rounded off to 2 decimals.</p></li>
<li><p>Output should contain employee_id, department_name, salary and avg_salary_expense (derived field).</p></li>
<li><p>Data should be sorted in ascending order by department_id and descending order by salary.</p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>employee_id</p></th>
<th class="head"><p>department_name</p></th>
<th class="head"><p>salary</p></th>
<th class="head"><p>avg_salary_expense</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>201</p></td>
<td><p>Marketing</p></td>
<td><p>13000.00</p></td>
<td><p>9500.00</p></td>
</tr>
<tr class="row-odd"><td><p>114</p></td>
<td><p>Purchasing</p></td>
<td><p>11000.00</p></td>
<td><p>4150.00</p></td>
</tr>
<tr class="row-even"><td><p>121</p></td>
<td><p>Shipping</p></td>
<td><p>8200.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-odd"><td><p>120</p></td>
<td><p>Shipping</p></td>
<td><p>8000.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-even"><td><p>122</p></td>
<td><p>Shipping</p></td>
<td><p>7900.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-odd"><td><p>123</p></td>
<td><p>Shipping</p></td>
<td><p>6500.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-even"><td><p>124</p></td>
<td><p>Shipping</p></td>
<td><p>5800.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-odd"><td><p>184</p></td>
<td><p>Shipping</p></td>
<td><p>4200.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-even"><td><p>185</p></td>
<td><p>Shipping</p></td>
<td><p>4100.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-odd"><td><p>192</p></td>
<td><p>Shipping</p></td>
<td><p>4000.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-even"><td><p>193</p></td>
<td><p>Shipping</p></td>
<td><p>3900.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-odd"><td><p>188</p></td>
<td><p>Shipping</p></td>
<td><p>3800.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-even"><td><p>137</p></td>
<td><p>Shipping</p></td>
<td><p>3600.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-odd"><td><p>189</p></td>
<td><p>Shipping</p></td>
<td><p>3600.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-even"><td><p>141</p></td>
<td><p>Shipping</p></td>
<td><p>3500.00</p></td>
<td><p>3475.56</p></td>
</tr>
<tr class="row-odd"><td><p>103</p></td>
<td><p>IT</p></td>
<td><p>9000.00</p></td>
<td><p>5760.00</p></td>
</tr>
<tr class="row-even"><td><p>104</p></td>
<td><p>IT</p></td>
<td><p>6000.00</p></td>
<td><p>5760.00</p></td>
</tr>
<tr class="row-odd"><td><p>145</p></td>
<td><p>Sales</p></td>
<td><p>14000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>146</p></td>
<td><p>Sales</p></td>
<td><p>13500.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-odd"><td><p>147</p></td>
<td><p>Sales</p></td>
<td><p>12000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>168</p></td>
<td><p>Sales</p></td>
<td><p>11500.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-odd"><td><p>148</p></td>
<td><p>Sales</p></td>
<td><p>11000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>174</p></td>
<td><p>Sales</p></td>
<td><p>11000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-odd"><td><p>149</p></td>
<td><p>Sales</p></td>
<td><p>10500.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>162</p></td>
<td><p>Sales</p></td>
<td><p>10500.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-odd"><td><p>156</p></td>
<td><p>Sales</p></td>
<td><p>10000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>150</p></td>
<td><p>Sales</p></td>
<td><p>10000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-odd"><td><p>169</p></td>
<td><p>Sales</p></td>
<td><p>10000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>170</p></td>
<td><p>Sales</p></td>
<td><p>9600.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-odd"><td><p>163</p></td>
<td><p>Sales</p></td>
<td><p>9500.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>151</p></td>
<td><p>Sales</p></td>
<td><p>9500.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-odd"><td><p>157</p></td>
<td><p>Sales</p></td>
<td><p>9500.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>158</p></td>
<td><p>Sales</p></td>
<td><p>9000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-odd"><td><p>152</p></td>
<td><p>Sales</p></td>
<td><p>9000.00</p></td>
<td><p>8955.88</p></td>
</tr>
<tr class="row-even"><td><p>100</p></td>
<td><p>Executive</p></td>
<td><p>24000.00</p></td>
<td><p>19333.33</p></td>
</tr>
<tr class="row-odd"><td><p>108</p></td>
<td><p>Finance</p></td>
<td><p>12000.00</p></td>
<td><p>8600.00</p></td>
</tr>
<tr class="row-even"><td><p>109</p></td>
<td><p>Finance</p></td>
<td><p>9000.00</p></td>
<td><p>8600.00</p></td>
</tr>
<tr class="row-odd"><td><p>205</p></td>
<td><p>Accounting</p></td>
<td><p>12000.00</p></td>
<td><p>10150.00</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_hr_user:hr_password@localhost:5432/itversity_hr_db
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercise-2">
<h3>Exercise 2<a class="headerlink" href="#exercise-2" title="Permalink to this headline">¶</a></h3>
<p>Get cumulative salary with in each department for Finance and IT department along with department name.</p>
<ul class="simple">
<li><p>Use HR database employees and department tables for this problem.</p></li>
<li><p>Compute cumulative salary expense for <strong>Finance</strong> as well as <strong>IT</strong> departments with in respective departments.</p></li>
<li><p>Make sure cumulative salary expense per department is rounded off to 2 decimals.</p></li>
<li><p>Output should contain employee_id, department_name, salary and cum_salary_expense (derived field).</p></li>
<li><p>Data should be sorted in ascending order by department_name and then salary.</p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>employee_id</p></th>
<th class="head"><p>department_name</p></th>
<th class="head"><p>salary</p></th>
<th class="head"><p>cum_salary_expense</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>113</p></td>
<td><p>Finance</p></td>
<td><p>6900.00</p></td>
<td><p>6900.00</p></td>
</tr>
<tr class="row-odd"><td><p>111</p></td>
<td><p>Finance</p></td>
<td><p>7700.00</p></td>
<td><p>14600.00</p></td>
</tr>
<tr class="row-even"><td><p>112</p></td>
<td><p>Finance</p></td>
<td><p>7800.00</p></td>
<td><p>22400.00</p></td>
</tr>
<tr class="row-odd"><td><p>110</p></td>
<td><p>Finance</p></td>
<td><p>8200.00</p></td>
<td><p>30600.00</p></td>
</tr>
<tr class="row-even"><td><p>109</p></td>
<td><p>Finance</p></td>
<td><p>9000.00</p></td>
<td><p>39600.00</p></td>
</tr>
<tr class="row-odd"><td><p>108</p></td>
<td><p>Finance</p></td>
<td><p>12000.00</p></td>
<td><p>51600.00</p></td>
</tr>
<tr class="row-even"><td><p>107</p></td>
<td><p>IT</p></td>
<td><p>4200.00</p></td>
<td><p>4200.00</p></td>
</tr>
<tr class="row-odd"><td><p>106</p></td>
<td><p>IT</p></td>
<td><p>4800.00</p></td>
<td><p>9000.00</p></td>
</tr>
<tr class="row-even"><td><p>105</p></td>
<td><p>IT</p></td>
<td><p>4800.00</p></td>
<td><p>13800.00</p></td>
</tr>
<tr class="row-odd"><td><p>104</p></td>
<td><p>IT</p></td>
<td><p>6000.00</p></td>
<td><p>19800.00</p></td>
</tr>
<tr class="row-even"><td><p>103</p></td>
<td><p>IT</p></td>
<td><p>9000.00</p></td>
<td><p>28800.00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="exercise-3">
<h3>Exercise 3<a class="headerlink" href="#exercise-3" title="Permalink to this headline">¶</a></h3>
<p>Get top 3 paid employees with in each department by salary (use dense_rank)</p>
<ul class="simple">
<li><p>Use HR database employees and department tables for this problem.</p></li>
<li><p>Highest paid employee should be ranked first.</p></li>
<li><p>Output should contain employee_id, department_id, department_name, salary and employee_rank (derived field).</p></li>
<li><p>Data should be sorted in ascending order by department_id in ascending order and then salary in descending order.</p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>employee_id</p></th>
<th class="head"><p>department_id</p></th>
<th class="head"><p>department_name</p></th>
<th class="head"><p>salary</p></th>
<th class="head"><p>employee_rank</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>200</p></td>
<td><p>10</p></td>
<td><p>Administration</p></td>
<td><p>4400.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>201</p></td>
<td><p>20</p></td>
<td><p>Marketing</p></td>
<td><p>13000.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>202</p></td>
<td><p>20</p></td>
<td><p>Marketing</p></td>
<td><p>6000.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>114</p></td>
<td><p>30</p></td>
<td><p>Purchasing</p></td>
<td><p>11000.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>115</p></td>
<td><p>30</p></td>
<td><p>Purchasing</p></td>
<td><p>3100.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>116</p></td>
<td><p>30</p></td>
<td><p>Purchasing</p></td>
<td><p>2900.00</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>203</p></td>
<td><p>40</p></td>
<td><p>Human Resources</p></td>
<td><p>6500.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>121</p></td>
<td><p>50</p></td>
<td><p>Shipping</p></td>
<td><p>8200.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>120</p></td>
<td><p>50</p></td>
<td><p>Shipping</p></td>
<td><p>8000.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>122</p></td>
<td><p>50</p></td>
<td><p>Shipping</p></td>
<td><p>7900.00</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>103</p></td>
<td><p>60</p></td>
<td><p>IT</p></td>
<td><p>9000.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>104</p></td>
<td><p>60</p></td>
<td><p>IT</p></td>
<td><p>6000.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>105</p></td>
<td><p>60</p></td>
<td><p>IT</p></td>
<td><p>4800.00</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>106</p></td>
<td><p>60</p></td>
<td><p>IT</p></td>
<td><p>4800.00</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>204</p></td>
<td><p>70</p></td>
<td><p>Public Relations</p></td>
<td><p>10000.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>145</p></td>
<td><p>80</p></td>
<td><p>Sales</p></td>
<td><p>14000.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>146</p></td>
<td><p>80</p></td>
<td><p>Sales</p></td>
<td><p>13500.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>147</p></td>
<td><p>80</p></td>
<td><p>Sales</p></td>
<td><p>12000.00</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>100</p></td>
<td><p>90</p></td>
<td><p>Executive</p></td>
<td><p>24000.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>101</p></td>
<td><p>90</p></td>
<td><p>Executive</p></td>
<td><p>17000.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>102</p></td>
<td><p>90</p></td>
<td><p>Executive</p></td>
<td><p>17000.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>108</p></td>
<td><p>100</p></td>
<td><p>Finance</p></td>
<td><p>12000.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>109</p></td>
<td><p>100</p></td>
<td><p>Finance</p></td>
<td><p>9000.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>110</p></td>
<td><p>100</p></td>
<td><p>Finance</p></td>
<td><p>8200.00</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>205</p></td>
<td><p>110</p></td>
<td><p>Accounting</p></td>
<td><p>12000.00</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>206</p></td>
<td><p>110</p></td>
<td><p>Accounting</p></td>
<td><p>8300.00</p></td>
<td><p>2</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="exercise-4">
<h3>Exercise 4<a class="headerlink" href="#exercise-4" title="Permalink to this headline">¶</a></h3>
<p>Get top 3 products sold in the month of 2014 January by revenue.</p>
<ul class="simple">
<li><p>Use retail database tables such as orders, order_items and products.</p></li>
<li><p>Highest revenue generating product should come at top.</p></li>
<li><p>Output should contain product_id, product_name, revenue, product_rank. <strong>revenue</strong> and <strong>product_rank</strong> are derived fields.</p></li>
<li><p>Data should be sorted in descending order by revenue.</p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>product_id</p></th>
<th class="head"><p>product_name</p></th>
<th class="head"><p>revenue</p></th>
<th class="head"><p>product_rank</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1004</p></td>
<td><p>Field &amp; Stream Sportsman 16 Gun Fire Safe</p></td>
<td><p>250787.46</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>365</p></td>
<td><p>Perfect Fitness Perfect Rip Deck</p></td>
<td><p>151474.75</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>957</p></td>
<td><p>Diamondback Women’s Serene Classic Comfort Bi</p></td>
<td><p>148190.12</p></td>
<td><p>3</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="exercise-5">
<h3>Exercise 5<a class="headerlink" href="#exercise-5" title="Permalink to this headline">¶</a></h3>
<p>Get top 3 products sold in the month of 2014 January under selected categories by revenue. The categories are <strong>Cardio Equipment</strong> and <strong>Strength Training</strong>.</p>
<ul class="simple">
<li><p>Use retail database tables such as orders, order_items, products as well as categories.</p></li>
<li><p>Highest revenue generating product should come at top.</p></li>
<li><p>Output should contain category_id, category_name, product_id, product_name, revenue, product_rank. revenue and product_rank are derived fields.</p></li>
<li><p>Data should be sorted in ascending order by category_id and descending order by revenue.</p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>category_id</p></th>
<th class="head"><p>category_name</p></th>
<th class="head"><p>product_id</p></th>
<th class="head"><p>product_name</p></th>
<th class="head"><p>revenue</p></th>
<th class="head"><p>product_rank</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>9</p></td>
<td><p>Cardio Equipment</p></td>
<td><p>191</p></td>
<td><p>Nike Men’s Free 5.0+ Running Shoe</p></td>
<td><p>132286.77</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>9</p></td>
<td><p>Cardio Equipment</p></td>
<td><p>172</p></td>
<td><p>Nike Women’s Tempo Shorts</p></td>
<td><p>870.00</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>10</p></td>
<td><p>Strength Training</p></td>
<td><p>208</p></td>
<td><p>SOLE E35 Elliptical</p></td>
<td><p>1999.99</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>10</p></td>
<td><p>Strength Training</p></td>
<td><p>203</p></td>
<td><p>GoPro HERO3+ Black Edition Camera</p></td>
<td><p>1199.97</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>10</p></td>
<td><p>Strength Training</p></td>
<td><p>216</p></td>
<td><p>Yakima DoubleDown Ace Hitch Mount 4-Bike Rack</p></td>
<td><p>189.00</p></td>
<td><p>3</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="06_predefined_functions.html" title="previous page">Pre-Defined Functions</a>
    <a class='right-next' id="next-link" href="08_query_performance_tuning.html" title="next page">Query Performance Tuning</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>