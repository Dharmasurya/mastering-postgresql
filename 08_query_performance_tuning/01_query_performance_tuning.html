
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Query Performance Tuning &#8212; My Jupyter Book</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">My Jupyter Book</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../mastering-postgresql.html">
   Mastering Postgresql
  </a>
 </li>
</ul>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../01_getting_started/01_getting_started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02_dml_or_crud_operations/01_dml_or_crud_operations.html">
   DML or CRUD Operations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../03_writing_basic_sql_queries/01_writing_basic_sql_queries.html">
   Writing Basic SQL Queries
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/08_query_performance_tuning/01_query_performance_tuning.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/08_query_performance_tuning/01_query_performance_tuning.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preparing-database">
   Preparing Database
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interpreting-explain-plans">
   Interpreting Explain Plans
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-cost-based-optimizer">
   Overview of Cost Based Optimizer
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance-tuning-using-indexes">
   Performance Tuning using Indexes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#criteria-for-indexing">
   Criteria for Indexing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#criteria-for-partitioning">
   Criteria for Partitioning
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#writing-queries-partition-pruning">
   Writing Queries – Partition Pruning
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-query-hints">
   Overview of Query Hints
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-tuning-queries">
   Exercise - Tuning Queries
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="query-performance-tuning">
<h1>Query Performance Tuning<a class="headerlink" href="#query-performance-tuning" title="Permalink to this headline">¶</a></h1>
<p>As part of this section we will go through basic performance tuning techniques with respect to queries.</p>
<ul class="simple">
<li><p>Preparing Database</p></li>
<li><p>Interpreting Explain Plans</p></li>
<li><p>Overview of Cost Based Optimizer</p></li>
<li><p>Performance Tuning using Indexes</p></li>
<li><p>Criteria for indexes</p></li>
<li><p>Criteria for Partitioning</p></li>
<li><p>Writing Queries – Partition Pruning</p></li>
<li><p>Overview of Query Hints</p></li>
</ul>
<div class="section" id="preparing-database">
<h2>Preparing Database<a class="headerlink" href="#preparing-database" title="Permalink to this headline">¶</a></h2>
<p>Let us prepare retail tables to come up with the solution for the problem statement.</p>
<ul class="simple">
<li><p>Ensure that we have required database and user for retail data. We might provide the database as part of our labs.</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>psql -U postgres -h localhost -p <span class="m">5432</span> -W
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">itversity_retail_db</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="n">itversity_retail_user</span> <span class="k">WITH</span> <span class="k">ENCRYPTED</span> <span class="n">PASSWORD</span> <span class="s1">&#39;retail_password&#39;</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="k">DATABASE</span> <span class="n">itversity_retail_db</span> <span class="k">TO</span> <span class="n">itversity_retail_user</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Create Tables using the script provided. You can either use <code class="docutils literal notranslate"><span class="pre">psql</span></code> or <strong>SQL Alchemy</strong>.</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>psql -U itversity_retail_user <span class="se">\</span>
  -h localhost <span class="se">\</span>
  -p <span class="m">5432</span> <span class="se">\</span>
  -d itversity_retail_db <span class="se">\</span>
  -W

<span class="se">\i</span> /data/retail_db/create_db_tables_pg.sql
</pre></div>
</div>
<ul class="simple">
<li><p>Data shall be loaded using the script provided.</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="se">\i</span> /data/retail_db/load_db_tables_pg.sql
</pre></div>
</div>
<ul class="simple">
<li><p>Run queries to validate we have data in all the 6 tables.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM departments LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM categories LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM products LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM orders LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM order_items LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM customers LIMIT 10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="interpreting-explain-plans">
<h2>Interpreting Explain Plans<a class="headerlink" href="#interpreting-explain-plans" title="Permalink to this headline">¶</a></h2>
<p>Let us review the below explain plans and understand key terms which will help us in interpreting them.</p>
<ul class="simple">
<li><p>Seq Scan</p></li>
<li><p>Index Scan</p></li>
<li><p>Nested Loop</p></li>
</ul>
<p>Here are the explain plans for different queries.</p>
<ul class="simple">
<li><p>Explain plan for query to get number of orders.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">orders</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                            QUERY PLAN
-------------------------------------------------------------------
 Aggregate  (cost=1386.04..1386.05 rows=1 width=8)
   -&gt;  Seq Scan on orders  (cost=0.00..1213.83 rows=68883 width=0)
(2 rows)
</pre></div>
</div>
<ul class="simple">
<li><p>Explain plan for query to get number of orders by date.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> <span class="n">order_date</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">order_count</span>
<span class="k">FROM</span> <span class="n">orders</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">order_date</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                            QUERY PLAN
-------------------------------------------------------------------
 HashAggregate  (cost=1558.24..1561.88 rows=364 width=16)
   Group Key: order_date
   -&gt;  Seq Scan on orders  (cost=0.00..1213.83 rows=68883 width=8)
(3 rows)
</pre></div>
</div>
<ul class="simple">
<li><p>Explain plan for query to get order details for a given order id.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">orders</span>
<span class="k">WHERE</span> <span class="n">order_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                                QUERY PLAN
---------------------------------------------------------------------------
 Index Scan using orders_pkey on orders  (cost=0.29..8.31 rows=1 width=26)
   Index Cond: (order_id = 2)
(2 rows)
</pre></div>
</div>
<ul class="simple">
<li><p>Explain plan for query to get order and order item details for a given order id.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> <span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
    <span class="n">oi</span><span class="p">.</span><span class="n">order_item_subtotal</span>
<span class="k">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="p">.</span><span class="n">order_item_order_id</span>
<span class="k">WHERE</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                                    QUERY PLAN
-----------------------------------------------------------------------------------
 Nested Loop  (cost=0.29..3427.82 rows=4 width=34)
   -&gt;  Index Scan using orders_pkey on orders o  (cost=0.29..8.31 rows=1 width=26)
         Index Cond: (order_id = 2)
   -&gt;  Seq Scan on order_items oi  (cost=0.00..3419.47 rows=4 width=12)
         Filter: (order_item_order_id = 2)
(5 rows)
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We should understand the order in which the query plans should be interpreted.</p>
</div>
<ul class="simple">
<li><p>Explain plan for a query with multiple joins</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> 
    <span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">,</span>
    <span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">,</span>
    <span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span>
    <span class="k">c</span><span class="p">.</span><span class="n">category_name</span><span class="p">,</span>
    <span class="n">p</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">oi</span><span class="p">.</span><span class="n">order_item_subtotal</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">revenue</span>
<span class="k">FROM</span> <span class="n">orders</span> <span class="n">o</span>
    <span class="k">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
        <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="p">.</span><span class="n">order_item_order_id</span>
    <span class="k">JOIN</span> <span class="n">products</span> <span class="n">p</span>
        <span class="k">ON</span> <span class="n">p</span><span class="p">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">oi</span><span class="p">.</span><span class="n">order_item_product_id</span>
    <span class="k">JOIN</span> <span class="n">categories</span> <span class="k">c</span>
        <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">product_category_id</span>
    <span class="k">JOIN</span> <span class="n">departments</span> <span class="n">d</span>
        <span class="k">ON</span> <span class="n">d</span><span class="p">.</span><span class="n">department_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">category_department_id</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">,</span>
    <span class="n">d</span><span class="p">.</span><span class="n">department_id</span><span class="p">,</span>
    <span class="n">d</span><span class="p">.</span><span class="n">department_name</span><span class="p">,</span>
    <span class="k">c</span><span class="p">.</span><span class="n">category_id</span><span class="p">,</span>
    <span class="k">c</span><span class="p">.</span><span class="n">category_name</span><span class="p">,</span>
    <span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span>
    <span class="n">p</span><span class="p">.</span><span class="n">product_name</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">,</span>
    <span class="n">revenue</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                                                              QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------
 Sort  (cost=76368.54..76799.03 rows=172198 width=211)
   Sort Key: o.order_date, (round((sum(oi.order_item_subtotal))::numeric, 2)) DESC
   -&gt;  Finalize GroupAggregate  (cost=25958.31..43735.23 rows=172198 width=211)
         Group Key: o.order_date, d.department_id, c.category_id, p.product_id
         -&gt;  Gather Merge  (cost=25958.31..39886.09 rows=101293 width=187)
               Workers Planned: 1
               -&gt;  Partial GroupAggregate  (cost=24958.30..27490.62 rows=101293 width=187)
                     Group Key: o.order_date, d.department_id, c.category_id, p.product_id
                     -&gt;  Sort  (cost=24958.30..25211.53 rows=101293 width=187)
                           Sort Key: o.order_date, d.department_id, c.category_id, p.product_id
                           -&gt;  Hash Join  (cost=2495.48..7188.21 rows=101293 width=187)
                                 Hash Cond: (c.category_department_id = d.department_id)
                                 -&gt;  Hash Join  (cost=2472.43..6897.32 rows=101293 width=79)
                                       Hash Cond: (p.product_category_id = c.category_id)
                                       -&gt;  Hash Join  (cost=2470.13..6609.69 rows=101293 width=63)
                                             Hash Cond: (oi.order_item_product_id = p.product_id)
                                             -&gt;  Hash Join  (cost=2411.87..6284.70 rows=101293 width=20)
                                                   Hash Cond: (oi.order_item_order_id = o.order_id)
                                                   -&gt;  Parallel Seq Scan on order_items oi  (cost=0.00..2279.93 rows=101293 width=16)
                                                   -&gt;  Hash  (cost=1213.83..1213.83 rows=68883 width=12)
                                                         -&gt;  Seq Scan on orders o  (cost=0.00..1213.83 rows=68883 width=12)
                                             -&gt;  Hash  (cost=41.45..41.45 rows=1345 width=47)
                                                   -&gt;  Seq Scan on products p  (cost=0.00..41.45 rows=1345 width=47)
                                       -&gt;  Hash  (cost=1.58..1.58 rows=58 width=20)
                                             -&gt;  Seq Scan on categories c  (cost=0.00..1.58 rows=58 width=20)
                                 -&gt;  Hash  (cost=15.80..15.80 rows=580 width=112)
                                       -&gt;  Seq Scan on departments d  (cost=0.00..15.80 rows=580 width=112)
(27 rows)
</pre></div>
</div>
</div>
<div class="section" id="overview-of-cost-based-optimizer">
<h2>Overview of Cost Based Optimizer<a class="headerlink" href="#overview-of-cost-based-optimizer" title="Permalink to this headline">¶</a></h2>
<p>Let us get an overview of cost based optimizer.</p>
<ul class="simple">
<li><p>Databases use cost based optimizer to generate explain plans. In the earlier days, they used to use rule based optimizer.</p></li>
<li><p>For cost based optimizer to generate optimal explain plan, we need to ensure statistics of our data in tables are collected at regular times.</p></li>
<li><p>We can analyze tables to collect statistics. Typically DBAs schedule to collect statistics at regular intervals.</p></li>
<li><p>Here are some of the statistics typically collected.</p>
<ul>
<li><p>Approximate number of records at table level.</p></li>
<li><p>Approximate number of unique records at index level.</p></li>
</ul>
</li>
<li><p>When explain plans are generated, these statistics will be used by cost based optimizer to provide us with the most optimal plan for our query.</p></li>
</ul>
</div>
<div class="section" id="performance-tuning-using-indexes">
<h2>Performance Tuning using Indexes<a class="headerlink" href="#performance-tuning-using-indexes" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can improve the performance of the query by creating index on order_items.order_item_order_id.</p>
<ul class="simple">
<li><p>We have order level details in orders and item level details in order_items.</p></li>
<li><p>When customer want to review their orders, they need details about order_items. In almost all the scenarios in order management system, we prefer to get both order as well as order_items details by passing order_id of pending or outstanding orders.</p></li>
<li><p>Let us review the explain plan for the query with out index on order_items.order_item_order_id.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> <span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
    <span class="n">oi</span><span class="p">.</span><span class="n">order_item_subtotal</span>
<span class="k">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="p">.</span><span class="n">order_item_order_id</span>
<span class="k">WHERE</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Develop piece of code to randomly pass 2000 order ids and calculate time.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install psycopg2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5432&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;itversity_retail_db&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;itversity_retail_user&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s1">&#39;retail_password&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT count(1) </span>
<span class="s1">FROM orders o JOIN order_items oi </span>
<span class="s1">    ON o.order_id = oi.order_item_order_id</span>
<span class="s1">WHERE o.order_id = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ctr</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Create index on order_items.order_item_order_id</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE INDEX order_items_order_id_idx 
ON order_items(order_item_order_id);
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Run explain plan after creating index on order_items.order_item_order_id</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> <span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
    <span class="n">oi</span><span class="p">.</span><span class="n">order_item_subtotal</span>
<span class="k">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="p">.</span><span class="n">order_item_order_id</span>
<span class="k">WHERE</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                                              QUERY PLAN
------------------------------------------------------------------------------------------------------
 Nested Loop  (cost=0.71..16.81 rows=3 width=34)
   -&gt;  Index Scan using orders_pkey on orders o  (cost=0.29..8.31 rows=1 width=26)
         Index Cond: (order_id = 2)
   -&gt;  Index Scan using order_items_order_id_idx on order_items oi  (cost=0.42..8.47 rows=3 width=12)
         Index Cond: (order_item_order_id = 2)
(5 rows)
</pre></div>
</div>
<ul class="simple">
<li><p>Run the code again to see how much time, it get the results for 2000 random orders.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5432&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;itversity_retail_db&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;itversity_retail_user&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s1">&#39;retail_password&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT count(1) </span>
<span class="s1">FROM orders o JOIN order_items oi </span>
<span class="s1">    ON o.order_id = oi.order_item_order_id</span>
<span class="s1">WHERE o.order_id = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ctr</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">order_id</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">68883</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">order_id</span><span class="p">,))</span>
    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Keep in mind that having indexes on tables can have negative impact on write operations.</p>
</div>
</div>
<div class="section" id="criteria-for-indexing">
<h2>Criteria for Indexing<a class="headerlink" href="#criteria-for-indexing" title="Permalink to this headline">¶</a></h2>
<p>Let us go through some of the criteria to create indexes on tables.</p>
<ul class="simple">
<li><p>Indexes are required to enforce constraints such as Primary Key, Unique etc. Indexes will be automatically created, when we define a column(s) Primary Key or Unique.</p></li>
<li><p>Too many indexes on a given table, can slow down the performance of inserts, updates and deletes on that table. Hence, you need to make sure to strike right balance by creating indexes only when they are required.</p></li>
<li><p>Thorough analysis need to be done about how the queries will hit the table from the application.</p></li>
<li><p>We might have to create indexes on foreign key columns of the child table.</p></li>
<li><p>When we have tables with multiple parents, we need to be due diligent about how the index should be created.</p>
<ul>
<li><p>Shall we create 2 indexes?</p></li>
<li><p>Shall we create 1 index with both the columns pointing to 2 tables?</p></li>
<li><p>If we want to create 1 index with both the columns what should be the order?</p></li>
</ul>
</li>
<li><p>Here are some of the scenarios from the application perspective based upon which we can consider creating indexes.</p>
<ul>
<li><p>Customer checking all his orders.</p>
<ul>
<li><p>We need to get the data from orders using customer id and hence we need to add index on <strong>orders.order_customer_id</strong>.</p></li>
</ul>
</li>
<li><p>Customer checking order details for a given order which include order_item_subtotal as well as product names.</p>
<ul>
<li><p>We need to join <strong>orders</strong>, <strong>order_items</strong> as well as <strong>products</strong>.</p></li>
<li><p><strong>order_items</strong> is child table for both <strong>orders</strong> and <strong>products</strong>.</p></li>
<li><p>We can create composite index on <strong>order_items.order_item_order_id</strong> and <strong>order_items.order_item_product_id</strong>.</p></li>
</ul>
</li>
<li><p>Customer care executive to check <strong>all the order details placed by customer using at least first 3 characters of customer’s first name</strong>.</p>
<ul>
<li><p>We can consider creating index on <strong>customers.customer_fname</strong> using upper or lower. You can also consider adding <strong>customer_id</strong> to the index along with customer_fname.</p></li>
<li><p>Also to get all the order details for a given customer, we have to ensure that there is an index on <strong>orders.order_customer_id</strong>.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP INDEX order_items_order_id_idx
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT min(customer_id), max(customer_id), count(1)
FROM customers
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5432&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;itversity_retail_db&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;itversity_retail_user&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s1">&#39;retail_password&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT count(1) </span>
<span class="s1">FROM orders o</span>
<span class="s1">WHERE order_customer_id = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ctr</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">10950</span><span class="p">,</span> <span class="mi">12435</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">customer_id</span><span class="p">,))</span>
    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE INDEX orders_customer_id_idx
ON orders(order_customer_id)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5432&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;itversity_retail_db&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;itversity_retail_user&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s1">&#39;retail_password&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT count(1) </span>
<span class="s1">FROM orders o</span>
<span class="s1">WHERE order_customer_id = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ctr</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">10950</span><span class="p">,</span> <span class="mi">12435</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">customer_id</span><span class="p">,))</span>
    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5432&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;itversity_retail_db&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;itversity_retail_user&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s1">&#39;retail_password&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT count(1) </span>
<span class="s1">FROM orders o</span>
<span class="s1">    JOIN order_items oi</span>
<span class="s1">        ON o.order_id = oi.order_item_order_id</span>
<span class="s1">    JOIN products p</span>
<span class="s1">        ON p.product_id = oi.order_item_product_id</span>
<span class="s1">WHERE order_id = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ctr</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">order_id</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">68883</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">order_id</span><span class="p">,))</span>
    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE INDEX order_items_oid_pid_idx 
ON order_items(order_item_order_id, order_item_product_id);
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5432&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;itversity_retail_db&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;itversity_retail_user&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s1">&#39;retail_password&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT count(1) </span>
<span class="s1">FROM orders o</span>
<span class="s1">    JOIN order_items oi</span>
<span class="s1">        ON o.order_id = oi.order_item_order_id</span>
<span class="s1">    JOIN products p</span>
<span class="s1">        ON p.product_id = oi.order_item_product_id</span>
<span class="s1">WHERE order_id = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ctr</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">order_id</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">68883</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">order_id</span><span class="p">,))</span>
    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As our products table only have handful of records there will not be significant difference in performance between the 2 approaches.</p>
<ul class="simple">
<li><p>Index on order_items.order_item_order_id</p></li>
<li><p>Index on order_items.order_item_order_id, order_items.order_item_product_id</p></li>
</ul>
<p>Howeever if you create index using product id as driving field then the performance will not be as good as above 2 approaches.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP INDEX order_items_oid_pid_idx
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE INDEX order_items_pid_oid_idx 
ON order_items(order_item_product_id, order_item_order_id);
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="s1">&#39;5432&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;itversity_retail_db&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;itversity_retail_user&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s1">&#39;retail_password&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT count(1) </span>
<span class="s1">FROM orders o</span>
<span class="s1">    JOIN order_items oi</span>
<span class="s1">        ON o.order_id = oi.order_item_order_id</span>
<span class="s1">    JOIN products p</span>
<span class="s1">        ON p.product_id = oi.order_item_product_id</span>
<span class="s1">WHERE order_id = </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ctr</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">order_id</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">68883</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">order_id</span><span class="p">,))</span>
    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here are the indexes to tune the performance of comparing with at least first 3 characters of customer first name.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP INDEX IF EXISTS orders_customer_id_idx
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

DROP INDEX IF EXISTS customers_customer_fname_idx
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Explain plan for query with out indexes.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">JOIN</span> <span class="n">customers</span> <span class="k">c</span>
    <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">order_customer_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
<span class="k">WHERE</span> <span class="k">upper</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">customer_fname</span><span class="p">)</span> <span class="o">=</span> <span class="k">upper</span><span class="p">(</span><span class="s1">&#39;mar&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                               QUERY PLAN
-------------------------------------------------------------------------
 Hash Join  (cost=42.38..1437.09 rows=40 width=99)
   Hash Cond: (o.order_customer_id = c.customer_id)
   -&gt;  Seq Scan on orders o  (cost=0.00..1213.83 rows=68883 width=26)
   -&gt;  Hash  (cost=42.29..42.29 rows=7 width=73)
         -&gt;  Seq Scan on customers c  (cost=0.00..42.29 rows=7 width=73)
               Filter: (upper((customer_fname)::text) = &#39;MAR&#39;::text)
(6 rows)
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE INDEX customers_customer_fname_idx
ON customers(upper(customer_fname))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

CREATE INDEX orders_customer_id_idx
ON orders(order_customer_id)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Explain plan for query with indexes. Check the cost, it is significantly low when compared to the plan generated for the same query with out indexes.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span>
<span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">JOIN</span> <span class="n">customers</span> <span class="k">c</span>
    <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">order_customer_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
<span class="k">WHERE</span> <span class="k">upper</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">customer_fname</span><span class="p">)</span> <span class="o">=</span> <span class="k">upper</span><span class="p">(</span><span class="s1">&#39;mar&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>                                           QUERY PLAN
-------------------------------------------------------------------------------------------------
 Nested Loop  (cost=8.67..204.43 rows=40 width=99)
   -&gt;  Bitmap Heap Scan on customers c  (cost=4.33..18.58 rows=7 width=73)
         Recheck Cond: (upper((customer_fname)::text) = &#39;MAR&#39;::text)
         -&gt;  Bitmap Index Scan on customers_customer_fname_idx  (cost=0.00..4.33 rows=7 width=0)
               Index Cond: (upper((customer_fname)::text) = &#39;MAR&#39;::text)
   -&gt;  Bitmap Heap Scan on orders o  (cost=4.34..26.49 rows=6 width=26)
         Recheck Cond: (order_customer_id = c.customer_id)
         -&gt;  Bitmap Index Scan on orders_customer_id_idx  (cost=0.00..4.34 rows=6 width=0)
               Index Cond: (order_customer_id = c.customer_id)
(9 rows)
</pre></div>
</div>
</div>
<div class="section" id="criteria-for-partitioning">
<h2>Criteria for Partitioning<a class="headerlink" href="#criteria-for-partitioning" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can leverage partitioning to fine tune the performance.</p>
<ul class="simple">
<li><p>Partitioning is another key strategy to boost the performance of the queries.</p></li>
<li><p>It is extensively used as key performance tuning strategy as part of tables created to support reporting requirements.</p></li>
<li><p>Even in transactional systems, we can leverage partitioning as one of the performance tuning technique while dealing with large tables.</p></li>
<li><p>For application log tables, we might want to discard all the irrelevant data after specific time period. If partitioning is used, we can detach and/or drop the paritions quickly.</p></li>
<li><p>Over a period of time most of the orders will be in <strong>CLOSED</strong> status. We can partition table using list parititioning to ensure that all the <strong>CLOSED</strong> orders are moved to another partition. It can improve the performance for the activity related to active orders.</p></li>
<li><p>In case of reporting databases, we might partition the transaction tables at daily level so that we can easily filter and process data to pre-aggregate and store in the reporting data marts.</p></li>
<li><p>Most of the tables in ODS or Data Lake will be timestamped and partitioned at daily or monthly level so that we can remove or archive old partitions easily</p></li>
</ul>
</div>
<div class="section" id="writing-queries-partition-pruning">
<h2>Writing Queries – Partition Pruning<a class="headerlink" href="#writing-queries-partition-pruning" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to write queries by leveraging partitioing.</p>
<ul class="simple">
<li><p>Make sure to include a condition on partitioned column.</p></li>
<li><p>Equal condition will yield better results.</p></li>
<li><p>Queries with condition on partition key will result in partition pruning. The data from the other partitions will be fully ignored.</p></li>
<li><p>As partition pruning will result in lesser I/O, the overall performance of such queries will improve drastically.</p></li>
</ul>
</div>
<div class="section" id="overview-of-query-hints">
<h2>Overview of Query Hints<a class="headerlink" href="#overview-of-query-hints" title="Permalink to this headline">¶</a></h2>
<p>Let us get an overview of query hints.</p>
<ul class="simple">
<li><p>We can specify hint using /*+ HINT */ as part of the query.</p></li>
<li><p>Make sure there are no typos in the hint.</p></li>
<li><p>If there are typos or there no indexes specified as part of hint, they will be ignored.</p></li>
<li><p>In case of complex queries, CBO might use incorrect index or inappropriate join.</p></li>
<li><p>As an expert if we are sure that, the query should be using a particular index or right join, then we can force the optimizer to choose such index or join type leveraging hint.</p></li>
</ul>
</div>
<div class="section" id="exercise-tuning-queries">
<h2>Exercise - Tuning Queries<a class="headerlink" href="#exercise-tuning-queries" title="Permalink to this headline">¶</a></h2>
<p>As part of this exercise, you need to prepare data set, go through the explain plan and come up with right indexes to tune the performance.</p>
<ul class="simple">
<li><p>As of now customer email id in customers table contain same value (<strong>XXXXXXXXX</strong>).</p></li>
<li><p>Let us update customer_email_id.</p>
<ul>
<li><p>Use initial (first character) of customer_fname</p></li>
<li><p>Use full string of customer_lname</p></li>
<li><p>Use row_number by grouping or partitioning the data by first character of customer_fname and full customer_lname then sort it by customer_id.</p></li>
<li><p>Make sure row_number is at least 3 digits, if not pad with 0 and concatenate to email id. Here are the examples</p></li>
<li><p>Also make sure email ids are in upper case.
|customer_id|customer_fname|customer_lname|rank|customer_email|
|———–|————–|————–|—-|————–|
|11591|Ann|Alexander|1|AALEXANDER001&#64;SOME.COM|
|12031|Ashley|Benitez|1|ABENITEZ001&#64;SOME.COM|
|11298|Anthony|Best|1|ABEST001&#64;SOME.COM|
|11304|Alexander|Campbell|1|ACAMPBELL001&#64;SOME.COM|
|11956|Alan|Campos|1|ACAMPOS001&#64;SOME.COM|
|12075|Aaron|Carr|1|ACARR001&#64;SOME.COM|
|12416|Aaron|Cline|1|ACLINE001&#64;SOME.COM|
|10967|Alexander|Cunningham|1|ACUNNINGHAM001&#64;SOME.COM|
|12216|Ann|Deleon|1|ADELEON001&#64;SOME.COM|
|11192|Andrew|Dickson|1|ADICKSON001&#64;SOME.COM|</p></li>
</ul>
</li>
<li><p>Let us assume that customer care will try to search for customer details using at least first 4 characters.</p></li>
<li><p>Generate explain plan for the query.</p></li>
<li><p>Create unique index on customer_email.</p></li>
<li><p>Generate explain plan again and review the differences.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5432/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT q.*,
    upper(concat(substring(customer_fname, 1, 1), customer_lname, lpad(rnk::varchar, 3, &#39;0&#39;), &#39;@SOME.COM&#39;)) AS customer_email
FROM (  
    SELECT customer_id,
        customer_fname,
        customer_lname,
        rank() OVER (
            PARTITION BY substring(customer_fname, 1, 1), customer_lname
            ORDER BY customer_id
        ) AS rnk
    FROM customers
) q
ORDER BY customer_email
LIMIT 10
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://itversity_retail_user:***@localhost:5432/itversity_retail_db
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <tr>
        <th>customer_id</th>
        <th>customer_fname</th>
        <th>customer_lname</th>
        <th>rnk</th>
        <th>customer_email</th>
    </tr>
    <tr>
        <td>11591</td>
        <td>Ann</td>
        <td>Alexander</td>
        <td>1</td>
        <td>AALEXANDER001@SOME.COM</td>
    </tr>
    <tr>
        <td>12031</td>
        <td>Ashley</td>
        <td>Benitez</td>
        <td>1</td>
        <td>ABENITEZ001@SOME.COM</td>
    </tr>
    <tr>
        <td>11298</td>
        <td>Anthony</td>
        <td>Best</td>
        <td>1</td>
        <td>ABEST001@SOME.COM</td>
    </tr>
    <tr>
        <td>11304</td>
        <td>Alexander</td>
        <td>Campbell</td>
        <td>1</td>
        <td>ACAMPBELL001@SOME.COM</td>
    </tr>
    <tr>
        <td>11956</td>
        <td>Alan</td>
        <td>Campos</td>
        <td>1</td>
        <td>ACAMPOS001@SOME.COM</td>
    </tr>
    <tr>
        <td>12075</td>
        <td>Aaron</td>
        <td>Carr</td>
        <td>1</td>
        <td>ACARR001@SOME.COM</td>
    </tr>
    <tr>
        <td>12416</td>
        <td>Aaron</td>
        <td>Cline</td>
        <td>1</td>
        <td>ACLINE001@SOME.COM</td>
    </tr>
    <tr>
        <td>10967</td>
        <td>Alexander</td>
        <td>Cunningham</td>
        <td>1</td>
        <td>ACUNNINGHAM001@SOME.COM</td>
    </tr>
    <tr>
        <td>12216</td>
        <td>Ann</td>
        <td>Deleon</td>
        <td>1</td>
        <td>ADELEON001@SOME.COM</td>
    </tr>
    <tr>
        <td>11192</td>
        <td>Andrew</td>
        <td>Dickson</td>
        <td>1</td>
        <td>ADICKSON001@SOME.COM</td>
    </tr>
</table></div></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./08_query_performance_tuning"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>